<html>
<meta charset="utf-8" />

<script>
  /*!
   * Socket.IO v4.5.0
   * (c) 2014-2022 Guillermo Rauch
   * Released under the MIT License.
   */
  !(function (t, e) {
    "object" == typeof exports && "undefined" != typeof module
      ? (module.exports = e())
      : "function" == typeof define && define.amd
        ? define(e)
        : ((t =
          "undefined" != typeof globalThis
            ? globalThis
            : t || self).io = e());
  })(this, function () {
    "use strict";
    function t(e) {
      return (
        (t =
          "function" == typeof Symbol && "symbol" == typeof Symbol.iterator
            ? function (t) {
              return typeof t;
            }
            : function (t) {
              return t &&
                "function" == typeof Symbol &&
                t.constructor === Symbol &&
                t !== Symbol.prototype
                ? "symbol"
                : typeof t;
            }),
        t(e)
      );
    }
    function e(t, e) {
      if (!(t instanceof e))
        throw new TypeError("Cannot call a class as a function");
    }
    function n(t, e) {
      for (var n = 0; n < e.length; n++) {
        var r = e[n];
        (r.enumerable = r.enumerable || !1),
          (r.configurable = !0),
          "value" in r && (r.writable = !0),
          Object.defineProperty(t, r.key, r);
      }
    }
    function r(t, e, r) {
      return e && n(t.prototype, e), r && n(t, r), t;
    }
    function i() {
      return (
        (i =
          Object.assign ||
          function (t) {
            for (var e = 1; e < arguments.length; e++) {
              var n = arguments[e];
              for (var r in n)
                Object.prototype.hasOwnProperty.call(n, r) && (t[r] = n[r]);
            }
            return t;
          }),
        i.apply(this, arguments)
      );
    }
    function o(t, e) {
      if ("function" != typeof e && null !== e)
        throw new TypeError(
          "Super expression must either be null or a function"
        );
      (t.prototype = Object.create(e && e.prototype, {
        constructor: { value: t, writable: !0, configurable: !0 },
      })),
        e && a(t, e);
    }
    function s(t) {
      return (
        (s = Object.setPrototypeOf
          ? Object.getPrototypeOf
          : function (t) {
            return t.__proto__ || Object.getPrototypeOf(t);
          }),
        s(t)
      );
    }
    function a(t, e) {
      return (
        (a =
          Object.setPrototypeOf ||
          function (t, e) {
            return (t.__proto__ = e), t;
          }),
        a(t, e)
      );
    }
    function c() {
      if ("undefined" == typeof Reflect || !Reflect.construct) return !1;
      if (Reflect.construct.sham) return !1;
      if ("function" == typeof Proxy) return !0;
      try {
        return (
          Boolean.prototype.valueOf.call(
            Reflect.construct(Boolean, [], function () { })
          ),
          !0
        );
      } catch (t) {
        return !1;
      }
    }
    function u(t, e, n) {
      return (
        (u = c()
          ? Reflect.construct
          : function (t, e, n) {
            var r = [null];
            r.push.apply(r, e);
            var i = new (Function.bind.apply(t, r))();
            return n && a(i, n.prototype), i;
          }),
        u.apply(null, arguments)
      );
    }
    function h(t) {
      var e = "function" == typeof Map ? new Map() : void 0;
      return (
        (h = function (t) {
          if (
            null === t ||
            ((n = t),
              -1 === Function.toString.call(n).indexOf("[native code]"))
          )
            return t;
          var n;
          if ("function" != typeof t)
            throw new TypeError(
              "Super expression must either be null or a function"
            );
          if (void 0 !== e) {
            if (e.has(t)) return e.get(t);
            e.set(t, r);
          }
          function r() {
            return u(t, arguments, s(this).constructor);
          }
          return (
            (r.prototype = Object.create(t.prototype, {
              constructor: {
                value: r,
                enumerable: !1,
                writable: !0,
                configurable: !0,
              },
            })),
            a(r, t)
          );
        }),
        h(t)
      );
    }
    function f(t) {
      if (void 0 === t)
        throw new ReferenceError(
          "this hasn't been initialised - super() hasn't been called"
        );
      return t;
    }
    function l(t, e) {
      if (e && ("object" == typeof e || "function" == typeof e)) return e;
      if (void 0 !== e)
        throw new TypeError(
          "Derived constructors may only return object or undefined"
        );
      return f(t);
    }
    function p(t) {
      var e = c();
      return function () {
        var n,
          r = s(t);
        if (e) {
          var i = s(this).constructor;
          n = Reflect.construct(r, arguments, i);
        } else n = r.apply(this, arguments);
        return l(this, n);
      };
    }
    function d(t, e, n) {
      return (
        (d =
          "undefined" != typeof Reflect && Reflect.get
            ? Reflect.get
            : function (t, e, n) {
              var r = (function (t, e) {
                for (
                  ;
                  !Object.prototype.hasOwnProperty.call(t, e) &&
                  null !== (t = s(t));

                );
                return t;
              })(t, e);
              if (r) {
                var i = Object.getOwnPropertyDescriptor(r, e);
                return i.get ? i.get.call(n) : i.value;
              }
            }),
        d(t, e, n || t)
      );
    }
    function y(t, e) {
      (null == e || e > t.length) && (e = t.length);
      for (var n = 0, r = new Array(e); n < e; n++) r[n] = t[n];
      return r;
    }
    function v(t, e) {
      var n =
        ("undefined" != typeof Symbol && t[Symbol.iterator]) ||
        t["@@iterator"];
      if (!n) {
        if (
          Array.isArray(t) ||
          (n = (function (t, e) {
            if (t) {
              if ("string" == typeof t) return y(t, e);
              var n = Object.prototype.toString.call(t).slice(8, -1);
              return (
                "Object" === n && t.constructor && (n = t.constructor.name),
                "Map" === n || "Set" === n
                  ? Array.from(t)
                  : "Arguments" === n ||
                    /^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n)
                    ? y(t, e)
                    : void 0
              );
            }
          })(t)) ||
          (e && t && "number" == typeof t.length)
        ) {
          n && (t = n);
          var r = 0,
            i = function () { };
          return {
            s: i,
            n: function () {
              return r >= t.length
                ? { done: !0 }
                : { done: !1, value: t[r++] };
            },
            e: function (t) {
              throw t;
            },
            f: i,
          };
        }
        throw new TypeError(
          "Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method."
        );
      }
      var o,
        s = !0,
        a = !1;
      return {
        s: function () {
          n = n.call(t);
        },
        n: function () {
          var t = n.next();
          return (s = t.done), t;
        },
        e: function (t) {
          (a = !0), (o = t);
        },
        f: function () {
          try {
            s || null == n.return || n.return();
          } finally {
            if (a) throw o;
          }
        },
      };
    }
    var g = Object.create(null);
    (g.open = "0"),
      (g.close = "1"),
      (g.ping = "2"),
      (g.pong = "3"),
      (g.message = "4"),
      (g.upgrade = "5"),
      (g.noop = "6");
    var m = Object.create(null);
    Object.keys(g).forEach(function (t) {
      m[g[t]] = t;
    });
    for (
      var k = { type: "error", data: "parser error" },
      b =
        "function" == typeof Blob ||
        ("undefined" != typeof Blob &&
          "[object BlobConstructor]" ===
          Object.prototype.toString.call(Blob)),
      w = "function" == typeof ArrayBuffer,
      _ = function (t, e, n) {
        var r,
          i = t.type,
          o = t.data;
        return b && o instanceof Blob
          ? e
            ? n(o)
            : A(o, n)
          : w &&
            (o instanceof ArrayBuffer ||
              ((r = o),
                "function" == typeof ArrayBuffer.isView
                  ? ArrayBuffer.isView(r)
                  : r && r.buffer instanceof ArrayBuffer))
            ? e
              ? n(o)
              : A(new Blob([o]), n)
            : n(g[i] + (o || ""));
      },
      A = function (t, e) {
        var n = new FileReader();
        return (
          (n.onload = function () {
            var t = n.result.split(",")[1];
            e("b" + t);
          }),
          n.readAsDataURL(t)
        );
      },
      E =
        "ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",
      O = "undefined" == typeof Uint8Array ? [] : new Uint8Array(256),
      R = 0;
      R < E.length;
      R++
    )
      O[E.charCodeAt(R)] = R;
    var T = "function" == typeof ArrayBuffer,
      C = function (t, e) {
        if ("string" != typeof t) return { type: "message", data: S(t, e) };
        var n = t.charAt(0);
        return "b" === n
          ? { type: "message", data: B(t.substring(1), e) }
          : m[n]
            ? t.length > 1
              ? { type: m[n], data: t.substring(1) }
              : { type: m[n] }
            : k;
      },
      B = function (t, e) {
        if (T) {
          var n = (function (t) {
            var e,
              n,
              r,
              i,
              o,
              s = 0.75 * t.length,
              a = t.length,
              c = 0;
            "=" === t[t.length - 1] && (s--, "=" === t[t.length - 2] && s--);
            var u = new ArrayBuffer(s),
              h = new Uint8Array(u);
            for (e = 0; e < a; e += 4)
              (n = O[t.charCodeAt(e)]),
                (r = O[t.charCodeAt(e + 1)]),
                (i = O[t.charCodeAt(e + 2)]),
                (o = O[t.charCodeAt(e + 3)]),
                (h[c++] = (n << 2) | (r >> 4)),
                (h[c++] = ((15 & r) << 4) | (i >> 2)),
                (h[c++] = ((3 & i) << 6) | (63 & o));
            return u;
          })(t);
          return S(n, e);
        }
        return { base64: !0, data: t };
      },
      S = function (t, e) {
        return "blob" === e && t instanceof ArrayBuffer ? new Blob([t]) : t;
      },
      N = String.fromCharCode(30);
    function x(t) {
      if (t)
        return (function (t) {
          for (var e in x.prototype) t[e] = x.prototype[e];
          return t;
        })(t);
    }
    (x.prototype.on = x.prototype.addEventListener = function (t, e) {
      return (
        (this._callbacks = this._callbacks || {}),
        (this._callbacks["$" + t] = this._callbacks["$" + t] || []).push(e),
        this
      );
    }),
      (x.prototype.once = function (t, e) {
        function n() {
          this.off(t, n), e.apply(this, arguments);
        }
        return (n.fn = e), this.on(t, n), this;
      }),
      (x.prototype.off = x.prototype.removeListener = x.prototype.removeAllListeners = x.prototype.removeEventListener = function (
        t,
        e
      ) {
        if (
          ((this._callbacks = this._callbacks || {}), 0 == arguments.length)
        )
          return (this._callbacks = {}), this;
        var n,
          r = this._callbacks["$" + t];
        if (!r) return this;
        if (1 == arguments.length)
          return delete this._callbacks["$" + t], this;
        for (var i = 0; i < r.length; i++)
          if ((n = r[i]) === e || n.fn === e) {
            r.splice(i, 1);
            break;
          }
        return 0 === r.length && delete this._callbacks["$" + t], this;
      }),
      (x.prototype.emit = function (t) {
        this._callbacks = this._callbacks || {};
        for (
          var e = new Array(arguments.length - 1),
          n = this._callbacks["$" + t],
          r = 1;
          r < arguments.length;
          r++
        )
          e[r - 1] = arguments[r];
        if (n) {
          r = 0;
          for (var i = (n = n.slice(0)).length; r < i; ++r)
            n[r].apply(this, e);
        }
        return this;
      }),
      (x.prototype.emitReserved = x.prototype.emit),
      (x.prototype.listeners = function (t) {
        return (
          (this._callbacks = this._callbacks || {}),
          this._callbacks["$" + t] || []
        );
      }),
      (x.prototype.hasListeners = function (t) {
        return !!this.listeners(t).length;
      });
    var L =
      "undefined" != typeof self
        ? self
        : "undefined" != typeof window
          ? window
          : Function("return this")();
    function P(t) {
      for (
        var e = arguments.length, n = new Array(e > 1 ? e - 1 : 0), r = 1;
        r < e;
        r++
      )
        n[r - 1] = arguments[r];
      return n.reduce(function (e, n) {
        return t.hasOwnProperty(n) && (e[n] = t[n]), e;
      }, {});
    }
    var j = setTimeout,
      q = clearTimeout;
    function I(t, e) {
      e.useNativeTimers
        ? ((t.setTimeoutFn = j.bind(L)), (t.clearTimeoutFn = q.bind(L)))
        : ((t.setTimeoutFn = setTimeout.bind(L)),
          (t.clearTimeoutFn = clearTimeout.bind(L)));
    }
    var D,
      F = (function (t) {
        o(r, t);
        var n = p(r);
        function r(t, i, o) {
          var s;
          return (
            e(this, r),
            ((s = n.call(this, t)).description = i),
            (s.context = o),
            (s.type = "TransportError"),
            s
          );
        }
        return r;
      })(h(Error)),
      M = (function (t) {
        o(i, t);
        var n = p(i);
        function i(t) {
          var r;
          return (
            e(this, i),
            ((r = n.call(this)).writable = !1),
            I(f(r), t),
            (r.opts = t),
            (r.query = t.query),
            (r.readyState = ""),
            (r.socket = t.socket),
            r
          );
        }
        return (
          r(i, [
            {
              key: "onError",
              value: function (t, e, n) {
                return (
                  d(s(i.prototype), "emitReserved", this).call(
                    this,
                    "error",
                    new F(t, e, n)
                  ),
                  this
                );
              },
            },
            {
              key: "open",
              value: function () {
                return (
                  ("closed" !== this.readyState && "" !== this.readyState) ||
                  ((this.readyState = "opening"), this.doOpen()),
                  this
                );
              },
            },
            {
              key: "close",
              value: function () {
                return (
                  ("opening" !== this.readyState &&
                    "open" !== this.readyState) ||
                  (this.doClose(), this.onClose()),
                  this
                );
              },
            },
            {
              key: "send",
              value: function (t) {
                "open" === this.readyState && this.write(t);
              },
            },
            {
              key: "onOpen",
              value: function () {
                (this.readyState = "open"),
                  (this.writable = !0),
                  d(s(i.prototype), "emitReserved", this).call(this, "open");
              },
            },
            {
              key: "onData",
              value: function (t) {
                var e = C(t, this.socket.binaryType);
                this.onPacket(e);
              },
            },
            {
              key: "onPacket",
              value: function (t) {
                d(s(i.prototype), "emitReserved", this).call(
                  this,
                  "packet",
                  t
                );
              },
            },
            {
              key: "onClose",
              value: function (t) {
                (this.readyState = "closed"),
                  d(s(i.prototype), "emitReserved", this).call(
                    this,
                    "close",
                    t
                  );
              },
            },
          ]),
          i
        );
      })(x),
      U = "0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz-_".split(
        ""
      ),
      V = {},
      H = 0,
      K = 0;
    function Y(t) {
      var e = "";
      do {
        (e = U[t % 64] + e), (t = Math.floor(t / 64));
      } while (t > 0);
      return e;
    }
    function z() {
      var t = Y(+new Date());
      return t !== D ? ((H = 0), (D = t)) : t + "." + Y(H++);
    }
    for (; K < 64; K++) V[U[K]] = K;
    function W(t) {
      var e = "";
      for (var n in t)
        t.hasOwnProperty(n) &&
          (e.length && (e += "&"),
            (e += encodeURIComponent(n) + "=" + encodeURIComponent(t[n])));
      return e;
    }
    function $(t) {
      for (var e = {}, n = t.split("&"), r = 0, i = n.length; r < i; r++) {
        var o = n[r].split("=");
        e[decodeURIComponent(o[0])] = decodeURIComponent(o[1]);
      }
      return e;
    }
    var J = !1;
    try {
      J =
        "undefined" != typeof XMLHttpRequest &&
        "withCredentials" in new XMLHttpRequest();
    } catch (t) { }
    var X = J;
    function G(t) {
      var e = t.xdomain;
      try {
        if ("undefined" != typeof XMLHttpRequest && (!e || X))
          return new XMLHttpRequest();
      } catch (t) { }
      if (!e)
        try {
          return new L[["Active"].concat("Object").join("X")](
            "Microsoft.XMLHTTP"
          );
        } catch (t) { }
    }
    function Q() { }
    var Z = null != new G({ xdomain: !1 }).responseType,
      tt = (function (t) {
        o(s, t);
        var n = p(s);
        function s(t) {
          var r;
          if (
            (e(this, s),
              ((r = n.call(this, t)).polling = !1),
              "undefined" != typeof location)
          ) {
            var i = "https:" === location.protocol,
              o = location.port;
            o || (o = i ? "443" : "80"),
              (r.xd =
                ("undefined" != typeof location &&
                  t.hostname !== location.hostname) ||
                o !== t.port),
              (r.xs = t.secure !== i);
          }
          var a = t && t.forceBase64;
          return (r.supportsBinary = Z && !a), r;
        }
        return (
          r(s, [
            {
              key: "name",
              get: function () {
                return "polling";
              },
            },
            {
              key: "doOpen",
              value: function () {
                this.poll();
              },
            },
            {
              key: "pause",
              value: function (t) {
                var e = this;
                this.readyState = "pausing";
                var n = function () {
                  (e.readyState = "paused"), t();
                };
                if (this.polling || !this.writable) {
                  var r = 0;
                  this.polling &&
                    (r++,
                      this.once("pollComplete", function () {
                        --r || n();
                      })),
                    this.writable ||
                    (r++,
                      this.once("drain", function () {
                        --r || n();
                      }));
                } else n();
              },
            },
            {
              key: "poll",
              value: function () {
                (this.polling = !0), this.doPoll(), this.emitReserved("poll");
              },
            },
            {
              key: "onData",
              value: function (t) {
                var e = this;
                (function (t, e) {
                  for (var n = t.split(N), r = [], i = 0; i < n.length; i++) {
                    var o = C(n[i], e);
                    if ((r.push(o), "error" === o.type)) break;
                  }
                  return r;
                })(t, this.socket.binaryType).forEach(function (t) {
                  if (
                    ("opening" === e.readyState &&
                      "open" === t.type &&
                      e.onOpen(),
                      "close" === t.type)
                  )
                    return (
                      e.onClose({
                        description: "transport closed by the server",
                      }),
                      !1
                    );
                  e.onPacket(t);
                }),
                  "closed" !== this.readyState &&
                  ((this.polling = !1),
                    this.emitReserved("pollComplete"),
                    "open" === this.readyState && this.poll());
              },
            },
            {
              key: "doClose",
              value: function () {
                var t = this,
                  e = function () {
                    t.write([{ type: "close" }]);
                  };
                "open" === this.readyState ? e() : this.once("open", e);
              },
            },
            {
              key: "write",
              value: function (t) {
                var e = this;
                (this.writable = !1),
                  (function (t, e) {
                    var n = t.length,
                      r = new Array(n),
                      i = 0;
                    t.forEach(function (t, o) {
                      _(t, !1, function (t) {
                        (r[o] = t), ++i === n && e(r.join(N));
                      });
                    });
                  })(t, function (t) {
                    e.doWrite(t, function () {
                      (e.writable = !0), e.emitReserved("drain");
                    });
                  });
              },
            },
            {
              key: "uri",
              value: function () {
                var t = this.query || {},
                  e = this.opts.secure ? "https" : "http",
                  n = "";
                !1 !== this.opts.timestampRequests &&
                  (t[this.opts.timestampParam] = z()),
                  this.supportsBinary || t.sid || (t.b64 = 1),
                  this.opts.port &&
                  (("https" === e && 443 !== Number(this.opts.port)) ||
                    ("http" === e && 80 !== Number(this.opts.port))) &&
                  (n = ":" + this.opts.port);
                var r = W(t);
                return (
                  e +
                  "://" +
                  (-1 !== this.opts.hostname.indexOf(":")
                    ? "[" + this.opts.hostname + "]"
                    : this.opts.hostname) +
                  n +
                  this.opts.path +
                  (r.length ? "?" + r : "")
                );
              },
            },
            {
              key: "request",
              value: function () {
                var t =
                  arguments.length > 0 && void 0 !== arguments[0]
                    ? arguments[0]
                    : {};
                return (
                  i(t, { xd: this.xd, xs: this.xs }, this.opts),
                  new et(this.uri(), t)
                );
              },
            },
            {
              key: "doWrite",
              value: function (t, e) {
                var n = this,
                  r = this.request({ method: "POST", data: t });
                r.on("success", e),
                  r.on("error", function (t, e) {
                    n.onError("xhr post error", t, e);
                  });
              },
            },
            {
              key: "doPoll",
              value: function () {
                var t = this,
                  e = this.request();
                e.on("data", this.onData.bind(this)),
                  e.on("error", function (e, n) {
                    t.onError("xhr poll error", e, n);
                  }),
                  (this.pollXhr = e);
              },
            },
          ]),
          s
        );
      })(M),
      et = (function (t) {
        o(i, t);
        var n = p(i);
        function i(t, r) {
          var o;
          return (
            e(this, i),
            I(f((o = n.call(this))), r),
            (o.opts = r),
            (o.method = r.method || "GET"),
            (o.uri = t),
            (o.async = !1 !== r.async),
            (o.data = void 0 !== r.data ? r.data : null),
            o.create(),
            o
          );
        }
        return (
          r(i, [
            {
              key: "create",
              value: function () {
                var t = this,
                  e = P(
                    this.opts,
                    "agent",
                    "pfx",
                    "key",
                    "passphrase",
                    "cert",
                    "ca",
                    "ciphers",
                    "rejectUnauthorized",
                    "autoUnref"
                  );
                (e.xdomain = !!this.opts.xd), (e.xscheme = !!this.opts.xs);
                var n = (this.xhr = new G(e));
                try {
                  n.open(this.method, this.uri, this.async);
                  try {
                    if (this.opts.extraHeaders)
                      for (var r in (n.setDisableHeaderCheck &&
                        n.setDisableHeaderCheck(!0),
                        this.opts.extraHeaders))
                        this.opts.extraHeaders.hasOwnProperty(r) &&
                          n.setRequestHeader(r, this.opts.extraHeaders[r]);
                  } catch (t) { }
                  if ("POST" === this.method)
                    try {
                      n.setRequestHeader(
                        "Content-type",
                        "text/plain;charset=UTF-8"
                      );
                    } catch (t) { }
                  try {
                    n.setRequestHeader("Accept", "*/*");
                  } catch (t) { }
                  "withCredentials" in n &&
                    (n.withCredentials = this.opts.withCredentials),
                    this.opts.requestTimeout &&
                    (n.timeout = this.opts.requestTimeout),
                    (n.onreadystatechange = function () {
                      4 === n.readyState &&
                        (200 === n.status || 1223 === n.status
                          ? t.onLoad()
                          : t.setTimeoutFn(function () {
                            t.onError(
                              "number" == typeof n.status ? n.status : 0
                            );
                          }, 0));
                    }),
                    n.send(this.data);
                } catch (e) {
                  return void this.setTimeoutFn(function () {
                    t.onError(e);
                  }, 0);
                }
                "undefined" != typeof document &&
                  ((this.index = i.requestsCount++),
                    (i.requests[this.index] = this));
              },
            },
            {
              key: "onError",
              value: function (t) {
                this.emitReserved("error", t, this.xhr), this.cleanup(!0);
              },
            },
            {
              key: "cleanup",
              value: function (t) {
                if (void 0 !== this.xhr && null !== this.xhr) {
                  if (((this.xhr.onreadystatechange = Q), t))
                    try {
                      this.xhr.abort();
                    } catch (t) { }
                  "undefined" != typeof document &&
                    delete i.requests[this.index],
                    (this.xhr = null);
                }
              },
            },
            {
              key: "onLoad",
              value: function () {
                var t = this.xhr.responseText;
                null !== t &&
                  (this.emitReserved("data", t),
                    this.emitReserved("success"),
                    this.cleanup());
              },
            },
            {
              key: "abort",
              value: function () {
                this.cleanup();
              },
            },
          ]),
          i
        );
      })(x);
    if (
      ((et.requestsCount = 0),
        (et.requests = {}),
        "undefined" != typeof document)
    )
      if ("function" == typeof attachEvent) attachEvent("onunload", nt);
      else if ("function" == typeof addEventListener) {
        addEventListener("onpagehide" in L ? "pagehide" : "unload", nt, !1);
      }
    function nt() {
      for (var t in et.requests)
        et.requests.hasOwnProperty(t) && et.requests[t].abort();
    }
    var rt =
      "function" == typeof Promise && "function" == typeof Promise.resolve
        ? function (t) {
          return Promise.resolve().then(t);
        }
        : function (t, e) {
          return e(t, 0);
        },
      it = L.WebSocket || L.MozWebSocket,
      ot =
        "undefined" != typeof navigator &&
        "string" == typeof navigator.product &&
        "reactnative" === navigator.product.toLowerCase(),
      st = (function (t) {
        o(i, t);
        var n = p(i);
        function i(t) {
          var r;
          return (
            e(this, i),
            ((r = n.call(this, t)).supportsBinary = !t.forceBase64),
            r
          );
        }
        return (
          r(i, [
            {
              key: "name",
              get: function () {
                return "websocket";
              },
            },
            {
              key: "doOpen",
              value: function () {
                if (this.check()) {
                  var t = this.uri(),
                    e = this.opts.protocols,
                    n = ot
                      ? {}
                      : P(
                        this.opts,
                        "agent",
                        "perMessageDeflate",
                        "pfx",
                        "key",
                        "passphrase",
                        "cert",
                        "ca",
                        "ciphers",
                        "rejectUnauthorized",
                        "localAddress",
                        "protocolVersion",
                        "origin",
                        "maxPayload",
                        "family",
                        "checkServerIdentity"
                      );
                  this.opts.extraHeaders &&
                    (n.headers = this.opts.extraHeaders);
                  try {
                    this.ws = ot
                      ? new it(t, e, n)
                      : e
                        ? new it(t, e)
                        : new it(t);
                  } catch (t) {
                    return this.emitReserved("error", t);
                  }
                  (this.ws.binaryType =
                    this.socket.binaryType || "arraybuffer"),
                    this.addEventListeners();
                }
              },
            },
            {
              key: "addEventListeners",
              value: function () {
                var t = this;
                (this.ws.onopen = function () {
                  t.opts.autoUnref && t.ws._socket.unref(), t.onOpen();
                }),
                  (this.ws.onclose = function (e) {
                    return t.onClose({
                      description: "websocket connection closed",
                      context: e,
                    });
                  }),
                  (this.ws.onmessage = function (e) {
                    return t.onData(e.data);
                  }),
                  (this.ws.onerror = function (e) {
                    return t.onError("websocket error", e);
                  });
              },
            },
            {
              key: "write",
              value: function (t) {
                var e = this;
                this.writable = !1;
                for (
                  var n = function (n) {
                    var r = t[n],
                      i = n === t.length - 1;
                    _(r, e.supportsBinary, function (t) {
                      try {
                        e.ws.send(t);
                      } catch (t) { }
                      i &&
                        rt(function () {
                          (e.writable = !0), e.emitReserved("drain");
                        }, e.setTimeoutFn);
                    });
                  },
                  r = 0;
                  r < t.length;
                  r++
                )
                  n(r);
              },
            },
            {
              key: "doClose",
              value: function () {
                void 0 !== this.ws && (this.ws.close(), (this.ws = null));
              },
            },
            {
              key: "uri",
              value: function () {
                var t = this.query || {},
                  e = this.opts.secure ? "wss" : "ws",
                  n = "";
                this.opts.port &&
                  (("wss" === e && 443 !== Number(this.opts.port)) ||
                    ("ws" === e && 80 !== Number(this.opts.port))) &&
                  (n = ":" + this.opts.port),
                  this.opts.timestampRequests &&
                  (t[this.opts.timestampParam] = z()),
                  this.supportsBinary || (t.b64 = 1);
                var r = W(t);
                return (
                  e +
                  "://" +
                  (-1 !== this.opts.hostname.indexOf(":")
                    ? "[" + this.opts.hostname + "]"
                    : this.opts.hostname) +
                  n +
                  this.opts.path +
                  (r.length ? "?" + r : "")
                );
              },
            },
            {
              key: "check",
              value: function () {
                return !(
                  !it ||
                  ("__initialize" in it && this.name === i.prototype.name)
                );
              },
            },
          ]),
          i
        );
      })(M),
      at = { websocket: st, polling: tt },
      ct = /^(?:(?![^:@]+:[^:@\/]*@)(http|https|ws|wss):\/\/)?((?:(([^:@]*)(?::([^:@]*))?)?@)?((?:[a-f0-9]{0,4}:){2,7}[a-f0-9]{0,4}|[^:\/?#]*)(?::(\d*))?)(((\/(?:[^?#](?![^?#\/]*\.[^?#\/.]+(?:[?#]|$)))*\/?)?([^?#\/]*))(?:\?([^#]*))?(?:#(.*))?)/,
      ut = [
        "source",
        "protocol",
        "authority",
        "userInfo",
        "user",
        "password",
        "host",
        "port",
        "relative",
        "path",
        "directory",
        "file",
        "query",
        "anchor",
      ];
    function ht(t) {
      var e = t,
        n = t.indexOf("["),
        r = t.indexOf("]");
      -1 != n &&
        -1 != r &&
        (t =
          t.substring(0, n) +
          t.substring(n, r).replace(/:/g, ";") +
          t.substring(r, t.length));
      for (var i, o, s = ct.exec(t || ""), a = {}, c = 14; c--;)
        a[ut[c]] = s[c] || "";
      return (
        -1 != n &&
        -1 != r &&
        ((a.source = e),
          (a.host = a.host
            .substring(1, a.host.length - 1)
            .replace(/;/g, ":")),
          (a.authority = a.authority
            .replace("[", "")
            .replace("]", "")
            .replace(/;/g, ":")),
          (a.ipv6uri = !0)),
        (a.pathNames = (function (t, e) {
          var n = /\/{2,9}/g,
            r = e.replace(n, "/").split("/");
          ("/" != e.substr(0, 1) && 0 !== e.length) || r.splice(0, 1);
          "/" == e.substr(e.length - 1, 1) && r.splice(r.length - 1, 1);
          return r;
        })(0, a.path)),
        (a.queryKey =
          ((i = a.query),
            (o = {}),
            i.replace(/(?:^|&)([^&=]*)=?([^&]*)/g, function (t, e, n) {
              e && (o[e] = n);
            }),
            o)),
        a
      );
    }
    var ft = (function (n) {
      o(a, n);
      var s = p(a);
      function a(n) {
        var r,
          o =
            arguments.length > 1 && void 0 !== arguments[1]
              ? arguments[1]
              : {};
        return (
          e(this, a),
          (r = s.call(this)),
          n && "object" === t(n) && ((o = n), (n = null)),
          n
            ? ((n = ht(n)),
              (o.hostname = n.host),
              (o.secure = "https" === n.protocol || "wss" === n.protocol),
              (o.port = n.port),
              n.query && (o.query = n.query))
            : o.host && (o.hostname = ht(o.host).host),
          I(f(r), o),
          (r.secure =
            null != o.secure
              ? o.secure
              : "undefined" != typeof location &&
              "https:" === location.protocol),
          o.hostname && !o.port && (o.port = r.secure ? "443" : "80"),
          (r.hostname =
            o.hostname ||
            ("undefined" != typeof location
              ? location.hostname
              : "localhost")),
          (r.port =
            o.port ||
            ("undefined" != typeof location && location.port
              ? location.port
              : r.secure
                ? "443"
                : "80")),
          (r.transports = o.transports || ["polling", "websocket"]),
          (r.readyState = ""),
          (r.writeBuffer = []),
          (r.prevBufferLen = 0),
          (r.opts = i(
            {
              path: "/engine.io",
              agent: !1,
              withCredentials: !1,
              upgrade: !0,
              timestampParam: "t",
              rememberUpgrade: !1,
              rejectUnauthorized: !0,
              perMessageDeflate: { threshold: 1024 },
              transportOptions: {},
              closeOnBeforeunload: !0,
            },
            o
          )),
          (r.opts.path = r.opts.path.replace(/\/$/, "") + "/"),
          "string" == typeof r.opts.query && (r.opts.query = $(r.opts.query)),
          (r.id = null),
          (r.upgrades = null),
          (r.pingInterval = null),
          (r.pingTimeout = null),
          (r.pingTimeoutTimer = null),
          "function" == typeof addEventListener &&
          (r.opts.closeOnBeforeunload &&
            addEventListener(
              "beforeunload",
              function () {
                r.transport &&
                  (r.transport.removeAllListeners(), r.transport.close());
              },
              !1
            ),
            "localhost" !== r.hostname &&
            ((r.offlineEventListener = function () {
              r.onClose("transport close", {
                description: "network connection lost",
              });
            }),
              addEventListener("offline", r.offlineEventListener, !1))),
          r.open(),
          r
        );
      }
      return (
        r(a, [
          {
            key: "createTransport",
            value: function (t) {
              var e = i({}, this.opts.query);
              (e.EIO = 4), (e.transport = t), this.id && (e.sid = this.id);
              var n = i({}, this.opts.transportOptions[t], this.opts, {
                query: e,
                socket: this,
                hostname: this.hostname,
                secure: this.secure,
                port: this.port,
              });
              return new at[t](n);
            },
          },
          {
            key: "open",
            value: function () {
              var t,
                e = this;
              if (
                this.opts.rememberUpgrade &&
                a.priorWebsocketSuccess &&
                -1 !== this.transports.indexOf("websocket")
              )
                t = "websocket";
              else {
                if (0 === this.transports.length)
                  return void this.setTimeoutFn(function () {
                    e.emitReserved("error", "No transports available");
                  }, 0);
                t = this.transports[0];
              }
              this.readyState = "opening";
              try {
                t = this.createTransport(t);
              } catch (t) {
                return this.transports.shift(), void this.open();
              }
              t.open(), this.setTransport(t);
            },
          },
          {
            key: "setTransport",
            value: function (t) {
              var e = this;
              this.transport && this.transport.removeAllListeners(),
                (this.transport = t),
                t
                  .on("drain", this.onDrain.bind(this))
                  .on("packet", this.onPacket.bind(this))
                  .on("error", this.onError.bind(this))
                  .on("close", function (t) {
                    return e.onClose("transport close", t);
                  });
            },
          },
          {
            key: "probe",
            value: function (t) {
              var e = this,
                n = this.createTransport(t),
                r = !1;
              a.priorWebsocketSuccess = !1;
              var i = function () {
                r ||
                  (n.send([{ type: "ping", data: "probe" }]),
                    n.once("packet", function (t) {
                      if (!r)
                        if ("pong" === t.type && "probe" === t.data) {
                          if (
                            ((e.upgrading = !0),
                              e.emitReserved("upgrading", n),
                              !n)
                          )
                            return;
                          (a.priorWebsocketSuccess = "websocket" === n.name),
                            e.transport.pause(function () {
                              r ||
                                ("closed" !== e.readyState &&
                                  (f(),
                                    e.setTransport(n),
                                    n.send([{ type: "upgrade" }]),
                                    e.emitReserved("upgrade", n),
                                    (n = null),
                                    (e.upgrading = !1),
                                    e.flush()));
                            });
                        } else {
                          var i = new Error("probe error");
                          (i.transport = n.name),
                            e.emitReserved("upgradeError", i);
                        }
                    }));
              };
              function o() {
                r || ((r = !0), f(), n.close(), (n = null));
              }
              var s = function (t) {
                var r = new Error("probe error: " + t);
                (r.transport = n.name),
                  o(),
                  e.emitReserved("upgradeError", r);
              };
              function c() {
                s("transport closed");
              }
              function u() {
                s("socket closed");
              }
              function h(t) {
                n && t.name !== n.name && o();
              }
              var f = function () {
                n.removeListener("open", i),
                  n.removeListener("error", s),
                  n.removeListener("close", c),
                  e.off("close", u),
                  e.off("upgrading", h);
              };
              n.once("open", i),
                n.once("error", s),
                n.once("close", c),
                this.once("close", u),
                this.once("upgrading", h),
                n.open();
            },
          },
          {
            key: "onOpen",
            value: function () {
              if (
                ((this.readyState = "open"),
                  (a.priorWebsocketSuccess =
                    "websocket" === this.transport.name),
                  this.emitReserved("open"),
                  this.flush(),
                  "open" === this.readyState &&
                  this.opts.upgrade &&
                  this.transport.pause)
              )
                for (var t = 0, e = this.upgrades.length; t < e; t++)
                  this.probe(this.upgrades[t]);
            },
          },
          {
            key: "onPacket",
            value: function (t) {
              if (
                "opening" === this.readyState ||
                "open" === this.readyState ||
                "closing" === this.readyState
              )
                switch (
                (this.emitReserved("packet", t),
                  this.emitReserved("heartbeat"),
                  t.type)
                ) {
                  case "open":
                    this.onHandshake(JSON.parse(t.data));
                    break;
                  case "ping":
                    this.resetPingTimeout(),
                      this.sendPacket("pong"),
                      this.emitReserved("ping"),
                      this.emitReserved("pong");
                    break;
                  case "error":
                    var e = new Error("server error");
                    (e.code = t.data), this.onError(e);
                    break;
                  case "message":
                    this.emitReserved("data", t.data),
                      this.emitReserved("message", t.data);
                }
            },
          },
          {
            key: "onHandshake",
            value: function (t) {
              this.emitReserved("handshake", t),
                (this.id = t.sid),
                (this.transport.query.sid = t.sid),
                (this.upgrades = this.filterUpgrades(t.upgrades)),
                (this.pingInterval = t.pingInterval),
                (this.pingTimeout = t.pingTimeout),
                (this.maxPayload = t.maxPayload),
                this.onOpen(),
                "closed" !== this.readyState && this.resetPingTimeout();
            },
          },
          {
            key: "resetPingTimeout",
            value: function () {
              var t = this;
              this.clearTimeoutFn(this.pingTimeoutTimer),
                (this.pingTimeoutTimer = this.setTimeoutFn(function () {
                  t.onClose("ping timeout");
                }, this.pingInterval + this.pingTimeout)),
                this.opts.autoUnref && this.pingTimeoutTimer.unref();
            },
          },
          {
            key: "onDrain",
            value: function () {
              this.writeBuffer.splice(0, this.prevBufferLen),
                (this.prevBufferLen = 0),
                0 === this.writeBuffer.length
                  ? this.emitReserved("drain")
                  : this.flush();
            },
          },
          {
            key: "flush",
            value: function () {
              if (
                "closed" !== this.readyState &&
                this.transport.writable &&
                !this.upgrading &&
                this.writeBuffer.length
              ) {
                var t = this.getWritablePackets();
                this.transport.send(t),
                  (this.prevBufferLen = t.length),
                  this.emitReserved("flush");
              }
            },
          },
          {
            key: "getWritablePackets",
            value: function () {
              if (
                !(
                  this.maxPayload &&
                  "polling" === this.transport.name &&
                  this.writeBuffer.length > 1
                )
              )
                return this.writeBuffer;
              for (var t, e = 1, n = 0; n < this.writeBuffer.length; n++) {
                var r = this.writeBuffer[n].data;
                if (
                  (r &&
                    (e +=
                      "string" == typeof (t = r)
                        ? (function (t) {
                          for (
                            var e = 0, n = 0, r = 0, i = t.length;
                            r < i;
                            r++
                          )
                            (e = t.charCodeAt(r)) < 128
                              ? (n += 1)
                              : e < 2048
                                ? (n += 2)
                                : e < 55296 || e >= 57344
                                  ? (n += 3)
                                  : (r++, (n += 4));
                          return n;
                        })(t)
                        : Math.ceil(1.33 * (t.byteLength || t.size))),
                    n > 0 && e > this.maxPayload)
                )
                  return this.writeBuffer.slice(0, n);
                e += 2;
              }
              return this.writeBuffer;
            },
          },
          {
            key: "write",
            value: function (t, e, n) {
              return this.sendPacket("message", t, e, n), this;
            },
          },
          {
            key: "send",
            value: function (t, e, n) {
              return this.sendPacket("message", t, e, n), this;
            },
          },
          {
            key: "sendPacket",
            value: function (t, e, n, r) {
              if (
                ("function" == typeof e && ((r = e), (e = void 0)),
                  "function" == typeof n && ((r = n), (n = null)),
                  "closing" !== this.readyState && "closed" !== this.readyState)
              ) {
                (n = n || {}).compress = !1 !== n.compress;
                var i = { type: t, data: e, options: n };
                this.emitReserved("packetCreate", i),
                  this.writeBuffer.push(i),
                  r && this.once("flush", r),
                  this.flush();
              }
            },
          },
          {
            key: "close",
            value: function () {
              var t = this,
                e = function () {
                  t.onClose("forced close"), t.transport.close();
                },
                n = function n() {
                  t.off("upgrade", n), t.off("upgradeError", n), e();
                },
                r = function () {
                  t.once("upgrade", n), t.once("upgradeError", n);
                };
              return (
                ("opening" !== this.readyState &&
                  "open" !== this.readyState) ||
                ((this.readyState = "closing"),
                  this.writeBuffer.length
                    ? this.once("drain", function () {
                      t.upgrading ? r() : e();
                    })
                    : this.upgrading
                      ? r()
                      : e()),
                this
              );
            },
          },
          {
            key: "onError",
            value: function (t) {
              (a.priorWebsocketSuccess = !1),
                this.emitReserved("error", t),
                this.onClose("transport error", t);
            },
          },
          {
            key: "onClose",
            value: function (t, e) {
              ("opening" !== this.readyState &&
                "open" !== this.readyState &&
                "closing" !== this.readyState) ||
                (this.clearTimeoutFn(this.pingTimeoutTimer),
                  this.transport.removeAllListeners("close"),
                  this.transport.close(),
                  this.transport.removeAllListeners(),
                  "function" == typeof removeEventListener &&
                  removeEventListener(
                    "offline",
                    this.offlineEventListener,
                    !1
                  ),
                  (this.readyState = "closed"),
                  (this.id = null),
                  this.emitReserved("close", t, e),
                  (this.writeBuffer = []),
                  (this.prevBufferLen = 0));
            },
          },
          {
            key: "filterUpgrades",
            value: function (t) {
              for (var e = [], n = 0, r = t.length; n < r; n++)
                ~this.transports.indexOf(t[n]) && e.push(t[n]);
              return e;
            },
          },
        ]),
        a
      );
    })(x);
    ft.protocol = 4;
    var lt = "function" == typeof ArrayBuffer,
      pt = Object.prototype.toString,
      dt =
        "function" == typeof Blob ||
        ("undefined" != typeof Blob &&
          "[object BlobConstructor]" === pt.call(Blob)),
      yt =
        "function" == typeof File ||
        ("undefined" != typeof File &&
          "[object FileConstructor]" === pt.call(File));
    function vt(t) {
      return (
        (lt &&
          (t instanceof ArrayBuffer ||
            (function (t) {
              return "function" == typeof ArrayBuffer.isView
                ? ArrayBuffer.isView(t)
                : t.buffer instanceof ArrayBuffer;
            })(t))) ||
        (dt && t instanceof Blob) ||
        (yt && t instanceof File)
      );
    }
    function gt(e, n) {
      if (!e || "object" !== t(e)) return !1;
      if (Array.isArray(e)) {
        for (var r = 0, i = e.length; r < i; r++) if (gt(e[r])) return !0;
        return !1;
      }
      if (vt(e)) return !0;
      if (e.toJSON && "function" == typeof e.toJSON && 1 === arguments.length)
        return gt(e.toJSON(), !0);
      for (var o in e)
        if (Object.prototype.hasOwnProperty.call(e, o) && gt(e[o])) return !0;
      return !1;
    }
    function mt(t) {
      var e = [],
        n = t.data,
        r = t;
      return (
        (r.data = kt(n, e)),
        (r.attachments = e.length),
        { packet: r, buffers: e }
      );
    }
    function kt(e, n) {
      if (!e) return e;
      if (vt(e)) {
        var r = { _placeholder: !0, num: n.length };
        return n.push(e), r;
      }
      if (Array.isArray(e)) {
        for (var i = new Array(e.length), o = 0; o < e.length; o++)
          i[o] = kt(e[o], n);
        return i;
      }
      if ("object" === t(e) && !(e instanceof Date)) {
        var s = {};
        for (var a in e)
          Object.prototype.hasOwnProperty.call(e, a) && (s[a] = kt(e[a], n));
        return s;
      }
      return e;
    }
    function bt(t, e) {
      return (t.data = wt(t.data, e)), (t.attachments = void 0), t;
    }
    function wt(e, n) {
      if (!e) return e;
      if (e && e._placeholder) return n[e.num];
      if (Array.isArray(e))
        for (var r = 0; r < e.length; r++) e[r] = wt(e[r], n);
      else if ("object" === t(e))
        for (var i in e)
          Object.prototype.hasOwnProperty.call(e, i) && (e[i] = wt(e[i], n));
      return e;
    }
    var _t;
    !(function (t) {
      (t[(t.CONNECT = 0)] = "CONNECT"),
        (t[(t.DISCONNECT = 1)] = "DISCONNECT"),
        (t[(t.EVENT = 2)] = "EVENT"),
        (t[(t.ACK = 3)] = "ACK"),
        (t[(t.CONNECT_ERROR = 4)] = "CONNECT_ERROR"),
        (t[(t.BINARY_EVENT = 5)] = "BINARY_EVENT"),
        (t[(t.BINARY_ACK = 6)] = "BINARY_ACK");
    })(_t || (_t = {}));
    var At = (function () {
      function t(n) {
        e(this, t), (this.replacer = n);
      }
      return (
        r(t, [
          {
            key: "encode",
            value: function (t) {
              return (t.type !== _t.EVENT && t.type !== _t.ACK) || !gt(t)
                ? [this.encodeAsString(t)]
                : ((t.type =
                  t.type === _t.EVENT ? _t.BINARY_EVENT : _t.BINARY_ACK),
                  this.encodeAsBinary(t));
            },
          },
          {
            key: "encodeAsString",
            value: function (t) {
              var e = "" + t.type;
              return (
                (t.type !== _t.BINARY_EVENT && t.type !== _t.BINARY_ACK) ||
                (e += t.attachments + "-"),
                t.nsp && "/" !== t.nsp && (e += t.nsp + ","),
                null != t.id && (e += t.id),
                null != t.data &&
                (e += JSON.stringify(t.data, this.replacer)),
                e
              );
            },
          },
          {
            key: "encodeAsBinary",
            value: function (t) {
              var e = mt(t),
                n = this.encodeAsString(e.packet),
                r = e.buffers;
              return r.unshift(n), r;
            },
          },
        ]),
        t
      );
    })(),
      Et = (function (n) {
        o(a, n);
        var i = p(a);
        function a(t) {
          var n;
          return e(this, a), ((n = i.call(this)).reviver = t), n;
        }
        return (
          r(
            a,
            [
              {
                key: "add",
                value: function (t) {
                  var e;
                  if ("string" == typeof t)
                    (e = this.decodeString(t)).type === _t.BINARY_EVENT ||
                      e.type === _t.BINARY_ACK
                      ? ((this.reconstructor = new Ot(e)),
                        0 === e.attachments &&
                        d(s(a.prototype), "emitReserved", this).call(
                          this,
                          "decoded",
                          e
                        ))
                      : d(s(a.prototype), "emitReserved", this).call(
                        this,
                        "decoded",
                        e
                      );
                  else {
                    if (!vt(t) && !t.base64)
                      throw new Error("Unknown type: " + t);
                    if (!this.reconstructor)
                      throw new Error(
                        "got binary data when not reconstructing a packet"
                      );
                    (e = this.reconstructor.takeBinaryData(t)) &&
                      ((this.reconstructor = null),
                        d(s(a.prototype), "emitReserved", this).call(
                          this,
                          "decoded",
                          e
                        ));
                  }
                },
              },
              {
                key: "decodeString",
                value: function (t) {
                  var e = 0,
                    n = { type: Number(t.charAt(0)) };
                  if (void 0 === _t[n.type])
                    throw new Error("unknown packet type " + n.type);
                  if (
                    n.type === _t.BINARY_EVENT ||
                    n.type === _t.BINARY_ACK
                  ) {
                    for (
                      var r = e + 1;
                      "-" !== t.charAt(++e) && e != t.length;

                    );
                    var i = t.substring(r, e);
                    if (i != Number(i) || "-" !== t.charAt(e))
                      throw new Error("Illegal attachments");
                    n.attachments = Number(i);
                  }
                  if ("/" === t.charAt(e + 1)) {
                    for (var o = e + 1; ++e;) {
                      if ("," === t.charAt(e)) break;
                      if (e === t.length) break;
                    }
                    n.nsp = t.substring(o, e);
                  } else n.nsp = "/";
                  var s = t.charAt(e + 1);
                  if ("" !== s && Number(s) == s) {
                    for (var c = e + 1; ++e;) {
                      var u = t.charAt(e);
                      if (null == u || Number(u) != u) {
                        --e;
                        break;
                      }
                      if (e === t.length) break;
                    }
                    n.id = Number(t.substring(c, e + 1));
                  }
                  if (t.charAt(++e)) {
                    var h = this.tryParse(t.substr(e));
                    if (!a.isPayloadValid(n.type, h))
                      throw new Error("invalid payload");
                    n.data = h;
                  }
                  return n;
                },
              },
              {
                key: "tryParse",
                value: function (t) {
                  try {
                    return JSON.parse(t, this.reviver);
                  } catch (t) {
                    return !1;
                  }
                },
              },
              {
                key: "destroy",
                value: function () {
                  this.reconstructor &&
                    this.reconstructor.finishedReconstruction();
                },
              },
            ],
            [
              {
                key: "isPayloadValid",
                value: function (e, n) {
                  switch (e) {
                    case _t.CONNECT:
                      return "object" === t(n);
                    case _t.DISCONNECT:
                      return void 0 === n;
                    case _t.CONNECT_ERROR:
                      return "string" == typeof n || "object" === t(n);
                    case _t.EVENT:
                    case _t.BINARY_EVENT:
                      return Array.isArray(n) && n.length > 0;
                    case _t.ACK:
                    case _t.BINARY_ACK:
                      return Array.isArray(n);
                  }
                },
              },
            ]
          ),
          a
        );
      })(x),
      Ot = (function () {
        function t(n) {
          e(this, t),
            (this.packet = n),
            (this.buffers = []),
            (this.reconPack = n);
        }
        return (
          r(t, [
            {
              key: "takeBinaryData",
              value: function (t) {
                if (
                  (this.buffers.push(t),
                    this.buffers.length === this.reconPack.attachments)
                ) {
                  var e = bt(this.reconPack, this.buffers);
                  return this.finishedReconstruction(), e;
                }
                return null;
              },
            },
            {
              key: "finishedReconstruction",
              value: function () {
                (this.reconPack = null), (this.buffers = []);
              },
            },
          ]),
          t
        );
      })(),
      Rt = Object.freeze({
        __proto__: null,
        protocol: 5,
        get PacketType() {
          return _t;
        },
        Encoder: At,
        Decoder: Et,
      });
    function Tt(t, e, n) {
      return (
        t.on(e, n),
        function () {
          t.off(e, n);
        }
      );
    }
    var Ct = Object.freeze({
      connect: 1,
      connect_error: 1,
      disconnect: 1,
      disconnecting: 1,
      newListener: 1,
      removeListener: 1,
    }),
      Bt = (function (t) {
        o(i, t);
        var n = p(i);
        function i(t, r, o) {
          var s;
          return (
            e(this, i),
            ((s = n.call(this)).connected = !1),
            (s.receiveBuffer = []),
            (s.sendBuffer = []),
            (s.ids = 0),
            (s.acks = {}),
            (s.flags = {}),
            (s.io = t),
            (s.nsp = r),
            o && o.auth && (s.auth = o.auth),
            s.io._autoConnect && s.open(),
            s
          );
        }
        return (
          r(i, [
            {
              key: "disconnected",
              get: function () {
                return !this.connected;
              },
            },
            {
              key: "subEvents",
              value: function () {
                if (!this.subs) {
                  var t = this.io;
                  this.subs = [
                    Tt(t, "open", this.onopen.bind(this)),
                    Tt(t, "packet", this.onpacket.bind(this)),
                    Tt(t, "error", this.onerror.bind(this)),
                    Tt(t, "close", this.onclose.bind(this)),
                  ];
                }
              },
            },
            {
              key: "active",
              get: function () {
                return !!this.subs;
              },
            },
            {
              key: "connect",
              value: function () {
                return (
                  this.connected ||
                  (this.subEvents(),
                    this.io._reconnecting || this.io.open(),
                    "open" === this.io._readyState && this.onopen()),
                  this
                );
              },
            },
            {
              key: "open",
              value: function () {
                return this.connect();
              },
            },
            {
              key: "send",
              value: function () {
                for (
                  var t = arguments.length, e = new Array(t), n = 0;
                  n < t;
                  n++
                )
                  e[n] = arguments[n];
                return e.unshift("message"), this.emit.apply(this, e), this;
              },
            },
            {
              key: "emit",
              value: function (t) {
                if (Ct.hasOwnProperty(t))
                  throw new Error('"' + t + '" is a reserved event name');
                for (
                  var e = arguments.length,
                  n = new Array(e > 1 ? e - 1 : 0),
                  r = 1;
                  r < e;
                  r++
                )
                  n[r - 1] = arguments[r];
                n.unshift(t);
                var i = { type: _t.EVENT, data: n, options: {} };
                if (
                  ((i.options.compress = !1 !== this.flags.compress),
                    "function" == typeof n[n.length - 1])
                ) {
                  var o = this.ids++,
                    s = n.pop();
                  this._registerAckCallback(o, s), (i.id = o);
                }
                var a =
                  this.io.engine &&
                  this.io.engine.transport &&
                  this.io.engine.transport.writable,
                  c = this.flags.volatile && (!a || !this.connected);
                return (
                  c ||
                  (this.connected
                    ? (this.notifyOutgoingListeners(i), this.packet(i))
                    : this.sendBuffer.push(i)),
                  (this.flags = {}),
                  this
                );
              },
            },
            {
              key: "_registerAckCallback",
              value: function (t, e) {
                var n = this,
                  r = this.flags.timeout;
                if (void 0 !== r) {
                  var i = this.io.setTimeoutFn(function () {
                    delete n.acks[t];
                    for (var r = 0; r < n.sendBuffer.length; r++)
                      n.sendBuffer[r].id === t && n.sendBuffer.splice(r, 1);
                    e.call(n, new Error("operation has timed out"));
                  }, r);
                  this.acks[t] = function () {
                    n.io.clearTimeoutFn(i);
                    for (
                      var t = arguments.length, r = new Array(t), o = 0;
                      o < t;
                      o++
                    )
                      r[o] = arguments[o];
                    e.apply(n, [null].concat(r));
                  };
                } else this.acks[t] = e;
              },
            },
            {
              key: "packet",
              value: function (t) {
                (t.nsp = this.nsp), this.io._packet(t);
              },
            },
            {
              key: "onopen",
              value: function () {
                var t = this;
                "function" == typeof this.auth
                  ? this.auth(function (e) {
                    t.packet({ type: _t.CONNECT, data: e });
                  })
                  : this.packet({ type: _t.CONNECT, data: this.auth });
              },
            },
            {
              key: "onerror",
              value: function (t) {
                this.connected || this.emitReserved("connect_error", t);
              },
            },
            {
              key: "onclose",
              value: function (t, e) {
                (this.connected = !1),
                  delete this.id,
                  this.emitReserved("disconnect", t, e);
              },
            },
            {
              key: "onpacket",
              value: function (t) {
                if (t.nsp === this.nsp)
                  switch (t.type) {
                    case _t.CONNECT:
                      if (t.data && t.data.sid) {
                        var e = t.data.sid;
                        this.onconnect(e);
                      } else
                        this.emitReserved(
                          "connect_error",
                          new Error(
                            "It seems you are trying to reach a Socket.IO server in v2.x with a v3.x client, but they are not compatible (more information here: https://socket.io/docs/v3/migrating-from-2-x-to-3-0/)"
                          )
                        );
                      break;
                    case _t.EVENT:
                    case _t.BINARY_EVENT:
                      this.onevent(t);
                      break;
                    case _t.ACK:
                    case _t.BINARY_ACK:
                      this.onack(t);
                      break;
                    case _t.DISCONNECT:
                      this.ondisconnect();
                      break;
                    case _t.CONNECT_ERROR:
                      this.destroy();
                      var n = new Error(t.data.message);
                      (n.data = t.data.data),
                        this.emitReserved("connect_error", n);
                  }
              },
            },
            {
              key: "onevent",
              value: function (t) {
                var e = t.data || [];
                null != t.id && e.push(this.ack(t.id)),
                  this.connected
                    ? this.emitEvent(e)
                    : this.receiveBuffer.push(Object.freeze(e));
              },
            },
            {
              key: "emitEvent",
              value: function (t) {
                if (this._anyListeners && this._anyListeners.length) {
                  var e,
                    n = v(this._anyListeners.slice());
                  try {
                    for (n.s(); !(e = n.n()).done;) {
                      e.value.apply(this, t);
                    }
                  } catch (t) {
                    n.e(t);
                  } finally {
                    n.f();
                  }
                }
                d(s(i.prototype), "emit", this).apply(this, t);
              },
            },
            {
              key: "ack",
              value: function (t) {
                var e = this,
                  n = !1;
                return function () {
                  if (!n) {
                    n = !0;
                    for (
                      var r = arguments.length, i = new Array(r), o = 0;
                      o < r;
                      o++
                    )
                      i[o] = arguments[o];
                    e.packet({ type: _t.ACK, id: t, data: i });
                  }
                };
              },
            },
            {
              key: "onack",
              value: function (t) {
                var e = this.acks[t.id];
                "function" == typeof e &&
                  (e.apply(this, t.data), delete this.acks[t.id]);
              },
            },
            {
              key: "onconnect",
              value: function (t) {
                (this.id = t),
                  (this.connected = !0),
                  this.emitBuffered(),
                  this.emitReserved("connect");
              },
            },
            {
              key: "emitBuffered",
              value: function () {
                var t = this;
                this.receiveBuffer.forEach(function (e) {
                  return t.emitEvent(e);
                }),
                  (this.receiveBuffer = []),
                  this.sendBuffer.forEach(function (e) {
                    t.notifyOutgoingListeners(e), t.packet(e);
                  }),
                  (this.sendBuffer = []);
              },
            },
            {
              key: "ondisconnect",
              value: function () {
                this.destroy(), this.onclose("io server disconnect");
              },
            },
            {
              key: "destroy",
              value: function () {
                this.subs &&
                  (this.subs.forEach(function (t) {
                    return t();
                  }),
                    (this.subs = void 0)),
                  this.io._destroy(this);
              },
            },
            {
              key: "disconnect",
              value: function () {
                return (
                  this.connected && this.packet({ type: _t.DISCONNECT }),
                  this.destroy(),
                  this.connected && this.onclose("io client disconnect"),
                  this
                );
              },
            },
            {
              key: "close",
              value: function () {
                return this.disconnect();
              },
            },
            {
              key: "compress",
              value: function (t) {
                return (this.flags.compress = t), this;
              },
            },
            {
              key: "volatile",
              get: function () {
                return (this.flags.volatile = !0), this;
              },
            },
            {
              key: "timeout",
              value: function (t) {
                return (this.flags.timeout = t), this;
              },
            },
            {
              key: "onAny",
              value: function (t) {
                return (
                  (this._anyListeners = this._anyListeners || []),
                  this._anyListeners.push(t),
                  this
                );
              },
            },
            {
              key: "prependAny",
              value: function (t) {
                return (
                  (this._anyListeners = this._anyListeners || []),
                  this._anyListeners.unshift(t),
                  this
                );
              },
            },
            {
              key: "offAny",
              value: function (t) {
                if (!this._anyListeners) return this;
                if (t) {
                  for (var e = this._anyListeners, n = 0; n < e.length; n++)
                    if (t === e[n]) return e.splice(n, 1), this;
                } else this._anyListeners = [];
                return this;
              },
            },
            {
              key: "listenersAny",
              value: function () {
                return this._anyListeners || [];
              },
            },
            {
              key: "onAnyOutgoing",
              value: function (t) {
                return (
                  (this._anyOutgoingListeners =
                    this._anyOutgoingListeners || []),
                  this._anyOutgoingListeners.push(t),
                  this
                );
              },
            },
            {
              key: "prependAnyOutgoing",
              value: function (t) {
                return (
                  (this._anyOutgoingListeners =
                    this._anyOutgoingListeners || []),
                  this._anyOutgoingListeners.unshift(t),
                  this
                );
              },
            },
            {
              key: "offAnyOutgoing",
              value: function (t) {
                if (!this._anyOutgoingListeners) return this;
                if (t) {
                  for (
                    var e = this._anyOutgoingListeners, n = 0;
                    n < e.length;
                    n++
                  )
                    if (t === e[n]) return e.splice(n, 1), this;
                } else this._anyOutgoingListeners = [];
                return this;
              },
            },
            {
              key: "listenersAnyOutgoing",
              value: function () {
                return this._anyOutgoingListeners || [];
              },
            },
            {
              key: "notifyOutgoingListeners",
              value: function (t) {
                if (
                  this._anyOutgoingListeners &&
                  this._anyOutgoingListeners.length
                ) {
                  var e,
                    n = v(this._anyOutgoingListeners.slice());
                  try {
                    for (n.s(); !(e = n.n()).done;) {
                      e.value.apply(this, t.data);
                    }
                  } catch (t) {
                    n.e(t);
                  } finally {
                    n.f();
                  }
                }
              },
            },
          ]),
          i
        );
      })(x);
    function St(t) {
      (t = t || {}),
        (this.ms = t.min || 100),
        (this.max = t.max || 1e4),
        (this.factor = t.factor || 2),
        (this.jitter = t.jitter > 0 && t.jitter <= 1 ? t.jitter : 0),
        (this.attempts = 0);
    }
    (St.prototype.duration = function () {
      var t = this.ms * Math.pow(this.factor, this.attempts++);
      if (this.jitter) {
        var e = Math.random(),
          n = Math.floor(e * this.jitter * t);
        t = 0 == (1 & Math.floor(10 * e)) ? t - n : t + n;
      }
      return 0 | Math.min(t, this.max);
    }),
      (St.prototype.reset = function () {
        this.attempts = 0;
      }),
      (St.prototype.setMin = function (t) {
        this.ms = t;
      }),
      (St.prototype.setMax = function (t) {
        this.max = t;
      }),
      (St.prototype.setJitter = function (t) {
        this.jitter = t;
      });
    var Nt = (function (n) {
      o(s, n);
      var i = p(s);
      function s(n, r) {
        var o, a;
        e(this, s),
          ((o = i.call(this)).nsps = {}),
          (o.subs = []),
          n && "object" === t(n) && ((r = n), (n = void 0)),
          ((r = r || {}).path = r.path || "/socket.io"),
          (o.opts = r),
          I(f(o), r),
          o.reconnection(!1 !== r.reconnection),
          o.reconnectionAttempts(r.reconnectionAttempts || 1 / 0),
          o.reconnectionDelay(r.reconnectionDelay || 1e3),
          o.reconnectionDelayMax(r.reconnectionDelayMax || 5e3),
          o.randomizationFactor(
            null !== (a = r.randomizationFactor) && void 0 !== a ? a : 0.5
          ),
          (o.backoff = new St({
            min: o.reconnectionDelay(),
            max: o.reconnectionDelayMax(),
            jitter: o.randomizationFactor(),
          })),
          o.timeout(null == r.timeout ? 2e4 : r.timeout),
          (o._readyState = "closed"),
          (o.uri = n);
        var c = r.parser || Rt;
        return (
          (o.encoder = new c.Encoder()),
          (o.decoder = new c.Decoder()),
          (o._autoConnect = !1 !== r.autoConnect),
          o._autoConnect && o.open(),
          o
        );
      }
      return (
        r(s, [
          {
            key: "reconnection",
            value: function (t) {
              return arguments.length
                ? ((this._reconnection = !!t), this)
                : this._reconnection;
            },
          },
          {
            key: "reconnectionAttempts",
            value: function (t) {
              return void 0 === t
                ? this._reconnectionAttempts
                : ((this._reconnectionAttempts = t), this);
            },
          },
          {
            key: "reconnectionDelay",
            value: function (t) {
              var e;
              return void 0 === t
                ? this._reconnectionDelay
                : ((this._reconnectionDelay = t),
                  null === (e = this.backoff) ||
                  void 0 === e ||
                  e.setMin(t),
                  this);
            },
          },
          {
            key: "randomizationFactor",
            value: function (t) {
              var e;
              return void 0 === t
                ? this._randomizationFactor
                : ((this._randomizationFactor = t),
                  null === (e = this.backoff) ||
                  void 0 === e ||
                  e.setJitter(t),
                  this);
            },
          },
          {
            key: "reconnectionDelayMax",
            value: function (t) {
              var e;
              return void 0 === t
                ? this._reconnectionDelayMax
                : ((this._reconnectionDelayMax = t),
                  null === (e = this.backoff) ||
                  void 0 === e ||
                  e.setMax(t),
                  this);
            },
          },
          {
            key: "timeout",
            value: function (t) {
              return arguments.length
                ? ((this._timeout = t), this)
                : this._timeout;
            },
          },
          {
            key: "maybeReconnectOnOpen",
            value: function () {
              !this._reconnecting &&
                this._reconnection &&
                0 === this.backoff.attempts &&
                this.reconnect();
            },
          },
          {
            key: "open",
            value: function (t) {
              var e = this;
              if (~this._readyState.indexOf("open")) return this;
              this.engine = new ft(this.uri, this.opts);
              var n = this.engine,
                r = this;
              (this._readyState = "opening"), (this.skipReconnect = !1);
              var i = Tt(n, "open", function () {
                r.onopen(), t && t();
              }),
                o = Tt(n, "error", function (n) {
                  r.cleanup(),
                    (r._readyState = "closed"),
                    e.emitReserved("error", n),
                    t ? t(n) : r.maybeReconnectOnOpen();
                });
              if (!1 !== this._timeout) {
                var s = this._timeout;
                0 === s && i();
                var a = this.setTimeoutFn(function () {
                  i(), n.close(), n.emit("error", new Error("timeout"));
                }, s);
                this.opts.autoUnref && a.unref(),
                  this.subs.push(function () {
                    clearTimeout(a);
                  });
              }
              return this.subs.push(i), this.subs.push(o), this;
            },
          },
          {
            key: "connect",
            value: function (t) {
              return this.open(t);
            },
          },
          {
            key: "onopen",
            value: function () {
              this.cleanup(),
                (this._readyState = "open"),
                this.emitReserved("open");
              var t = this.engine;
              this.subs.push(
                Tt(t, "ping", this.onping.bind(this)),
                Tt(t, "data", this.ondata.bind(this)),
                Tt(t, "error", this.onerror.bind(this)),
                Tt(t, "close", this.onclose.bind(this)),
                Tt(this.decoder, "decoded", this.ondecoded.bind(this))
              );
            },
          },
          {
            key: "onping",
            value: function () {
              this.emitReserved("ping");
            },
          },
          {
            key: "ondata",
            value: function (t) {
              this.decoder.add(t);
            },
          },
          {
            key: "ondecoded",
            value: function (t) {
              this.emitReserved("packet", t);
            },
          },
          {
            key: "onerror",
            value: function (t) {
              this.emitReserved("error", t);
            },
          },
          {
            key: "socket",
            value: function (t, e) {
              var n = this.nsps[t];
              return n || ((n = new Bt(this, t, e)), (this.nsps[t] = n)), n;
            },
          },
          {
            key: "_destroy",
            value: function (t) {
              for (
                var e = 0, n = Object.keys(this.nsps);
                e < n.length;
                e++
              ) {
                var r = n[e];
                if (this.nsps[r].active) return;
              }
              this._close();
            },
          },
          {
            key: "_packet",
            value: function (t) {
              for (var e = this.encoder.encode(t), n = 0; n < e.length; n++)
                this.engine.write(e[n], t.options);
            },
          },
          {
            key: "cleanup",
            value: function () {
              this.subs.forEach(function (t) {
                return t();
              }),
                (this.subs.length = 0),
                this.decoder.destroy();
            },
          },
          {
            key: "_close",
            value: function () {
              (this.skipReconnect = !0),
                (this._reconnecting = !1),
                this.onclose("forced close"),
                this.engine && this.engine.close();
            },
          },
          {
            key: "disconnect",
            value: function () {
              return this._close();
            },
          },
          {
            key: "onclose",
            value: function (t, e) {
              this.cleanup(),
                this.backoff.reset(),
                (this._readyState = "closed"),
                this.emitReserved("close", t, e),
                this._reconnection &&
                !this.skipReconnect &&
                this.reconnect();
            },
          },
          {
            key: "reconnect",
            value: function () {
              var t = this;
              if (this._reconnecting || this.skipReconnect) return this;
              var e = this;
              if (this.backoff.attempts >= this._reconnectionAttempts)
                this.backoff.reset(),
                  this.emitReserved("reconnect_failed"),
                  (this._reconnecting = !1);
              else {
                var n = this.backoff.duration();
                this._reconnecting = !0;
                var r = this.setTimeoutFn(function () {
                  e.skipReconnect ||
                    (t.emitReserved(
                      "reconnect_attempt",
                      e.backoff.attempts
                    ),
                      e.skipReconnect ||
                      e.open(function (n) {
                        n
                          ? ((e._reconnecting = !1),
                            e.reconnect(),
                            t.emitReserved("reconnect_error", n))
                          : e.onreconnect();
                      }));
                }, n);
                this.opts.autoUnref && r.unref(),
                  this.subs.push(function () {
                    clearTimeout(r);
                  });
              }
            },
          },
          {
            key: "onreconnect",
            value: function () {
              var t = this.backoff.attempts;
              (this._reconnecting = !1),
                this.backoff.reset(),
                this.emitReserved("reconnect", t);
            },
          },
        ]),
        s
      );
    })(x),
      xt = {};
    function Lt(e, n) {
      "object" === t(e) && ((n = e), (e = void 0));
      var r,
        i = (function (t) {
          var e =
            arguments.length > 1 && void 0 !== arguments[1]
              ? arguments[1]
              : "",
            n = arguments.length > 2 ? arguments[2] : void 0,
            r = t;
          (n = n || ("undefined" != typeof location && location)),
            null == t && (t = n.protocol + "//" + n.host),
            "string" == typeof t &&
            ("/" === t.charAt(0) &&
              (t = "/" === t.charAt(1) ? n.protocol + t : n.host + t),
              /^(https?|wss?):\/\//.test(t) ||
              (t = void 0 !== n ? n.protocol + "//" + t : "https://" + t),
              (r = ht(t))),
            r.port ||
            (/^(http|ws)$/.test(r.protocol)
              ? (r.port = "80")
              : /^(http|ws)s$/.test(r.protocol) && (r.port = "443")),
            (r.path = r.path || "/");
          var i = -1 !== r.host.indexOf(":") ? "[" + r.host + "]" : r.host;
          return (
            (r.id = r.protocol + "://" + i + ":" + r.port + e),
            (r.href =
              r.protocol +
              "://" +
              i +
              (n && n.port === r.port ? "" : ":" + r.port)),
            r
          );
        })(e, (n = n || {}).path || "/socket.io"),
        o = i.source,
        s = i.id,
        a = i.path,
        c = xt[s] && a in xt[s].nsps;
      return (
        n.forceNew || n["force new connection"] || !1 === n.multiplex || c
          ? (r = new Nt(o, n))
          : (xt[s] || (xt[s] = new Nt(o, n)), (r = xt[s])),
        i.query && !n.query && (n.query = i.queryKey),
        r.socket(i.path, n)
      );
    }
    return i(Lt, { Manager: Nt, Socket: Bt, io: Lt, connect: Lt }), Lt;
  });
    //# sourceMappingURL=socket.io.min.js.map
</script>
<script>
  !(function (t, s) {
    "object" == typeof exports && "object" == typeof module
      ? (module.exports = s())
      : "function" == typeof define && define.amd
        ? define("jsnes", [], s)
        : "object" == typeof exports
          ? (exports.jsnes = s())
          : (t.jsnes = s());
  })("undefined" != typeof self ? self : this, function () {
    return (function (t) {
      function s(e) {
        if (i[e]) return i[e].exports;
        var h = (i[e] = { i: e, l: !1, exports: {} });
        return t[e].call(h.exports, h, h.exports, s), (h.l = !0), h.exports;
      }
      var i = {};
      return (
        (s.m = t),
        (s.c = i),
        (s.d = function (t, i, e) {
          s.o(t, i) ||
            Object.defineProperty(t, i, {
              configurable: !1,
              enumerable: !0,
              get: e,
            });
        }),
        (s.n = function (t) {
          var i =
            t && t.__esModule
              ? function () {
                return t.default;
              }
              : function () {
                return t;
              };
          return s.d(i, "a", i), i;
        }),
        (s.o = function (t, s) {
          return Object.prototype.hasOwnProperty.call(t, s);
        }),
        (s.p = ""),
        s((s.s = 3))
      );
    })([
      function (t, s) {
        t.exports = {
          copyArrayElements: function (t, s, i, e, h) {
            for (var r = 0; r < h; ++r) i[e + r] = t[s + r];
          },
          copyArray: function (t) {
            return t.slice(0);
          },
          fromJSON: function (t, s) {
            for (var i = 0; i < t.JSON_PROPERTIES.length; i++)
              t[t.JSON_PROPERTIES[i]] = s[t.JSON_PROPERTIES[i]];
          },
          toJSON: function (t) {
            for (var s = {}, i = 0; i < t.JSON_PROPERTIES.length; i++)
              s[t.JSON_PROPERTIES[i]] = t[t.JSON_PROPERTIES[i]];
            return s;
          },
        };
      },
      function (t, s) {
        var i = function () {
          this.state = new Array(8);
          for (var t = 0; t < this.state.length; t++) this.state[t] = 64;
        };
        (i.BUTTON_A = 0),
          (i.BUTTON_B = 1),
          (i.BUTTON_SELECT = 2),
          (i.BUTTON_START = 3),
          (i.BUTTON_UP = 4),
          (i.BUTTON_DOWN = 5),
          (i.BUTTON_LEFT = 6),
          (i.BUTTON_RIGHT = 7),
          (i.prototype = {
            buttonDown: function (t) {
              this.state[t] = 65;
            },
            buttonUp: function (t) {
              this.state[t] = 64;
            },
          }),
          (t.exports = i);
      },
      function (t, s) {
        var i = function () {
          (this.pix = new Array(64)),
            (this.fbIndex = null),
            (this.tIndex = null),
            (this.x = null),
            (this.y = null),
            (this.w = null),
            (this.h = null),
            (this.incX = null),
            (this.incY = null),
            (this.palIndex = null),
            (this.tpri = null),
            (this.c = null),
            (this.initialized = !1),
            (this.opaque = new Array(8));
        };
        (i.prototype = {
          setBuffer: function (t) {
            for (this.y = 0; this.y < 8; this.y++)
              this.setScanline(this.y, t[this.y], t[this.y + 8]);
          },
          setScanline: function (t, s, i) {
            for (
              this.initialized = !0, this.tIndex = t << 3, this.x = 0;
              this.x < 8;
              this.x++
            )
              (this.pix[this.tIndex + this.x] =
                ((s >> (7 - this.x)) & 1) + (((i >> (7 - this.x)) & 1) << 1)),
                0 === this.pix[this.tIndex + this.x] && (this.opaque[t] = !1);
          },
          render: function (t, s, i, e, h, r, n, a, o, l, p, u, m) {
            if (!(r < -7 || r >= 256 || n < -7 || n >= 240))
              if (
                ((this.w = e - s),
                  (this.h = h - i),
                  r < 0 && (s -= r),
                  r + e >= 256 && (e = 256 - r),
                  n < 0 && (i -= n),
                  n + h >= 240 && (h = 240 - n),
                  l || p)
              )
                if (l && !p)
                  for (
                    this.fbIndex = (n << 8) + r, this.tIndex = 7, this.y = 0;
                    this.y < 8;
                    this.y++
                  ) {
                    for (this.x = 0; this.x < 8; this.x++)
                      this.x >= s &&
                        this.x < e &&
                        this.y >= i &&
                        this.y < h &&
                        ((this.palIndex = this.pix[this.tIndex]),
                          (this.tpri = m[this.fbIndex]),
                          0 !== this.palIndex &&
                          u <= (255 & this.tpri) &&
                          ((t[this.fbIndex] = o[this.palIndex + a]),
                            (this.tpri = (3840 & this.tpri) | u),
                            (m[this.fbIndex] = this.tpri))),
                        this.fbIndex++,
                        this.tIndex--;
                    (this.fbIndex -= 8),
                      (this.fbIndex += 256),
                      (this.tIndex += 16);
                  }
                else if (p && !l)
                  for (
                    this.fbIndex = (n << 8) + r, this.tIndex = 56, this.y = 0;
                    this.y < 8;
                    this.y++
                  ) {
                    for (this.x = 0; this.x < 8; this.x++)
                      this.x >= s &&
                        this.x < e &&
                        this.y >= i &&
                        this.y < h &&
                        ((this.palIndex = this.pix[this.tIndex]),
                          (this.tpri = m[this.fbIndex]),
                          0 !== this.palIndex &&
                          u <= (255 & this.tpri) &&
                          ((t[this.fbIndex] = o[this.palIndex + a]),
                            (this.tpri = (3840 & this.tpri) | u),
                            (m[this.fbIndex] = this.tpri))),
                        this.fbIndex++,
                        this.tIndex++;
                    (this.fbIndex -= 8),
                      (this.fbIndex += 256),
                      (this.tIndex -= 16);
                  }
                else
                  for (
                    this.fbIndex = (n << 8) + r, this.tIndex = 63, this.y = 0;
                    this.y < 8;
                    this.y++
                  ) {
                    for (this.x = 0; this.x < 8; this.x++)
                      this.x >= s &&
                        this.x < e &&
                        this.y >= i &&
                        this.y < h &&
                        ((this.palIndex = this.pix[this.tIndex]),
                          (this.tpri = m[this.fbIndex]),
                          0 !== this.palIndex &&
                          u <= (255 & this.tpri) &&
                          ((t[this.fbIndex] = o[this.palIndex + a]),
                            (this.tpri = (3840 & this.tpri) | u),
                            (m[this.fbIndex] = this.tpri))),
                        this.fbIndex++,
                        this.tIndex--;
                    (this.fbIndex -= 8), (this.fbIndex += 256);
                  }
              else
                for (
                  this.fbIndex = (n << 8) + r, this.tIndex = 0, this.y = 0;
                  this.y < 8;
                  this.y++
                ) {
                  for (this.x = 0; this.x < 8; this.x++)
                    this.x >= s &&
                      this.x < e &&
                      this.y >= i &&
                      this.y < h &&
                      ((this.palIndex = this.pix[this.tIndex]),
                        (this.tpri = m[this.fbIndex]),
                        0 !== this.palIndex &&
                        u <= (255 & this.tpri) &&
                        ((t[this.fbIndex] = o[this.palIndex + a]),
                          (this.tpri = (3840 & this.tpri) | u),
                          (m[this.fbIndex] = this.tpri))),
                      this.fbIndex++,
                      this.tIndex++;
                  (this.fbIndex -= 8), (this.fbIndex += 256);
                }
          },
          isTransparent: function (t, s) {
            return 0 === this.pix[(s << 3) + t];
          },
          toJSON: function () {
            return { opaque: this.opaque, pix: this.pix };
          },
          fromJSON: function (t) {
            (this.opaque = t.opaque), (this.pix = t.pix);
          },
        }),
          (t.exports = i);
      },
      function (t, s, i) {
        t.exports = { Controller: i(1), NES: i(4) };
      },
      function (t, s, i) {
        var e = i(5),
          h = i(1),
          r = i(6),
          n = i(7),
          a = i(8),
          o = function (t) {
            if (
              ((this.opts = {
                onFrame: function () { },
                onAudioSample: null,
                onStatusUpdate: function () { },
                onBatteryRamWrite: function () { },
                preferredFrameRate: 60,
                emulateSound: !0,
                sampleRate: 48e3,
              }),
                void 0 !== t)
            ) {
              var s;
              for (s in this.opts) void 0 !== t[s] && (this.opts[s] = t[s]);
            }
            (this.frameTime = 1e3 / this.opts.preferredFrameRate),
              (this.ui = {
                writeFrame: this.opts.onFrame,
                updateStatus: this.opts.onStatusUpdate,
              }),
              (this.cpu = new e(this)),
              (this.ppu = new r(this)),
              (this.papu = new n(this)),
              (this.mmap = null),
              (this.controllers = { 1: new h(), 2: new h() }),
              this.ui.updateStatus("Ready to load a ROM."),
              (this.frame = this.frame.bind(this)),
              (this.buttonDown = this.buttonDown.bind(this)),
              (this.buttonUp = this.buttonUp.bind(this)),
              (this.zapperMove = this.zapperMove.bind(this)),
              (this.zapperFireDown = this.zapperFireDown.bind(this)),
              (this.zapperFireUp = this.zapperFireUp.bind(this));
          };
        (o.prototype = {
          fpsFrameCount: 0,
          romData: null,
          reset: function () {
            null !== this.mmap && this.mmap.reset(),
              this.cpu.reset(),
              this.ppu.reset(),
              this.papu.reset(),
              (this.lastFpsTime = null),
              (this.fpsFrameCount = 0);
          },
          frame: function () {
            this.ppu.startFrame();
            var t = 0,
              s = this.opts.emulateSound,
              i = this.cpu,
              e = this.ppu,
              h = this.papu;
            t: for (; ;)
              for (
                0 === i.cyclesToHalt
                  ? ((t = i.emulate()), s && h.clockFrameCounter(t), (t *= 3))
                  : i.cyclesToHalt > 8
                    ? ((t = 24),
                      s && h.clockFrameCounter(8),
                      (i.cyclesToHalt -= 8))
                    : ((t = 3 * i.cyclesToHalt),
                      s && h.clockFrameCounter(i.cyclesToHalt),
                      (i.cyclesToHalt = 0));
                t > 0;
                t--
              ) {
                if (
                  (e.curX === e.spr0HitX &&
                    1 === e.f_spVisibility &&
                    e.scanline - 21 === e.spr0HitY &&
                    e.setStatusFlag(e.STATUS_SPRITE0HIT, !0),
                    e.requestEndFrame && 0 === --e.nmiCounter)
                ) {
                  (e.requestEndFrame = !1), e.startVBlank();
                  break t;
                }
                e.curX++, 341 === e.curX && ((e.curX = 0), e.endScanline());
              }
            this.fpsFrameCount++;
          },
          buttonDown: function (t, s) {
            this.controllers[t].buttonDown(s);
          },
          buttonUp: function (t, s) {
            this.controllers[t].buttonUp(s);
          },
          zapperMove: function (t, s) {
            this.mmap && ((this.mmap.zapperX = t), (this.mmap.zapperY = s));
          },
          zapperFireDown: function () {
            this.mmap && (this.mmap.zapperFired = !0);
          },
          zapperFireUp: function () {
            this.mmap && (this.mmap.zapperFired = !1);
          },
          getFPS: function () {
            var t = +new Date(),
              s = null;
            return (
              this.lastFpsTime &&
              (s = this.fpsFrameCount / ((t - this.lastFpsTime) / 1e3)),
              (this.fpsFrameCount = 0),
              (this.lastFpsTime = t),
              s
            );
          },
          reloadROM: function () {
            null !== this.romData && this.loadROM(this.romData);
          },
          loadROM: function (t) {
            (this.rom = new a(this)),
              this.rom.load(t),
              this.reset(),
              (this.mmap = this.rom.createMapper()),
              this.mmap.loadROM(),
              this.ppu.setMirroring(this.rom.getMirroringType()),
              (this.romData = t);
          },
          setFramerate: function (t) {
            (this.opts.preferredFrameRate = t),
              (this.frameTime = 1e3 / t),
              this.papu.setSampleRate(this.opts.sampleRate, !1);
          },
          toJSON: function () {
            return {
              romData: this.romData,
              cpu: this.cpu.toJSON(),
              mmap: this.mmap.toJSON(),
              ppu: this.ppu.toJSON(),
            };
          },
          fromJSON: function (t) {
            this.reset(),
              (this.romData = t.romData),
              this.cpu.fromJSON(t.cpu),
              this.mmap.fromJSON(t.mmap),
              this.ppu.fromJSON(t.ppu);
          },
        }),
          (t.exports = o);
      },
      function (t, s, i) {
        var e = i(0),
          h = function (t) {
            (this.nes = t),
              (this.mem = null),
              (this.REG_ACC = null),
              (this.REG_X = null),
              (this.REG_Y = null),
              (this.REG_SP = null),
              (this.REG_PC = null),
              (this.REG_PC_NEW = null),
              (this.REG_STATUS = null),
              (this.F_CARRY = null),
              (this.F_DECIMAL = null),
              (this.F_INTERRUPT = null),
              (this.F_INTERRUPT_NEW = null),
              (this.F_OVERFLOW = null),
              (this.F_SIGN = null),
              (this.F_ZERO = null),
              (this.F_NOTUSED = null),
              (this.F_NOTUSED_NEW = null),
              (this.F_BRK = null),
              (this.F_BRK_NEW = null),
              (this.opdata = null),
              (this.cyclesToHalt = null),
              (this.crash = null),
              (this.irqRequested = null),
              (this.irqType = null),
              this.reset();
          };
        h.prototype = {
          IRQ_NORMAL: 0,
          IRQ_NMI: 1,
          IRQ_RESET: 2,
          reset: function () {
            this.mem = new Array(65536);
            for (var t = 0; t < 8192; t++) this.mem[t] = 255;
            for (var s = 0; s < 4; s++) {
              var i = 2048 * s;
              (this.mem[i + 8] = 247),
                (this.mem[i + 9] = 239),
                (this.mem[i + 10] = 223),
                (this.mem[i + 15] = 191);
            }
            for (var e = 8193; e < this.mem.length; e++) this.mem[e] = 0;
            (this.REG_ACC = 0),
              (this.REG_X = 0),
              (this.REG_Y = 0),
              (this.REG_SP = 511),
              (this.REG_PC = 32767),
              (this.REG_PC_NEW = 32767),
              (this.REG_STATUS = 40),
              this.setStatus(40),
              (this.F_CARRY = 0),
              (this.F_DECIMAL = 0),
              (this.F_INTERRUPT = 1),
              (this.F_INTERRUPT_NEW = 1),
              (this.F_OVERFLOW = 0),
              (this.F_SIGN = 0),
              (this.F_ZERO = 1),
              (this.F_NOTUSED = 1),
              (this.F_NOTUSED_NEW = 1),
              (this.F_BRK = 1),
              (this.F_BRK_NEW = 1),
              (this.opdata = new r().opdata),
              (this.cyclesToHalt = 0),
              (this.crash = !1),
              (this.irqRequested = !1),
              (this.irqType = null);
          },
          emulate: function () {
            var t, s;
            if (this.irqRequested) {
              switch (
              ((t =
                this.F_CARRY |
                ((0 === this.F_ZERO ? 1 : 0) << 1) |
                (this.F_INTERRUPT << 2) |
                (this.F_DECIMAL << 3) |
                (this.F_BRK << 4) |
                (this.F_NOTUSED << 5) |
                (this.F_OVERFLOW << 6) |
                (this.F_SIGN << 7)),
                (this.REG_PC_NEW = this.REG_PC),
                (this.F_INTERRUPT_NEW = this.F_INTERRUPT),
                this.irqType)
              ) {
                case 0:
                  if (0 !== this.F_INTERRUPT) break;
                  this.doIrq(t);
                  break;
                case 1:
                  this.doNonMaskableInterrupt(t);
                  break;
                case 2:
                  this.doResetInterrupt();
              }
              (this.REG_PC = this.REG_PC_NEW),
                (this.F_INTERRUPT = this.F_INTERRUPT_NEW),
                (this.F_BRK = this.F_BRK_NEW),
                (this.irqRequested = !1);
            }
            var i = this.opdata[this.nes.mmap.load(this.REG_PC + 1)],
              e = i >> 24,
              h = 0,
              r = (i >> 8) & 255,
              n = this.REG_PC;
            this.REG_PC += (i >> 16) & 255;
            var a = 0;
            switch (r) {
              case 0:
                a = this.load(n + 2);
                break;
              case 1:
                (a = this.load(n + 2)),
                  (a += a < 128 ? this.REG_PC : this.REG_PC - 256);
                break;
              case 2:
                break;
              case 3:
                a = this.load16bit(n + 2);
                break;
              case 4:
                a = this.REG_ACC;
                break;
              case 5:
                a = this.REG_PC;
                break;
              case 6:
                a = (this.load(n + 2) + this.REG_X) & 255;
                break;
              case 7:
                a = (this.load(n + 2) + this.REG_Y) & 255;
                break;
              case 8:
                (a = this.load16bit(n + 2)),
                  (65280 & a) != ((a + this.REG_X) & 65280) && (h = 1),
                  (a += this.REG_X);
                break;
              case 9:
                (a = this.load16bit(n + 2)),
                  (65280 & a) != ((a + this.REG_Y) & 65280) && (h = 1),
                  (a += this.REG_Y);
                break;
              case 10:
                (a = this.load(n + 2)),
                  (65280 & a) != ((a + this.REG_X) & 65280) && (h = 1),
                  (a += this.REG_X),
                  (a &= 255),
                  (a = this.load16bit(a));
                break;
              case 11:
                (a = this.load16bit(this.load(n + 2))),
                  (65280 & a) != ((a + this.REG_Y) & 65280) && (h = 1),
                  (a += this.REG_Y);
                break;
              case 12:
                (a = this.load16bit(n + 2)),
                  (a =
                    a < 8191
                      ? this.mem[a] +
                      (this.mem[(65280 & a) | ((1 + (255 & a)) & 255)] << 8)
                      : this.nes.mmap.load(a) +
                      (this.nes.mmap.load(
                        (65280 & a) | ((1 + (255 & a)) & 255)
                      ) <<
                        8));
            }
            switch (((a &= 65535), 255 & i)) {
              case 0:
                (t = this.REG_ACC + this.load(a) + this.F_CARRY),
                  0 == (128 & (this.REG_ACC ^ this.load(a))) &&
                    0 != (128 & (this.REG_ACC ^ t))
                    ? (this.F_OVERFLOW = 1)
                    : (this.F_OVERFLOW = 0),
                  (this.F_CARRY = t > 255 ? 1 : 0),
                  (this.F_SIGN = (t >> 7) & 1),
                  (this.F_ZERO = 255 & t),
                  (this.REG_ACC = 255 & t),
                  (e += h);
                break;
              case 1:
                (this.REG_ACC = this.REG_ACC & this.load(a)),
                  (this.F_SIGN = (this.REG_ACC >> 7) & 1),
                  (this.F_ZERO = this.REG_ACC),
                  11 !== r && (e += h);
                break;
              case 2:
                4 === r
                  ? ((this.F_CARRY = (this.REG_ACC >> 7) & 1),
                    (this.REG_ACC = (this.REG_ACC << 1) & 255),
                    (this.F_SIGN = (this.REG_ACC >> 7) & 1),
                    (this.F_ZERO = this.REG_ACC))
                  : ((t = this.load(a)),
                    (this.F_CARRY = (t >> 7) & 1),
                    (t = (t << 1) & 255),
                    (this.F_SIGN = (t >> 7) & 1),
                    (this.F_ZERO = t),
                    this.write(a, t));
                break;
              case 3:
                0 === this.F_CARRY &&
                  ((e += (65280 & n) != (65280 & a) ? 2 : 1),
                    (this.REG_PC = a));
                break;
              case 4:
                1 === this.F_CARRY &&
                  ((e += (65280 & n) != (65280 & a) ? 2 : 1),
                    (this.REG_PC = a));
                break;
              case 5:
                0 === this.F_ZERO &&
                  ((e += (65280 & n) != (65280 & a) ? 2 : 1),
                    (this.REG_PC = a));
                break;
              case 6:
                (t = this.load(a)),
                  (this.F_SIGN = (t >> 7) & 1),
                  (this.F_OVERFLOW = (t >> 6) & 1),
                  (t &= this.REG_ACC),
                  (this.F_ZERO = t);
                break;
              case 7:
                1 === this.F_SIGN && (e++, (this.REG_PC = a));
                break;
              case 8:
                0 !== this.F_ZERO &&
                  ((e += (65280 & n) != (65280 & a) ? 2 : 1),
                    (this.REG_PC = a));
                break;
              case 9:
                0 === this.F_SIGN &&
                  ((e += (65280 & n) != (65280 & a) ? 2 : 1),
                    (this.REG_PC = a));
                break;
              case 10:
                (this.REG_PC += 2),
                  this.push((this.REG_PC >> 8) & 255),
                  this.push(255 & this.REG_PC),
                  (this.F_BRK = 1),
                  this.push(
                    this.F_CARRY |
                    ((0 === this.F_ZERO ? 1 : 0) << 1) |
                    (this.F_INTERRUPT << 2) |
                    (this.F_DECIMAL << 3) |
                    (this.F_BRK << 4) |
                    (this.F_NOTUSED << 5) |
                    (this.F_OVERFLOW << 6) |
                    (this.F_SIGN << 7)
                  ),
                  (this.F_INTERRUPT = 1),
                  (this.REG_PC = this.load16bit(65534)),
                  this.REG_PC--;
                break;
              case 11:
                0 === this.F_OVERFLOW &&
                  ((e += (65280 & n) != (65280 & a) ? 2 : 1),
                    (this.REG_PC = a));
                break;
              case 12:
                1 === this.F_OVERFLOW &&
                  ((e += (65280 & n) != (65280 & a) ? 2 : 1),
                    (this.REG_PC = a));
                break;
              case 13:
                this.F_CARRY = 0;
                break;
              case 14:
                this.F_DECIMAL = 0;
                break;
              case 15:
                this.F_INTERRUPT = 0;
                break;
              case 16:
                this.F_OVERFLOW = 0;
                break;
              case 17:
                (t = this.REG_ACC - this.load(a)),
                  (this.F_CARRY = t >= 0 ? 1 : 0),
                  (this.F_SIGN = (t >> 7) & 1),
                  (this.F_ZERO = 255 & t),
                  (e += h);
                break;
              case 18:
                (t = this.REG_X - this.load(a)),
                  (this.F_CARRY = t >= 0 ? 1 : 0),
                  (this.F_SIGN = (t >> 7) & 1),
                  (this.F_ZERO = 255 & t);
                break;
              case 19:
                (t = this.REG_Y - this.load(a)),
                  (this.F_CARRY = t >= 0 ? 1 : 0),
                  (this.F_SIGN = (t >> 7) & 1),
                  (this.F_ZERO = 255 & t);
                break;
              case 20:
                (t = (this.load(a) - 1) & 255),
                  (this.F_SIGN = (t >> 7) & 1),
                  (this.F_ZERO = t),
                  this.write(a, t);
                break;
              case 21:
                (this.REG_X = (this.REG_X - 1) & 255),
                  (this.F_SIGN = (this.REG_X >> 7) & 1),
                  (this.F_ZERO = this.REG_X);
                break;
              case 22:
                (this.REG_Y = (this.REG_Y - 1) & 255),
                  (this.F_SIGN = (this.REG_Y >> 7) & 1),
                  (this.F_ZERO = this.REG_Y);
                break;
              case 23:
                (this.REG_ACC = 255 & (this.load(a) ^ this.REG_ACC)),
                  (this.F_SIGN = (this.REG_ACC >> 7) & 1),
                  (this.F_ZERO = this.REG_ACC),
                  (e += h);
                break;
              case 24:
                (t = (this.load(a) + 1) & 255),
                  (this.F_SIGN = (t >> 7) & 1),
                  (this.F_ZERO = t),
                  this.write(a, 255 & t);
                break;
              case 25:
                (this.REG_X = (this.REG_X + 1) & 255),
                  (this.F_SIGN = (this.REG_X >> 7) & 1),
                  (this.F_ZERO = this.REG_X);
                break;
              case 26:
                this.REG_Y++,
                  (this.REG_Y &= 255),
                  (this.F_SIGN = (this.REG_Y >> 7) & 1),
                  (this.F_ZERO = this.REG_Y);
                break;
              case 27:
                this.REG_PC = a - 1;
                break;
              case 28:
                this.push((this.REG_PC >> 8) & 255),
                  this.push(255 & this.REG_PC),
                  (this.REG_PC = a - 1);
                break;
              case 29:
                (this.REG_ACC = this.load(a)),
                  (this.F_SIGN = (this.REG_ACC >> 7) & 1),
                  (this.F_ZERO = this.REG_ACC),
                  (e += h);
                break;
              case 30:
                (this.REG_X = this.load(a)),
                  (this.F_SIGN = (this.REG_X >> 7) & 1),
                  (this.F_ZERO = this.REG_X),
                  (e += h);
                break;
              case 31:
                (this.REG_Y = this.load(a)),
                  (this.F_SIGN = (this.REG_Y >> 7) & 1),
                  (this.F_ZERO = this.REG_Y),
                  (e += h);
                break;
              case 32:
                4 === r
                  ? ((t = 255 & this.REG_ACC),
                    (this.F_CARRY = 1 & t),
                    (t >>= 1),
                    (this.REG_ACC = t))
                  : ((t = 255 & this.load(a)),
                    (this.F_CARRY = 1 & t),
                    (t >>= 1),
                    this.write(a, t)),
                  (this.F_SIGN = 0),
                  (this.F_ZERO = t);
                break;
              case 33:
                break;
              case 34:
                (t = 255 & (this.load(a) | this.REG_ACC)),
                  (this.F_SIGN = (t >> 7) & 1),
                  (this.F_ZERO = t),
                  (this.REG_ACC = t),
                  11 !== r && (e += h);
                break;
              case 35:
                this.push(this.REG_ACC);
                break;
              case 36:
                (this.F_BRK = 1),
                  this.push(
                    this.F_CARRY |
                    ((0 === this.F_ZERO ? 1 : 0) << 1) |
                    (this.F_INTERRUPT << 2) |
                    (this.F_DECIMAL << 3) |
                    (this.F_BRK << 4) |
                    (this.F_NOTUSED << 5) |
                    (this.F_OVERFLOW << 6) |
                    (this.F_SIGN << 7)
                  );
                break;
              case 37:
                (this.REG_ACC = this.pull()),
                  (this.F_SIGN = (this.REG_ACC >> 7) & 1),
                  (this.F_ZERO = this.REG_ACC);
                break;
              case 38:
                (t = this.pull()),
                  (this.F_CARRY = 1 & t),
                  (this.F_ZERO = 1 == ((t >> 1) & 1) ? 0 : 1),
                  (this.F_INTERRUPT = (t >> 2) & 1),
                  (this.F_DECIMAL = (t >> 3) & 1),
                  (this.F_BRK = (t >> 4) & 1),
                  (this.F_NOTUSED = (t >> 5) & 1),
                  (this.F_OVERFLOW = (t >> 6) & 1),
                  (this.F_SIGN = (t >> 7) & 1),
                  (this.F_NOTUSED = 1);
                break;
              case 39:
                4 === r
                  ? ((t = this.REG_ACC),
                    (s = this.F_CARRY),
                    (this.F_CARRY = (t >> 7) & 1),
                    (t = ((t << 1) & 255) + s),
                    (this.REG_ACC = t))
                  : ((t = this.load(a)),
                    (s = this.F_CARRY),
                    (this.F_CARRY = (t >> 7) & 1),
                    (t = ((t << 1) & 255) + s),
                    this.write(a, t)),
                  (this.F_SIGN = (t >> 7) & 1),
                  (this.F_ZERO = t);
                break;
              case 40:
                4 === r
                  ? ((s = this.F_CARRY << 7),
                    (this.F_CARRY = 1 & this.REG_ACC),
                    (t = (this.REG_ACC >> 1) + s),
                    (this.REG_ACC = t))
                  : ((t = this.load(a)),
                    (s = this.F_CARRY << 7),
                    (this.F_CARRY = 1 & t),
                    (t = (t >> 1) + s),
                    this.write(a, t)),
                  (this.F_SIGN = (t >> 7) & 1),
                  (this.F_ZERO = t);
                break;
              case 41:
                if (
                  ((t = this.pull()),
                    (this.F_CARRY = 1 & t),
                    (this.F_ZERO = 0 == ((t >> 1) & 1) ? 1 : 0),
                    (this.F_INTERRUPT = (t >> 2) & 1),
                    (this.F_DECIMAL = (t >> 3) & 1),
                    (this.F_BRK = (t >> 4) & 1),
                    (this.F_NOTUSED = (t >> 5) & 1),
                    (this.F_OVERFLOW = (t >> 6) & 1),
                    (this.F_SIGN = (t >> 7) & 1),
                    (this.REG_PC = this.pull()),
                    (this.REG_PC += this.pull() << 8),
                    65535 === this.REG_PC)
                )
                  return;
                this.REG_PC--, (this.F_NOTUSED = 1);
                break;
              case 42:
                if (
                  ((this.REG_PC = this.pull()),
                    (this.REG_PC += this.pull() << 8),
                    65535 === this.REG_PC)
                )
                  return;
                break;
              case 43:
                (t = this.REG_ACC - this.load(a) - (1 - this.F_CARRY)),
                  (this.F_SIGN = (t >> 7) & 1),
                  (this.F_ZERO = 255 & t),
                  0 != (128 & (this.REG_ACC ^ t)) &&
                    0 != (128 & (this.REG_ACC ^ this.load(a)))
                    ? (this.F_OVERFLOW = 1)
                    : (this.F_OVERFLOW = 0),
                  (this.F_CARRY = t < 0 ? 0 : 1),
                  (this.REG_ACC = 255 & t),
                  11 !== r && (e += h);
                break;
              case 44:
                this.F_CARRY = 1;
                break;
              case 45:
                this.F_DECIMAL = 1;
                break;
              case 46:
                this.F_INTERRUPT = 1;
                break;
              case 47:
                this.write(a, this.REG_ACC);
                break;
              case 48:
                this.write(a, this.REG_X);
                break;
              case 49:
                this.write(a, this.REG_Y);
                break;
              case 50:
                (this.REG_X = this.REG_ACC),
                  (this.F_SIGN = (this.REG_ACC >> 7) & 1),
                  (this.F_ZERO = this.REG_ACC);
                break;
              case 51:
                (this.REG_Y = this.REG_ACC),
                  (this.F_SIGN = (this.REG_ACC >> 7) & 1),
                  (this.F_ZERO = this.REG_ACC);
                break;
              case 52:
                (this.REG_X = this.REG_SP - 256),
                  (this.F_SIGN = (this.REG_SP >> 7) & 1),
                  (this.F_ZERO = this.REG_X);
                break;
              case 53:
                (this.REG_ACC = this.REG_X),
                  (this.F_SIGN = (this.REG_X >> 7) & 1),
                  (this.F_ZERO = this.REG_X);
                break;
              case 54:
                (this.REG_SP = this.REG_X + 256), this.stackWrap();
                break;
              case 55:
                (this.REG_ACC = this.REG_Y),
                  (this.F_SIGN = (this.REG_Y >> 7) & 1),
                  (this.F_ZERO = this.REG_Y);
                break;
              case 56:
                (t = this.REG_ACC & this.load(a)),
                  (this.F_CARRY = 1 & t),
                  (this.REG_ACC = this.F_ZERO = t >> 1),
                  (this.F_SIGN = 0);
                break;
              case 57:
                (this.REG_ACC = this.F_ZERO = this.REG_ACC & this.load(a)),
                  (this.F_CARRY = this.F_SIGN = (this.REG_ACC >> 7) & 1);
                break;
              case 58:
                (t = this.REG_ACC & this.load(a)),
                  (this.REG_ACC = this.F_ZERO =
                    (t >> 1) + (this.F_CARRY << 7)),
                  (this.F_SIGN = this.F_CARRY),
                  (this.F_CARRY = (t >> 7) & 1),
                  (this.F_OVERFLOW = 1 & ((t >> 7) ^ (t >> 6)));
                break;
              case 59:
                (t = (this.REG_X & this.REG_ACC) - this.load(a)),
                  (this.F_SIGN = (t >> 7) & 1),
                  (this.F_ZERO = 255 & t),
                  0 != (128 & (this.REG_X ^ t)) &&
                    0 != (128 & (this.REG_X ^ this.load(a)))
                    ? (this.F_OVERFLOW = 1)
                    : (this.F_OVERFLOW = 0),
                  (this.F_CARRY = t < 0 ? 0 : 1),
                  (this.REG_X = 255 & t);
                break;
              case 60:
                (this.REG_ACC = this.REG_X = this.F_ZERO = this.load(a)),
                  (this.F_SIGN = (this.REG_ACC >> 7) & 1),
                  (e += h);
                break;
              case 61:
                this.write(a, this.REG_ACC & this.REG_X);
                break;
              case 62:
                (t = (this.load(a) - 1) & 255),
                  this.write(a, t),
                  (t = this.REG_ACC - t),
                  (this.F_CARRY = t >= 0 ? 1 : 0),
                  (this.F_SIGN = (t >> 7) & 1),
                  (this.F_ZERO = 255 & t),
                  11 !== r && (e += h);
                break;
              case 63:
                (t = (this.load(a) + 1) & 255),
                  this.write(a, t),
                  (t = this.REG_ACC - t - (1 - this.F_CARRY)),
                  (this.F_SIGN = (t >> 7) & 1),
                  (this.F_ZERO = 255 & t),
                  0 != (128 & (this.REG_ACC ^ t)) &&
                    0 != (128 & (this.REG_ACC ^ this.load(a)))
                    ? (this.F_OVERFLOW = 1)
                    : (this.F_OVERFLOW = 0),
                  (this.F_CARRY = t < 0 ? 0 : 1),
                  (this.REG_ACC = 255 & t),
                  11 !== r && (e += h);
                break;
              case 64:
                (t = this.load(a)),
                  (s = this.F_CARRY),
                  (this.F_CARRY = (t >> 7) & 1),
                  (t = ((t << 1) & 255) + s),
                  this.write(a, t),
                  (this.REG_ACC = this.REG_ACC & t),
                  (this.F_SIGN = (this.REG_ACC >> 7) & 1),
                  (this.F_ZERO = this.REG_ACC),
                  11 !== r && (e += h);
                break;
              case 65:
                (t = this.load(a)),
                  (s = this.F_CARRY << 7),
                  (this.F_CARRY = 1 & t),
                  (t = (t >> 1) + s),
                  this.write(a, t),
                  (t = this.REG_ACC + this.load(a) + this.F_CARRY),
                  0 == (128 & (this.REG_ACC ^ this.load(a))) &&
                    0 != (128 & (this.REG_ACC ^ t))
                    ? (this.F_OVERFLOW = 1)
                    : (this.F_OVERFLOW = 0),
                  (this.F_CARRY = t > 255 ? 1 : 0),
                  (this.F_SIGN = (t >> 7) & 1),
                  (this.F_ZERO = 255 & t),
                  (this.REG_ACC = 255 & t),
                  11 !== r && (e += h);
                break;
              case 66:
                (t = this.load(a)),
                  (this.F_CARRY = (t >> 7) & 1),
                  (t = (t << 1) & 255),
                  this.write(a, t),
                  (this.REG_ACC = this.REG_ACC | t),
                  (this.F_SIGN = (this.REG_ACC >> 7) & 1),
                  (this.F_ZERO = this.REG_ACC),
                  11 !== r && (e += h);
                break;
              case 67:
                (t = 255 & this.load(a)),
                  (this.F_CARRY = 1 & t),
                  (t >>= 1),
                  this.write(a, t),
                  (this.REG_ACC = this.REG_ACC ^ t),
                  (this.F_SIGN = (this.REG_ACC >> 7) & 1),
                  (this.F_ZERO = this.REG_ACC),
                  11 !== r && (e += h);
                break;
              case 68:
                break;
              case 69:
                this.load(a), 11 !== r && (e += h);
                break;
              default:
                this.nes.stop(),
                  (this.nes.crashMessage =
                    "Game crashed, invalid opcode at address $" +
                    n.toString(16));
            }
            return e;
          },
          load: function (t) {
            return t < 8192 ? this.mem[2047 & t] : this.nes.mmap.load(t);
          },
          load16bit: function (t) {
            return t < 8191
              ? this.mem[2047 & t] | (this.mem[(t + 1) & 2047] << 8)
              : this.nes.mmap.load(t) | (this.nes.mmap.load(t + 1) << 8);
          },
          write: function (t, s) {
            t < 8192 ? (this.mem[2047 & t] = s) : this.nes.mmap.write(t, s);
          },
          requestIrq: function (t) {
            (this.irqRequested && t === this.IRQ_NORMAL) ||
              ((this.irqRequested = !0), (this.irqType = t));
          },
          push: function (t) {
            this.nes.mmap.write(this.REG_SP, t),
              this.REG_SP--,
              (this.REG_SP = 256 | (255 & this.REG_SP));
          },
          stackWrap: function () {
            this.REG_SP = 256 | (255 & this.REG_SP);
          },
          pull: function () {
            return (
              this.REG_SP++,
              (this.REG_SP = 256 | (255 & this.REG_SP)),
              this.nes.mmap.load(this.REG_SP)
            );
          },
          pageCrossed: function (t, s) {
            return (65280 & t) != (65280 & s);
          },
          haltCycles: function (t) {
            this.cyclesToHalt += t;
          },
          doNonMaskableInterrupt: function (t) {
            0 != (128 & this.nes.mmap.load(8192)) &&
              (this.REG_PC_NEW++,
                this.push((this.REG_PC_NEW >> 8) & 255),
                this.push(255 & this.REG_PC_NEW),
                this.push(t),
                (this.REG_PC_NEW =
                  this.nes.mmap.load(65530) | (this.nes.mmap.load(65531) << 8)),
                this.REG_PC_NEW--);
          },
          doResetInterrupt: function () {
            (this.REG_PC_NEW =
              this.nes.mmap.load(65532) | (this.nes.mmap.load(65533) << 8)),
              this.REG_PC_NEW--;
          },
          doIrq: function (t) {
            this.REG_PC_NEW++,
              this.push((this.REG_PC_NEW >> 8) & 255),
              this.push(255 & this.REG_PC_NEW),
              this.push(t),
              (this.F_INTERRUPT_NEW = 1),
              (this.F_BRK_NEW = 0),
              (this.REG_PC_NEW =
                this.nes.mmap.load(65534) | (this.nes.mmap.load(65535) << 8)),
              this.REG_PC_NEW--;
          },
          getStatus: function () {
            return (
              this.F_CARRY |
              (this.F_ZERO << 1) |
              (this.F_INTERRUPT << 2) |
              (this.F_DECIMAL << 3) |
              (this.F_BRK << 4) |
              (this.F_NOTUSED << 5) |
              (this.F_OVERFLOW << 6) |
              (this.F_SIGN << 7)
            );
          },
          setStatus: function (t) {
            (this.F_CARRY = 1 & t),
              (this.F_ZERO = (t >> 1) & 1),
              (this.F_INTERRUPT = (t >> 2) & 1),
              (this.F_DECIMAL = (t >> 3) & 1),
              (this.F_BRK = (t >> 4) & 1),
              (this.F_NOTUSED = (t >> 5) & 1),
              (this.F_OVERFLOW = (t >> 6) & 1),
              (this.F_SIGN = (t >> 7) & 1);
          },
          JSON_PROPERTIES: [
            "mem",
            "cyclesToHalt",
            "irqRequested",
            "irqType",
            "REG_ACC",
            "REG_X",
            "REG_Y",
            "REG_SP",
            "REG_PC",
            "REG_PC_NEW",
            "REG_STATUS",
            "F_CARRY",
            "F_DECIMAL",
            "F_INTERRUPT",
            "F_INTERRUPT_NEW",
            "F_OVERFLOW",
            "F_SIGN",
            "F_ZERO",
            "F_NOTUSED",
            "F_NOTUSED_NEW",
            "F_BRK",
            "F_BRK_NEW",
          ],
          toJSON: function () {
            return e.toJSON(this);
          },
          fromJSON: function (t) {
            e.fromJSON(this, t);
          },
        };
        var r = function () {
          this.opdata = new Array(256);
          for (var t = 0; t < 256; t++) this.opdata[t] = 255;
          this.setOp(this.INS_ADC, 105, this.ADDR_IMM, 2, 2),
            this.setOp(this.INS_ADC, 101, this.ADDR_ZP, 2, 3),
            this.setOp(this.INS_ADC, 117, this.ADDR_ZPX, 2, 4),
            this.setOp(this.INS_ADC, 109, this.ADDR_ABS, 3, 4),
            this.setOp(this.INS_ADC, 125, this.ADDR_ABSX, 3, 4),
            this.setOp(this.INS_ADC, 121, this.ADDR_ABSY, 3, 4),
            this.setOp(this.INS_ADC, 97, this.ADDR_PREIDXIND, 2, 6),
            this.setOp(this.INS_ADC, 113, this.ADDR_POSTIDXIND, 2, 5),
            this.setOp(this.INS_AND, 41, this.ADDR_IMM, 2, 2),
            this.setOp(this.INS_AND, 37, this.ADDR_ZP, 2, 3),
            this.setOp(this.INS_AND, 53, this.ADDR_ZPX, 2, 4),
            this.setOp(this.INS_AND, 45, this.ADDR_ABS, 3, 4),
            this.setOp(this.INS_AND, 61, this.ADDR_ABSX, 3, 4),
            this.setOp(this.INS_AND, 57, this.ADDR_ABSY, 3, 4),
            this.setOp(this.INS_AND, 33, this.ADDR_PREIDXIND, 2, 6),
            this.setOp(this.INS_AND, 49, this.ADDR_POSTIDXIND, 2, 5),
            this.setOp(this.INS_ASL, 10, this.ADDR_ACC, 1, 2),
            this.setOp(this.INS_ASL, 6, this.ADDR_ZP, 2, 5),
            this.setOp(this.INS_ASL, 22, this.ADDR_ZPX, 2, 6),
            this.setOp(this.INS_ASL, 14, this.ADDR_ABS, 3, 6),
            this.setOp(this.INS_ASL, 30, this.ADDR_ABSX, 3, 7),
            this.setOp(this.INS_BCC, 144, this.ADDR_REL, 2, 2),
            this.setOp(this.INS_BCS, 176, this.ADDR_REL, 2, 2),
            this.setOp(this.INS_BEQ, 240, this.ADDR_REL, 2, 2),
            this.setOp(this.INS_BIT, 36, this.ADDR_ZP, 2, 3),
            this.setOp(this.INS_BIT, 44, this.ADDR_ABS, 3, 4),
            this.setOp(this.INS_BMI, 48, this.ADDR_REL, 2, 2),
            this.setOp(this.INS_BNE, 208, this.ADDR_REL, 2, 2),
            this.setOp(this.INS_BPL, 16, this.ADDR_REL, 2, 2),
            this.setOp(this.INS_BRK, 0, this.ADDR_IMP, 1, 7),
            this.setOp(this.INS_BVC, 80, this.ADDR_REL, 2, 2),
            this.setOp(this.INS_BVS, 112, this.ADDR_REL, 2, 2),
            this.setOp(this.INS_CLC, 24, this.ADDR_IMP, 1, 2),
            this.setOp(this.INS_CLD, 216, this.ADDR_IMP, 1, 2),
            this.setOp(this.INS_CLI, 88, this.ADDR_IMP, 1, 2),
            this.setOp(this.INS_CLV, 184, this.ADDR_IMP, 1, 2),
            this.setOp(this.INS_CMP, 201, this.ADDR_IMM, 2, 2),
            this.setOp(this.INS_CMP, 197, this.ADDR_ZP, 2, 3),
            this.setOp(this.INS_CMP, 213, this.ADDR_ZPX, 2, 4),
            this.setOp(this.INS_CMP, 205, this.ADDR_ABS, 3, 4),
            this.setOp(this.INS_CMP, 221, this.ADDR_ABSX, 3, 4),
            this.setOp(this.INS_CMP, 217, this.ADDR_ABSY, 3, 4),
            this.setOp(this.INS_CMP, 193, this.ADDR_PREIDXIND, 2, 6),
            this.setOp(this.INS_CMP, 209, this.ADDR_POSTIDXIND, 2, 5),
            this.setOp(this.INS_CPX, 224, this.ADDR_IMM, 2, 2),
            this.setOp(this.INS_CPX, 228, this.ADDR_ZP, 2, 3),
            this.setOp(this.INS_CPX, 236, this.ADDR_ABS, 3, 4),
            this.setOp(this.INS_CPY, 192, this.ADDR_IMM, 2, 2),
            this.setOp(this.INS_CPY, 196, this.ADDR_ZP, 2, 3),
            this.setOp(this.INS_CPY, 204, this.ADDR_ABS, 3, 4),
            this.setOp(this.INS_DEC, 198, this.ADDR_ZP, 2, 5),
            this.setOp(this.INS_DEC, 214, this.ADDR_ZPX, 2, 6),
            this.setOp(this.INS_DEC, 206, this.ADDR_ABS, 3, 6),
            this.setOp(this.INS_DEC, 222, this.ADDR_ABSX, 3, 7),
            this.setOp(this.INS_DEX, 202, this.ADDR_IMP, 1, 2),
            this.setOp(this.INS_DEY, 136, this.ADDR_IMP, 1, 2),
            this.setOp(this.INS_EOR, 73, this.ADDR_IMM, 2, 2),
            this.setOp(this.INS_EOR, 69, this.ADDR_ZP, 2, 3),
            this.setOp(this.INS_EOR, 85, this.ADDR_ZPX, 2, 4),
            this.setOp(this.INS_EOR, 77, this.ADDR_ABS, 3, 4),
            this.setOp(this.INS_EOR, 93, this.ADDR_ABSX, 3, 4),
            this.setOp(this.INS_EOR, 89, this.ADDR_ABSY, 3, 4),
            this.setOp(this.INS_EOR, 65, this.ADDR_PREIDXIND, 2, 6),
            this.setOp(this.INS_EOR, 81, this.ADDR_POSTIDXIND, 2, 5),
            this.setOp(this.INS_INC, 230, this.ADDR_ZP, 2, 5),
            this.setOp(this.INS_INC, 246, this.ADDR_ZPX, 2, 6),
            this.setOp(this.INS_INC, 238, this.ADDR_ABS, 3, 6),
            this.setOp(this.INS_INC, 254, this.ADDR_ABSX, 3, 7),
            this.setOp(this.INS_INX, 232, this.ADDR_IMP, 1, 2),
            this.setOp(this.INS_INY, 200, this.ADDR_IMP, 1, 2),
            this.setOp(this.INS_JMP, 76, this.ADDR_ABS, 3, 3),
            this.setOp(this.INS_JMP, 108, this.ADDR_INDABS, 3, 5),
            this.setOp(this.INS_JSR, 32, this.ADDR_ABS, 3, 6),
            this.setOp(this.INS_LDA, 169, this.ADDR_IMM, 2, 2),
            this.setOp(this.INS_LDA, 165, this.ADDR_ZP, 2, 3),
            this.setOp(this.INS_LDA, 181, this.ADDR_ZPX, 2, 4),
            this.setOp(this.INS_LDA, 173, this.ADDR_ABS, 3, 4),
            this.setOp(this.INS_LDA, 189, this.ADDR_ABSX, 3, 4),
            this.setOp(this.INS_LDA, 185, this.ADDR_ABSY, 3, 4),
            this.setOp(this.INS_LDA, 161, this.ADDR_PREIDXIND, 2, 6),
            this.setOp(this.INS_LDA, 177, this.ADDR_POSTIDXIND, 2, 5),
            this.setOp(this.INS_LDX, 162, this.ADDR_IMM, 2, 2),
            this.setOp(this.INS_LDX, 166, this.ADDR_ZP, 2, 3),
            this.setOp(this.INS_LDX, 182, this.ADDR_ZPY, 2, 4),
            this.setOp(this.INS_LDX, 174, this.ADDR_ABS, 3, 4),
            this.setOp(this.INS_LDX, 190, this.ADDR_ABSY, 3, 4),
            this.setOp(this.INS_LDY, 160, this.ADDR_IMM, 2, 2),
            this.setOp(this.INS_LDY, 164, this.ADDR_ZP, 2, 3),
            this.setOp(this.INS_LDY, 180, this.ADDR_ZPX, 2, 4),
            this.setOp(this.INS_LDY, 172, this.ADDR_ABS, 3, 4),
            this.setOp(this.INS_LDY, 188, this.ADDR_ABSX, 3, 4),
            this.setOp(this.INS_LSR, 74, this.ADDR_ACC, 1, 2),
            this.setOp(this.INS_LSR, 70, this.ADDR_ZP, 2, 5),
            this.setOp(this.INS_LSR, 86, this.ADDR_ZPX, 2, 6),
            this.setOp(this.INS_LSR, 78, this.ADDR_ABS, 3, 6),
            this.setOp(this.INS_LSR, 94, this.ADDR_ABSX, 3, 7),
            this.setOp(this.INS_NOP, 26, this.ADDR_IMP, 1, 2),
            this.setOp(this.INS_NOP, 58, this.ADDR_IMP, 1, 2),
            this.setOp(this.INS_NOP, 90, this.ADDR_IMP, 1, 2),
            this.setOp(this.INS_NOP, 122, this.ADDR_IMP, 1, 2),
            this.setOp(this.INS_NOP, 218, this.ADDR_IMP, 1, 2),
            this.setOp(this.INS_NOP, 234, this.ADDR_IMP, 1, 2),
            this.setOp(this.INS_NOP, 250, this.ADDR_IMP, 1, 2),
            this.setOp(this.INS_ORA, 9, this.ADDR_IMM, 2, 2),
            this.setOp(this.INS_ORA, 5, this.ADDR_ZP, 2, 3),
            this.setOp(this.INS_ORA, 21, this.ADDR_ZPX, 2, 4),
            this.setOp(this.INS_ORA, 13, this.ADDR_ABS, 3, 4),
            this.setOp(this.INS_ORA, 29, this.ADDR_ABSX, 3, 4),
            this.setOp(this.INS_ORA, 25, this.ADDR_ABSY, 3, 4),
            this.setOp(this.INS_ORA, 1, this.ADDR_PREIDXIND, 2, 6),
            this.setOp(this.INS_ORA, 17, this.ADDR_POSTIDXIND, 2, 5),
            this.setOp(this.INS_PHA, 72, this.ADDR_IMP, 1, 3),
            this.setOp(this.INS_PHP, 8, this.ADDR_IMP, 1, 3),
            this.setOp(this.INS_PLA, 104, this.ADDR_IMP, 1, 4),
            this.setOp(this.INS_PLP, 40, this.ADDR_IMP, 1, 4),
            this.setOp(this.INS_ROL, 42, this.ADDR_ACC, 1, 2),
            this.setOp(this.INS_ROL, 38, this.ADDR_ZP, 2, 5),
            this.setOp(this.INS_ROL, 54, this.ADDR_ZPX, 2, 6),
            this.setOp(this.INS_ROL, 46, this.ADDR_ABS, 3, 6),
            this.setOp(this.INS_ROL, 62, this.ADDR_ABSX, 3, 7),
            this.setOp(this.INS_ROR, 106, this.ADDR_ACC, 1, 2),
            this.setOp(this.INS_ROR, 102, this.ADDR_ZP, 2, 5),
            this.setOp(this.INS_ROR, 118, this.ADDR_ZPX, 2, 6),
            this.setOp(this.INS_ROR, 110, this.ADDR_ABS, 3, 6),
            this.setOp(this.INS_ROR, 126, this.ADDR_ABSX, 3, 7),
            this.setOp(this.INS_RTI, 64, this.ADDR_IMP, 1, 6),
            this.setOp(this.INS_RTS, 96, this.ADDR_IMP, 1, 6),
            this.setOp(this.INS_SBC, 233, this.ADDR_IMM, 2, 2),
            this.setOp(this.INS_SBC, 229, this.ADDR_ZP, 2, 3),
            this.setOp(this.INS_SBC, 245, this.ADDR_ZPX, 2, 4),
            this.setOp(this.INS_SBC, 237, this.ADDR_ABS, 3, 4),
            this.setOp(this.INS_SBC, 253, this.ADDR_ABSX, 3, 4),
            this.setOp(this.INS_SBC, 249, this.ADDR_ABSY, 3, 4),
            this.setOp(this.INS_SBC, 225, this.ADDR_PREIDXIND, 2, 6),
            this.setOp(this.INS_SBC, 241, this.ADDR_POSTIDXIND, 2, 5),
            this.setOp(this.INS_SEC, 56, this.ADDR_IMP, 1, 2),
            this.setOp(this.INS_SED, 248, this.ADDR_IMP, 1, 2),
            this.setOp(this.INS_SEI, 120, this.ADDR_IMP, 1, 2),
            this.setOp(this.INS_STA, 133, this.ADDR_ZP, 2, 3),
            this.setOp(this.INS_STA, 149, this.ADDR_ZPX, 2, 4),
            this.setOp(this.INS_STA, 141, this.ADDR_ABS, 3, 4),
            this.setOp(this.INS_STA, 157, this.ADDR_ABSX, 3, 5),
            this.setOp(this.INS_STA, 153, this.ADDR_ABSY, 3, 5),
            this.setOp(this.INS_STA, 129, this.ADDR_PREIDXIND, 2, 6),
            this.setOp(this.INS_STA, 145, this.ADDR_POSTIDXIND, 2, 6),
            this.setOp(this.INS_STX, 134, this.ADDR_ZP, 2, 3),
            this.setOp(this.INS_STX, 150, this.ADDR_ZPY, 2, 4),
            this.setOp(this.INS_STX, 142, this.ADDR_ABS, 3, 4),
            this.setOp(this.INS_STY, 132, this.ADDR_ZP, 2, 3),
            this.setOp(this.INS_STY, 148, this.ADDR_ZPX, 2, 4),
            this.setOp(this.INS_STY, 140, this.ADDR_ABS, 3, 4),
            this.setOp(this.INS_TAX, 170, this.ADDR_IMP, 1, 2),
            this.setOp(this.INS_TAY, 168, this.ADDR_IMP, 1, 2),
            this.setOp(this.INS_TSX, 186, this.ADDR_IMP, 1, 2),
            this.setOp(this.INS_TXA, 138, this.ADDR_IMP, 1, 2),
            this.setOp(this.INS_TXS, 154, this.ADDR_IMP, 1, 2),
            this.setOp(this.INS_TYA, 152, this.ADDR_IMP, 1, 2),
            this.setOp(this.INS_ALR, 75, this.ADDR_IMM, 2, 2),
            this.setOp(this.INS_ANC, 11, this.ADDR_IMM, 2, 2),
            this.setOp(this.INS_ANC, 43, this.ADDR_IMM, 2, 2),
            this.setOp(this.INS_ARR, 107, this.ADDR_IMM, 2, 2),
            this.setOp(this.INS_AXS, 203, this.ADDR_IMM, 2, 2),
            this.setOp(this.INS_LAX, 163, this.ADDR_PREIDXIND, 2, 6),
            this.setOp(this.INS_LAX, 167, this.ADDR_ZP, 2, 3),
            this.setOp(this.INS_LAX, 175, this.ADDR_ABS, 3, 4),
            this.setOp(this.INS_LAX, 179, this.ADDR_POSTIDXIND, 2, 5),
            this.setOp(this.INS_LAX, 183, this.ADDR_ZPY, 2, 4),
            this.setOp(this.INS_LAX, 191, this.ADDR_ABSY, 3, 4),
            this.setOp(this.INS_SAX, 131, this.ADDR_PREIDXIND, 2, 6),
            this.setOp(this.INS_SAX, 135, this.ADDR_ZP, 2, 3),
            this.setOp(this.INS_SAX, 143, this.ADDR_ABS, 3, 4),
            this.setOp(this.INS_SAX, 151, this.ADDR_ZPY, 2, 4),
            this.setOp(this.INS_DCP, 195, this.ADDR_PREIDXIND, 2, 8),
            this.setOp(this.INS_DCP, 199, this.ADDR_ZP, 2, 5),
            this.setOp(this.INS_DCP, 207, this.ADDR_ABS, 3, 6),
            this.setOp(this.INS_DCP, 211, this.ADDR_POSTIDXIND, 2, 8),
            this.setOp(this.INS_DCP, 215, this.ADDR_ZPX, 2, 6),
            this.setOp(this.INS_DCP, 219, this.ADDR_ABSY, 3, 7),
            this.setOp(this.INS_DCP, 223, this.ADDR_ABSX, 3, 7),
            this.setOp(this.INS_ISC, 227, this.ADDR_PREIDXIND, 2, 8),
            this.setOp(this.INS_ISC, 231, this.ADDR_ZP, 2, 5),
            this.setOp(this.INS_ISC, 239, this.ADDR_ABS, 3, 6),
            this.setOp(this.INS_ISC, 243, this.ADDR_POSTIDXIND, 2, 8),
            this.setOp(this.INS_ISC, 247, this.ADDR_ZPX, 2, 6),
            this.setOp(this.INS_ISC, 251, this.ADDR_ABSY, 3, 7),
            this.setOp(this.INS_ISC, 255, this.ADDR_ABSX, 3, 7),
            this.setOp(this.INS_RLA, 35, this.ADDR_PREIDXIND, 2, 8),
            this.setOp(this.INS_RLA, 39, this.ADDR_ZP, 2, 5),
            this.setOp(this.INS_RLA, 47, this.ADDR_ABS, 3, 6),
            this.setOp(this.INS_RLA, 51, this.ADDR_POSTIDXIND, 2, 8),
            this.setOp(this.INS_RLA, 55, this.ADDR_ZPX, 2, 6),
            this.setOp(this.INS_RLA, 59, this.ADDR_ABSY, 3, 7),
            this.setOp(this.INS_RLA, 63, this.ADDR_ABSX, 3, 7),
            this.setOp(this.INS_RRA, 99, this.ADDR_PREIDXIND, 2, 8),
            this.setOp(this.INS_RRA, 103, this.ADDR_ZP, 2, 5),
            this.setOp(this.INS_RRA, 111, this.ADDR_ABS, 3, 6),
            this.setOp(this.INS_RRA, 115, this.ADDR_POSTIDXIND, 2, 8),
            this.setOp(this.INS_RRA, 119, this.ADDR_ZPX, 2, 6),
            this.setOp(this.INS_RRA, 123, this.ADDR_ABSY, 3, 7),
            this.setOp(this.INS_RRA, 127, this.ADDR_ABSX, 3, 7);
          this.setOp(this.INS_SLO, 3, this.ADDR_PREIDXIND, 2, 8),
            this.setOp(this.INS_SLO, 7, this.ADDR_ZP, 2, 5),
            this.setOp(this.INS_SLO, 15, this.ADDR_ABS, 3, 6),
            this.setOp(this.INS_SLO, 19, this.ADDR_POSTIDXIND, 2, 8),
            this.setOp(this.INS_SLO, 23, this.ADDR_ZPX, 2, 6),
            this.setOp(this.INS_SLO, 27, this.ADDR_ABSY, 3, 7),
            this.setOp(this.INS_SLO, 31, this.ADDR_ABSX, 3, 7),
            this.setOp(this.INS_SRE, 67, this.ADDR_PREIDXIND, 2, 8),
            this.setOp(this.INS_SRE, 71, this.ADDR_ZP, 2, 5),
            this.setOp(this.INS_SRE, 79, this.ADDR_ABS, 3, 6),
            this.setOp(this.INS_SRE, 83, this.ADDR_POSTIDXIND, 2, 8),
            this.setOp(this.INS_SRE, 87, this.ADDR_ZPX, 2, 6),
            this.setOp(this.INS_SRE, 91, this.ADDR_ABSY, 3, 7),
            this.setOp(this.INS_SRE, 95, this.ADDR_ABSX, 3, 7),
            this.setOp(this.INS_SKB, 128, this.ADDR_IMM, 2, 2),
            this.setOp(this.INS_SKB, 130, this.ADDR_IMM, 2, 2),
            this.setOp(this.INS_SKB, 137, this.ADDR_IMM, 2, 2),
            this.setOp(this.INS_SKB, 194, this.ADDR_IMM, 2, 2),
            this.setOp(this.INS_SKB, 226, this.ADDR_IMM, 2, 2),
            this.setOp(this.INS_IGN, 12, this.ADDR_ABS, 3, 4),
            this.setOp(this.INS_IGN, 28, this.ADDR_ABSX, 3, 4),
            this.setOp(this.INS_IGN, 60, this.ADDR_ABSX, 3, 4),
            this.setOp(this.INS_IGN, 92, this.ADDR_ABSX, 3, 4),
            this.setOp(this.INS_IGN, 124, this.ADDR_ABSX, 3, 4),
            this.setOp(this.INS_IGN, 220, this.ADDR_ABSX, 3, 4),
            this.setOp(this.INS_IGN, 252, this.ADDR_ABSX, 3, 4),
            this.setOp(this.INS_IGN, 4, this.ADDR_ZP, 2, 3),
            this.setOp(this.INS_IGN, 68, this.ADDR_ZP, 2, 3),
            this.setOp(this.INS_IGN, 100, this.ADDR_ZP, 2, 3),
            this.setOp(this.INS_IGN, 20, this.ADDR_ZPX, 2, 4),
            this.setOp(this.INS_IGN, 52, this.ADDR_ZPX, 2, 4),
            this.setOp(this.INS_IGN, 84, this.ADDR_ZPX, 2, 4),
            this.setOp(this.INS_IGN, 116, this.ADDR_ZPX, 2, 4),
            this.setOp(this.INS_IGN, 212, this.ADDR_ZPX, 2, 4),
            this.setOp(this.INS_IGN, 244, this.ADDR_ZPX, 2, 4),
            (this.cycTable = new Array(
              7,
              6,
              2,
              8,
              3,
              3,
              5,
              5,
              3,
              2,
              2,
              2,
              4,
              4,
              6,
              6,
              2,
              5,
              2,
              8,
              4,
              4,
              6,
              6,
              2,
              4,
              2,
              7,
              4,
              4,
              7,
              7,
              6,
              6,
              2,
              8,
              3,
              3,
              5,
              5,
              4,
              2,
              2,
              2,
              4,
              4,
              6,
              6,
              2,
              5,
              2,
              8,
              4,
              4,
              6,
              6,
              2,
              4,
              2,
              7,
              4,
              4,
              7,
              7,
              6,
              6,
              2,
              8,
              3,
              3,
              5,
              5,
              3,
              2,
              2,
              2,
              3,
              4,
              6,
              6,
              2,
              5,
              2,
              8,
              4,
              4,
              6,
              6,
              2,
              4,
              2,
              7,
              4,
              4,
              7,
              7,
              6,
              6,
              2,
              8,
              3,
              3,
              5,
              5,
              4,
              2,
              2,
              2,
              5,
              4,
              6,
              6,
              2,
              5,
              2,
              8,
              4,
              4,
              6,
              6,
              2,
              4,
              2,
              7,
              4,
              4,
              7,
              7,
              2,
              6,
              2,
              6,
              3,
              3,
              3,
              3,
              2,
              2,
              2,
              2,
              4,
              4,
              4,
              4,
              2,
              6,
              2,
              6,
              4,
              4,
              4,
              4,
              2,
              5,
              2,
              5,
              5,
              5,
              5,
              5,
              2,
              6,
              2,
              6,
              3,
              3,
              3,
              3,
              2,
              2,
              2,
              2,
              4,
              4,
              4,
              4,
              2,
              5,
              2,
              5,
              4,
              4,
              4,
              4,
              2,
              4,
              2,
              4,
              4,
              4,
              4,
              4,
              2,
              6,
              2,
              8,
              3,
              3,
              5,
              5,
              2,
              2,
              2,
              2,
              4,
              4,
              6,
              6,
              2,
              5,
              2,
              8,
              4,
              4,
              6,
              6,
              2,
              4,
              2,
              7,
              4,
              4,
              7,
              7,
              2,
              6,
              3,
              8,
              3,
              3,
              5,
              5,
              2,
              2,
              2,
              2,
              4,
              4,
              6,
              6,
              2,
              5,
              2,
              8,
              4,
              4,
              6,
              6,
              2,
              4,
              2,
              7,
              4,
              4,
              7,
              7
            )),
            (this.instname = new Array(70)),
            (this.instname[0] = "ADC"),
            (this.instname[1] = "AND"),
            (this.instname[2] = "ASL"),
            (this.instname[3] = "BCC"),
            (this.instname[4] = "BCS"),
            (this.instname[5] = "BEQ"),
            (this.instname[6] = "BIT"),
            (this.instname[7] = "BMI"),
            (this.instname[8] = "BNE"),
            (this.instname[9] = "BPL"),
            (this.instname[10] = "BRK"),
            (this.instname[11] = "BVC"),
            (this.instname[12] = "BVS"),
            (this.instname[13] = "CLC"),
            (this.instname[14] = "CLD"),
            (this.instname[15] = "CLI"),
            (this.instname[16] = "CLV"),
            (this.instname[17] = "CMP"),
            (this.instname[18] = "CPX"),
            (this.instname[19] = "CPY"),
            (this.instname[20] = "DEC"),
            (this.instname[21] = "DEX"),
            (this.instname[22] = "DEY"),
            (this.instname[23] = "EOR"),
            (this.instname[24] = "INC"),
            (this.instname[25] = "INX"),
            (this.instname[26] = "INY"),
            (this.instname[27] = "JMP"),
            (this.instname[28] = "JSR"),
            (this.instname[29] = "LDA"),
            (this.instname[30] = "LDX"),
            (this.instname[31] = "LDY"),
            (this.instname[32] = "LSR"),
            (this.instname[33] = "NOP"),
            (this.instname[34] = "ORA"),
            (this.instname[35] = "PHA"),
            (this.instname[36] = "PHP"),
            (this.instname[37] = "PLA"),
            (this.instname[38] = "PLP"),
            (this.instname[39] = "ROL"),
            (this.instname[40] = "ROR"),
            (this.instname[41] = "RTI"),
            (this.instname[42] = "RTS"),
            (this.instname[43] = "SBC"),
            (this.instname[44] = "SEC"),
            (this.instname[45] = "SED"),
            (this.instname[46] = "SEI"),
            (this.instname[47] = "STA"),
            (this.instname[48] = "STX"),
            (this.instname[49] = "STY"),
            (this.instname[50] = "TAX"),
            (this.instname[51] = "TAY"),
            (this.instname[52] = "TSX"),
            (this.instname[53] = "TXA"),
            (this.instname[54] = "TXS"),
            (this.instname[55] = "TYA"),
            (this.instname[56] = "ALR"),
            (this.instname[57] = "ANC"),
            (this.instname[58] = "ARR"),
            (this.instname[59] = "AXS"),
            (this.instname[60] = "LAX"),
            (this.instname[61] = "SAX"),
            (this.instname[62] = "DCP"),
            (this.instname[63] = "ISC"),
            (this.instname[64] = "RLA"),
            (this.instname[65] = "RRA"),
            (this.instname[66] = "SLO"),
            (this.instname[67] = "SRE"),
            (this.instname[68] = "SKB"),
            (this.instname[69] = "IGN"),
            (this.addrDesc = new Array(
              "Zero Page           ",
              "Relative            ",
              "Implied             ",
              "Absolute            ",
              "Accumulator         ",
              "Immediate           ",
              "Zero Page,X         ",
              "Zero Page,Y         ",
              "Absolute,X          ",
              "Absolute,Y          ",
              "Preindexed Indirect ",
              "Postindexed Indirect",
              "Indirect Absolute   "
            ));
        };
        (r.prototype = {
          INS_ADC: 0,
          INS_AND: 1,
          INS_ASL: 2,
          INS_BCC: 3,
          INS_BCS: 4,
          INS_BEQ: 5,
          INS_BIT: 6,
          INS_BMI: 7,
          INS_BNE: 8,
          INS_BPL: 9,
          INS_BRK: 10,
          INS_BVC: 11,
          INS_BVS: 12,
          INS_CLC: 13,
          INS_CLD: 14,
          INS_CLI: 15,
          INS_CLV: 16,
          INS_CMP: 17,
          INS_CPX: 18,
          INS_CPY: 19,
          INS_DEC: 20,
          INS_DEX: 21,
          INS_DEY: 22,
          INS_EOR: 23,
          INS_INC: 24,
          INS_INX: 25,
          INS_INY: 26,
          INS_JMP: 27,
          INS_JSR: 28,
          INS_LDA: 29,
          INS_LDX: 30,
          INS_LDY: 31,
          INS_LSR: 32,
          INS_NOP: 33,
          INS_ORA: 34,
          INS_PHA: 35,
          INS_PHP: 36,
          INS_PLA: 37,
          INS_PLP: 38,
          INS_ROL: 39,
          INS_ROR: 40,
          INS_RTI: 41,
          INS_RTS: 42,
          INS_SBC: 43,
          INS_SEC: 44,
          INS_SED: 45,
          INS_SEI: 46,
          INS_STA: 47,
          INS_STX: 48,
          INS_STY: 49,
          INS_TAX: 50,
          INS_TAY: 51,
          INS_TSX: 52,
          INS_TXA: 53,
          INS_TXS: 54,
          INS_TYA: 55,
          INS_ALR: 56,
          INS_ANC: 57,
          INS_ARR: 58,
          INS_AXS: 59,
          INS_LAX: 60,
          INS_SAX: 61,
          INS_DCP: 62,
          INS_ISC: 63,
          INS_RLA: 64,
          INS_RRA: 65,
          INS_SLO: 66,
          INS_SRE: 67,
          INS_SKB: 68,
          INS_IGN: 69,
          INS_DUMMY: 70,
          ADDR_ZP: 0,
          ADDR_REL: 1,
          ADDR_IMP: 2,
          ADDR_ABS: 3,
          ADDR_ACC: 4,
          ADDR_IMM: 5,
          ADDR_ZPX: 6,
          ADDR_ZPY: 7,
          ADDR_ABSX: 8,
          ADDR_ABSY: 9,
          ADDR_PREIDXIND: 10,
          ADDR_POSTIDXIND: 11,
          ADDR_INDABS: 12,
          setOp: function (t, s, i, e, h) {
            this.opdata[s] =
              (255 & t) |
              ((255 & i) << 8) |
              ((255 & e) << 16) |
              ((255 & h) << 24);
          },
        }),
          (t.exports = h);
      },
      function (t, s, i) {
        var e = i(2),
          h = i(0),
          r = function (t) {
            (this.nes = t),
              (this.vramMem = null),
              (this.spriteMem = null),
              (this.vramAddress = null),
              (this.vramTmpAddress = null),
              (this.vramBufferedReadValue = null),
              (this.firstWrite = null),
              (this.sramAddress = null),
              (this.currentMirroring = null),
              (this.requestEndFrame = null),
              (this.nmiOk = null),
              (this.dummyCycleToggle = null),
              (this.validTileData = null),
              (this.nmiCounter = null),
              (this.scanlineAlreadyRendered = null),
              (this.f_nmiOnVblank = null),
              (this.f_spriteSize = null),
              (this.f_bgPatternTable = null),
              (this.f_spPatternTable = null),
              (this.f_addrInc = null),
              (this.f_nTblAddress = null),
              (this.f_color = null),
              (this.f_spVisibility = null),
              (this.f_bgVisibility = null),
              (this.f_spClipping = null),
              (this.f_bgClipping = null),
              (this.f_dispType = null),
              (this.cntFV = null),
              (this.cntV = null),
              (this.cntH = null),
              (this.cntVT = null),
              (this.cntHT = null),
              (this.regFV = null),
              (this.regV = null),
              (this.regH = null),
              (this.regVT = null),
              (this.regHT = null),
              (this.regFH = null),
              (this.regS = null),
              (this.curNt = null),
              (this.attrib = null),
              (this.buffer = null),
              (this.bgbuffer = null),
              (this.pixrendered = null),
              (this.validTileData = null),
              (this.scantile = null),
              (this.scanline = null),
              (this.lastRenderedScanline = null),
              (this.curX = null),
              (this.sprX = null),
              (this.sprY = null),
              (this.sprTile = null),
              (this.sprCol = null),
              (this.vertFlip = null),
              (this.horiFlip = null),
              (this.bgPriority = null),
              (this.spr0HitX = null),
              (this.spr0HitY = null),
              (this.hitSpr0 = null),
              (this.sprPalette = null),
              (this.imgPalette = null),
              (this.ptTile = null),
              (this.ntable1 = null),
              (this.currentMirroring = null),
              (this.nameTable = null),
              (this.vramMirrorTable = null),
              (this.palTable = null),
              (this.showSpr0Hit = !1),
              (this.clipToTvSize = !0),
              this.reset();
          };
        r.prototype = {
          STATUS_VRAMWRITE: 4,
          STATUS_SLSPRITECOUNT: 5,
          STATUS_SPRITE0HIT: 6,
          STATUS_VBLANK: 7,
          reset: function () {
            var t;
            for (
              this.vramMem = new Array(32768),
              this.spriteMem = new Array(256),
              t = 0;
              t < this.vramMem.length;
              t++
            )
              this.vramMem[t] = 0;
            for (t = 0; t < this.spriteMem.length; t++) this.spriteMem[t] = 0;
            for (
              this.vramAddress = null,
              this.vramTmpAddress = null,
              this.vramBufferedReadValue = 0,
              this.firstWrite = !0,
              this.sramAddress = 0,
              this.currentMirroring = -1,
              this.requestEndFrame = !1,
              this.nmiOk = !1,
              this.dummyCycleToggle = !1,
              this.validTileData = !1,
              this.nmiCounter = 0,
              this.scanlineAlreadyRendered = null,
              this.f_nmiOnVblank = 0,
              this.f_spriteSize = 0,
              this.f_bgPatternTable = 0,
              this.f_spPatternTable = 0,
              this.f_addrInc = 0,
              this.f_nTblAddress = 0,
              this.f_color = 0,
              this.f_spVisibility = 0,
              this.f_bgVisibility = 0,
              this.f_spClipping = 0,
              this.f_bgClipping = 0,
              this.f_dispType = 0,
              this.cntFV = 0,
              this.cntV = 0,
              this.cntH = 0,
              this.cntVT = 0,
              this.cntHT = 0,
              this.regFV = 0,
              this.regV = 0,
              this.regH = 0,
              this.regVT = 0,
              this.regHT = 0,
              this.regFH = 0,
              this.regS = 0,
              this.curNt = null,
              this.attrib = new Array(32),
              this.buffer = new Array(61440),
              this.bgbuffer = new Array(61440),
              this.pixrendered = new Array(61440),
              this.validTileData = null,
              this.scantile = new Array(32),
              this.scanline = 0,
              this.lastRenderedScanline = -1,
              this.curX = 0,
              this.sprX = new Array(64),
              this.sprY = new Array(64),
              this.sprTile = new Array(64),
              this.sprCol = new Array(64),
              this.vertFlip = new Array(64),
              this.horiFlip = new Array(64),
              this.bgPriority = new Array(64),
              this.spr0HitX = 0,
              this.spr0HitY = 0,
              this.hitSpr0 = !1,
              this.sprPalette = new Array(16),
              this.imgPalette = new Array(16),
              this.ptTile = new Array(512),
              t = 0;
              t < 512;
              t++
            )
              this.ptTile[t] = new e();
            for (
              this.ntable1 = new Array(4),
              this.currentMirroring = -1,
              this.nameTable = new Array(4),
              t = 0;
              t < 4;
              t++
            )
              this.nameTable[t] = new n(32, 32, "Nt" + t);
            for (
              this.vramMirrorTable = new Array(32768), t = 0;
              t < 32768;
              t++
            )
              this.vramMirrorTable[t] = t;
            (this.palTable = new a()),
              this.palTable.loadNTSCPalette(),
              this.updateControlReg1(0),
              this.updateControlReg2(0);
          },
          setMirroring: function (t) {
            if (t !== this.currentMirroring) {
              (this.currentMirroring = t),
                this.triggerRendering(),
                null === this.vramMirrorTable &&
                (this.vramMirrorTable = new Array(32768));
              for (var s = 0; s < 32768; s++) this.vramMirrorTable[s] = s;
              this.defineMirrorRegion(16160, 16128, 32),
                this.defineMirrorRegion(16192, 16128, 32),
                this.defineMirrorRegion(16256, 16128, 32),
                this.defineMirrorRegion(16320, 16128, 32),
                this.defineMirrorRegion(12288, 8192, 3840),
                this.defineMirrorRegion(16384, 0, 16384),
                t === this.nes.rom.HORIZONTAL_MIRRORING
                  ? ((this.ntable1[0] = 0),
                    (this.ntable1[1] = 0),
                    (this.ntable1[2] = 1),
                    (this.ntable1[3] = 1),
                    this.defineMirrorRegion(9216, 8192, 1024),
                    this.defineMirrorRegion(11264, 10240, 1024))
                  : t === this.nes.rom.VERTICAL_MIRRORING
                    ? ((this.ntable1[0] = 0),
                      (this.ntable1[1] = 1),
                      (this.ntable1[2] = 0),
                      (this.ntable1[3] = 1),
                      this.defineMirrorRegion(10240, 8192, 1024),
                      this.defineMirrorRegion(11264, 9216, 1024))
                    : t === this.nes.rom.SINGLESCREEN_MIRRORING
                      ? ((this.ntable1[0] = 0),
                        (this.ntable1[1] = 0),
                        (this.ntable1[2] = 0),
                        (this.ntable1[3] = 0),
                        this.defineMirrorRegion(9216, 8192, 1024),
                        this.defineMirrorRegion(10240, 8192, 1024),
                        this.defineMirrorRegion(11264, 8192, 1024))
                      : t === this.nes.rom.SINGLESCREEN_MIRRORING2
                        ? ((this.ntable1[0] = 1),
                          (this.ntable1[1] = 1),
                          (this.ntable1[2] = 1),
                          (this.ntable1[3] = 1),
                          this.defineMirrorRegion(9216, 9216, 1024),
                          this.defineMirrorRegion(10240, 9216, 1024),
                          this.defineMirrorRegion(11264, 9216, 1024))
                        : ((this.ntable1[0] = 0),
                          (this.ntable1[1] = 1),
                          (this.ntable1[2] = 2),
                          (this.ntable1[3] = 3));
            }
          },
          defineMirrorRegion: function (t, s, i) {
            for (var e = 0; e < i; e++) this.vramMirrorTable[t + e] = s + e;
          },
          startVBlank: function () {
            this.nes.cpu.requestIrq(this.nes.cpu.IRQ_NMI),
              this.lastRenderedScanline < 239 &&
              this.renderFramePartially(
                this.lastRenderedScanline + 1,
                240 - this.lastRenderedScanline
              ),
              this.endFrame(),
              (this.lastRenderedScanline = -1);
          },
          endScanline: function () {
            switch (this.scanline) {
              case 19:
                this.dummyCycleToggle &&
                  ((this.curX = 1),
                    (this.dummyCycleToggle = !this.dummyCycleToggle));
                break;
              case 20:
                this.setStatusFlag(this.STATUS_VBLANK, !1),
                  this.setStatusFlag(this.STATUS_SPRITE0HIT, !1),
                  (this.hitSpr0 = !1),
                  (this.spr0HitX = -1),
                  (this.spr0HitY = -1),
                  (1 !== this.f_bgVisibility && 1 !== this.f_spVisibility) ||
                  ((this.cntFV = this.regFV),
                    (this.cntV = this.regV),
                    (this.cntH = this.regH),
                    (this.cntVT = this.regVT),
                    (this.cntHT = this.regHT),
                    1 === this.f_bgVisibility &&
                    this.renderBgScanline(!1, 0)),
                  1 === this.f_bgVisibility &&
                  1 === this.f_spVisibility &&
                  this.checkSprite0(0),
                  (1 !== this.f_bgVisibility && 1 !== this.f_spVisibility) ||
                  this.nes.mmap.clockIrqCounter();
                break;
              case 261:
                this.setStatusFlag(this.STATUS_VBLANK, !0),
                  (this.requestEndFrame = !0),
                  (this.nmiCounter = 9),
                  (this.scanline = -1);
                break;
              default:
                this.scanline >= 21 &&
                  this.scanline <= 260 &&
                  (1 === this.f_bgVisibility &&
                    (this.scanlineAlreadyRendered ||
                      ((this.cntHT = this.regHT),
                        (this.cntH = this.regH),
                        this.renderBgScanline(!0, this.scanline + 1 - 21)),
                      (this.scanlineAlreadyRendered = !1),
                      this.hitSpr0 ||
                      1 !== this.f_spVisibility ||
                      (this.sprX[0] >= -7 &&
                        this.sprX[0] < 256 &&
                        this.sprY[0] + 1 <= this.scanline - 20 &&
                        this.sprY[0] +
                        1 +
                        (0 === this.f_spriteSize ? 8 : 16) >=
                        this.scanline - 20 &&
                        this.checkSprite0(this.scanline - 20) &&
                        (this.hitSpr0 = !0))),
                    (1 !== this.f_bgVisibility && 1 !== this.f_spVisibility) ||
                    this.nes.mmap.clockIrqCounter());
            }
            this.scanline++, this.regsToAddress(), this.cntsToAddress();
          },
          startFrame: function () {
            var t = 0;
            if (0 === this.f_dispType) t = this.imgPalette[0];
            else
              switch (this.f_color) {
                case 0:
                  t = 0;
                  break;
                case 1:
                  t = 65280;
                  break;
                case 2:
                  t = 16711680;
                  break;
                case 3:
                  t = 0;
                  break;
                case 4:
                  t = 255;
                  break;
                default:
                  t = 0;
              }
            var s,
              i = this.buffer;
            for (s = 0; s < 61440; s++) i[s] = t;
            var e = this.pixrendered;
            for (s = 0; s < e.length; s++) e[s] = 65;
          },
          endFrame: function () {
            var t,
              s,
              i,
              e = this.buffer;
            if (this.showSpr0Hit) {
              if (
                this.sprX[0] >= 0 &&
                this.sprX[0] < 256 &&
                this.sprY[0] >= 0 &&
                this.sprY[0] < 240
              ) {
                for (t = 0; t < 256; t++)
                  e[(this.sprY[0] << 8) + t] = 16733525;
                for (t = 0; t < 240; t++)
                  e[(t << 8) + this.sprX[0]] = 16733525;
              }
              if (
                this.spr0HitX >= 0 &&
                this.spr0HitX < 256 &&
                this.spr0HitY >= 0 &&
                this.spr0HitY < 240
              ) {
                for (t = 0; t < 256; t++)
                  e[(this.spr0HitY << 8) + t] = 5635925;
                for (t = 0; t < 240; t++)
                  e[(t << 8) + this.spr0HitX] = 5635925;
              }
            }
            if (
              this.clipToTvSize ||
              0 === this.f_bgClipping ||
              0 === this.f_spClipping
            )
              for (i = 0; i < 240; i++)
                for (s = 0; s < 8; s++) e[(i << 8) + s] = 0;
            if (this.clipToTvSize)
              for (i = 0; i < 240; i++)
                for (s = 0; s < 8; s++) e[255 + (i << 8) - s] = 0;
            if (this.clipToTvSize)
              for (i = 0; i < 8; i++)
                for (s = 0; s < 256; s++)
                  (e[(i << 8) + s] = 0), (e[((239 - i) << 8) + s] = 0);
            this.nes.ui.writeFrame(e);
          },
          updateControlReg1: function (t) {
            this.triggerRendering(),
              (this.f_nmiOnVblank = (t >> 7) & 1),
              (this.f_spriteSize = (t >> 5) & 1),
              (this.f_bgPatternTable = (t >> 4) & 1),
              (this.f_spPatternTable = (t >> 3) & 1),
              (this.f_addrInc = (t >> 2) & 1),
              (this.f_nTblAddress = 3 & t),
              (this.regV = (t >> 1) & 1),
              (this.regH = 1 & t),
              (this.regS = (t >> 4) & 1);
          },
          updateControlReg2: function (t) {
            this.triggerRendering(),
              (this.f_color = (t >> 5) & 7),
              (this.f_spVisibility = (t >> 4) & 1),
              (this.f_bgVisibility = (t >> 3) & 1),
              (this.f_spClipping = (t >> 2) & 1),
              (this.f_bgClipping = (t >> 1) & 1),
              (this.f_dispType = 1 & t),
              0 === this.f_dispType &&
              this.palTable.setEmphasis(this.f_color),
              this.updatePalettes();
          },
          setStatusFlag: function (t, s) {
            var i = 1 << t;
            this.nes.cpu.mem[8194] =
              (this.nes.cpu.mem[8194] & (255 - i)) | (s ? i : 0);
          },
          readStatusRegister: function () {
            var t = this.nes.cpu.mem[8194];
            return (
              (this.firstWrite = !0),
              this.setStatusFlag(this.STATUS_VBLANK, !1),
              t
            );
          },
          writeSRAMAddress: function (t) {
            this.sramAddress = t;
          },
          sramLoad: function () {
            return this.spriteMem[this.sramAddress];
          },
          sramWrite: function (t) {
            (this.spriteMem[this.sramAddress] = t),
              this.spriteRamWriteUpdate(this.sramAddress, t),
              this.sramAddress++,
              (this.sramAddress %= 256);
          },
          scrollWrite: function (t) {
            this.triggerRendering(),
              this.firstWrite
                ? ((this.regHT = (t >> 3) & 31), (this.regFH = 7 & t))
                : ((this.regFV = 7 & t), (this.regVT = (t >> 3) & 31)),
              (this.firstWrite = !this.firstWrite);
          },
          writeVRAMAddress: function (t) {
            this.firstWrite
              ? ((this.regFV = (t >> 4) & 3),
                (this.regV = (t >> 3) & 1),
                (this.regH = (t >> 2) & 1),
                (this.regVT = (7 & this.regVT) | ((3 & t) << 3)))
              : (this.triggerRendering(),
                (this.regVT = (24 & this.regVT) | ((t >> 5) & 7)),
                (this.regHT = 31 & t),
                (this.cntFV = this.regFV),
                (this.cntV = this.regV),
                (this.cntH = this.regH),
                (this.cntVT = this.regVT),
                (this.cntHT = this.regHT),
                this.checkSprite0(this.scanline - 20)),
              (this.firstWrite = !this.firstWrite),
              this.cntsToAddress(),
              this.vramAddress < 8192 &&
              this.nes.mmap.latchAccess(this.vramAddress);
          },
          vramLoad: function () {
            var t;
            return (
              this.cntsToAddress(),
              this.regsToAddress(),
              this.vramAddress <= 16127
                ? ((t = this.vramBufferedReadValue),
                  this.vramAddress < 8192
                    ? (this.vramBufferedReadValue = this.vramMem[
                      this.vramAddress
                    ])
                    : (this.vramBufferedReadValue = this.mirroredLoad(
                      this.vramAddress
                    )),
                  this.vramAddress < 8192 &&
                  this.nes.mmap.latchAccess(this.vramAddress),
                  (this.vramAddress += 1 === this.f_addrInc ? 32 : 1),
                  this.cntsFromAddress(),
                  this.regsFromAddress(),
                  t)
                : ((t = this.mirroredLoad(this.vramAddress)),
                  (this.vramAddress += 1 === this.f_addrInc ? 32 : 1),
                  this.cntsFromAddress(),
                  this.regsFromAddress(),
                  t)
            );
          },
          vramWrite: function (t) {
            this.triggerRendering(),
              this.cntsToAddress(),
              this.regsToAddress(),
              this.vramAddress >= 8192
                ? this.mirroredWrite(this.vramAddress, t)
                : (this.writeMem(this.vramAddress, t),
                  this.nes.mmap.latchAccess(this.vramAddress)),
              (this.vramAddress += 1 === this.f_addrInc ? 32 : 1),
              this.regsFromAddress(),
              this.cntsFromAddress();
          },
          sramDMA: function (t) {
            for (var s, i = 256 * t, e = this.sramAddress; e < 256; e++)
              (s = this.nes.cpu.mem[i + e]),
                (this.spriteMem[e] = s),
                this.spriteRamWriteUpdate(e, s);
            this.nes.cpu.haltCycles(513);
          },
          regsFromAddress: function () {
            var t = (this.vramTmpAddress >> 8) & 255;
            (this.regFV = (t >> 4) & 7),
              (this.regV = (t >> 3) & 1),
              (this.regH = (t >> 2) & 1),
              (this.regVT = (7 & this.regVT) | ((3 & t) << 3)),
              (t = 255 & this.vramTmpAddress),
              (this.regVT = (24 & this.regVT) | ((t >> 5) & 7)),
              (this.regHT = 31 & t);
          },
          cntsFromAddress: function () {
            var t = (this.vramAddress >> 8) & 255;
            (this.cntFV = (t >> 4) & 3),
              (this.cntV = (t >> 3) & 1),
              (this.cntH = (t >> 2) & 1),
              (this.cntVT = (7 & this.cntVT) | ((3 & t) << 3)),
              (t = 255 & this.vramAddress),
              (this.cntVT = (24 & this.cntVT) | ((t >> 5) & 7)),
              (this.cntHT = 31 & t);
          },
          regsToAddress: function () {
            var t = (7 & this.regFV) << 4;
            (t |= (1 & this.regV) << 3),
              (t |= (1 & this.regH) << 2),
              (t |= (this.regVT >> 3) & 3);
            var s = (7 & this.regVT) << 5;
            (s |= 31 & this.regHT),
              (this.vramTmpAddress = 32767 & ((t << 8) | s));
          },
          cntsToAddress: function () {
            var t = (7 & this.cntFV) << 4;
            (t |= (1 & this.cntV) << 3),
              (t |= (1 & this.cntH) << 2),
              (t |= (this.cntVT >> 3) & 3);
            var s = (7 & this.cntVT) << 5;
            (s |= 31 & this.cntHT),
              (this.vramAddress = 32767 & ((t << 8) | s));
          },
          incTileCounter: function (t) {
            for (var s = t; 0 !== s; s--)
              32 === ++this.cntHT &&
                ((this.cntHT = 0),
                  ++this.cntVT >= 30 &&
                  2 === ++this.cntH &&
                  ((this.cntH = 0),
                    2 === ++this.cntV &&
                    ((this.cntV = 0), this.cntFV++, (this.cntFV &= 7))));
          },
          mirroredLoad: function (t) {
            return this.vramMem[this.vramMirrorTable[t]];
          },
          mirroredWrite: function (t, s) {
            if (t >= 16128 && t < 16160)
              16128 === t || 16144 === t
                ? (this.writeMem(16128, s), this.writeMem(16144, s))
                : 16132 === t || 16148 === t
                  ? (this.writeMem(16132, s), this.writeMem(16148, s))
                  : 16136 === t || 16152 === t
                    ? (this.writeMem(16136, s), this.writeMem(16152, s))
                    : 16140 === t || 16156 === t
                      ? (this.writeMem(16140, s), this.writeMem(16156, s))
                      : this.writeMem(t, s);
            else {
              if (!(t < this.vramMirrorTable.length))
                throw new Error("Invalid VRAM address: " + t.toString(16));
              this.writeMem(this.vramMirrorTable[t], s);
            }
          },
          triggerRendering: function () {
            this.scanline >= 21 &&
              this.scanline <= 260 &&
              (this.renderFramePartially(
                this.lastRenderedScanline + 1,
                this.scanline - 21 - this.lastRenderedScanline
              ),
                (this.lastRenderedScanline = this.scanline - 21));
          },
          renderFramePartially: function (t, s) {
            if (
              (1 === this.f_spVisibility &&
                this.renderSpritesPartially(t, s, !0),
                1 === this.f_bgVisibility)
            ) {
              var i = t << 8,
                e = (t + s) << 8;
              e > 61440 && (e = 61440);
              for (
                var h = this.buffer,
                r = this.bgbuffer,
                n = this.pixrendered,
                a = i;
                a < e;
                a++
              )
                n[a] > 255 && (h[a] = r[a]);
            }
            1 === this.f_spVisibility &&
              this.renderSpritesPartially(t, s, !1),
              (this.validTileData = !1);
          },
          renderBgScanline: function (t, s) {
            var i = 0 === this.regS ? 0 : 256,
              e = (s << 8) - this.regFH;
            if (
              ((this.curNt = this.ntable1[this.cntV + this.cntV + this.cntH]),
                (this.cntHT = this.regHT),
                (this.cntH = this.regH),
                (this.curNt = this.ntable1[this.cntV + this.cntV + this.cntH]),
                s < 240 && s - this.cntFV >= 0)
            ) {
              for (
                var h,
                r,
                n,
                a,
                o = this.cntFV << 3,
                l = this.scantile,
                p = this.attrib,
                u = this.ptTile,
                m = this.nameTable,
                R = this.imgPalette,
                c = this.pixrendered,
                _ = t ? this.bgbuffer : this.buffer,
                d = 0;
                d < 32;
                d++
              ) {
                if (s >= 0) {
                  if (this.validTileData) {
                    if (void 0 === (h = l[d])) continue;
                    (r = h.pix), (n = p[d]);
                  } else {
                    if (
                      void 0 ===
                      (h =
                        u[
                        i +
                        m[this.curNt].getTileIndex(this.cntHT, this.cntVT)
                        ])
                    )
                      continue;
                    (r = h.pix),
                      (n = m[this.curNt].getAttrib(this.cntHT, this.cntVT)),
                      (l[d] = h),
                      (p[d] = n);
                  }
                  var S = 0,
                    A = (d << 3) - this.regFH;
                  if (A > -8)
                    if ((A < 0 && ((e -= A), (S = -A)), h.opaque[this.cntFV]))
                      for (; S < 8; S++)
                        (_[e] = R[r[o + S] + n]), (c[e] |= 256), e++;
                    else
                      for (; S < 8; S++)
                        (a = r[o + S]),
                          0 !== a && ((_[e] = R[a + n]), (c[e] |= 256)),
                          e++;
                }
                32 == ++this.cntHT &&
                  ((this.cntHT = 0),
                    this.cntH++,
                    (this.cntH %= 2),
                    (this.curNt = this.ntable1[(this.cntV << 1) + this.cntH]));
              }
              this.validTileData = !0;
            }
            8 === ++this.cntFV &&
              ((this.cntFV = 0),
                this.cntVT++,
                30 === this.cntVT
                  ? ((this.cntVT = 0),
                    this.cntV++,
                    (this.cntV %= 2),
                    (this.curNt = this.ntable1[(this.cntV << 1) + this.cntH]))
                  : 32 === this.cntVT && (this.cntVT = 0),
                (this.validTileData = !1));
          },
          renderSpritesPartially: function (t, s, i) {
            if (1 === this.f_spVisibility)
              for (var e = 0; e < 64; e++)
                if (
                  this.bgPriority[e] === i &&
                  this.sprX[e] >= 0 &&
                  this.sprX[e] < 256 &&
                  this.sprY[e] + 8 >= t &&
                  this.sprY[e] < t + s
                )
                  if (0 === this.f_spriteSize)
                    (this.srcy1 = 0),
                      (this.srcy2 = 8),
                      this.sprY[e] < t && (this.srcy1 = t - this.sprY[e] - 1),
                      this.sprY[e] + 8 > t + s &&
                      (this.srcy2 = t + s - this.sprY[e] + 1),
                      0 === this.f_spPatternTable
                        ? this.ptTile[this.sprTile[e]].render(
                          this.buffer,
                          0,
                          this.srcy1,
                          8,
                          this.srcy2,
                          this.sprX[e],
                          this.sprY[e] + 1,
                          this.sprCol[e],
                          this.sprPalette,
                          this.horiFlip[e],
                          this.vertFlip[e],
                          e,
                          this.pixrendered
                        )
                        : this.ptTile[this.sprTile[e] + 256].render(
                          this.buffer,
                          0,
                          this.srcy1,
                          8,
                          this.srcy2,
                          this.sprX[e],
                          this.sprY[e] + 1,
                          this.sprCol[e],
                          this.sprPalette,
                          this.horiFlip[e],
                          this.vertFlip[e],
                          e,
                          this.pixrendered
                        );
                  else {
                    var h = this.sprTile[e];
                    0 != (1 & h) && (h = this.sprTile[e] - 1 + 256);
                    var r = 0,
                      n = 8;
                    this.sprY[e] < t && (r = t - this.sprY[e] - 1),
                      this.sprY[e] + 8 > t + s && (n = t + s - this.sprY[e]),
                      this.ptTile[h + (this.vertFlip[e] ? 1 : 0)].render(
                        this.buffer,
                        0,
                        r,
                        8,
                        n,
                        this.sprX[e],
                        this.sprY[e] + 1,
                        this.sprCol[e],
                        this.sprPalette,
                        this.horiFlip[e],
                        this.vertFlip[e],
                        e,
                        this.pixrendered
                      ),
                      (r = 0),
                      (n = 8),
                      this.sprY[e] + 8 < t &&
                      (r = t - (this.sprY[e] + 8 + 1)),
                      this.sprY[e] + 16 > t + s &&
                      (n = t + s - (this.sprY[e] + 8)),
                      this.ptTile[h + (this.vertFlip[e] ? 0 : 1)].render(
                        this.buffer,
                        0,
                        r,
                        8,
                        n,
                        this.sprX[e],
                        this.sprY[e] + 1 + 8,
                        this.sprCol[e],
                        this.sprPalette,
                        this.horiFlip[e],
                        this.vertFlip[e],
                        e,
                        this.pixrendered
                      );
                  }
          },
          checkSprite0: function (t) {
            (this.spr0HitX = -1), (this.spr0HitY = -1);
            var s,
              i,
              e,
              h,
              r,
              n,
              a = 0 === this.f_spPatternTable ? 0 : 256;
            if (
              ((i = this.sprX[0]),
                (e = this.sprY[0] + 1),
                0 === this.f_spriteSize)
            ) {
              if (e <= t && e + 8 > t && i >= -7 && i < 256)
                if (
                  ((h = this.ptTile[this.sprTile[0] + a]),
                    (s = this.vertFlip[0] ? 7 - (t - e) : t - e),
                    (s *= 8),
                    (n = 256 * t + i),
                    this.horiFlip[0])
                )
                  for (r = 7; r >= 0; r--) {
                    if (
                      i >= 0 &&
                      i < 256 &&
                      n >= 0 &&
                      n < 61440 &&
                      0 !== this.pixrendered[n] &&
                      0 !== h.pix[s + r]
                    )
                      return (
                        (this.spr0HitX = n % 256), (this.spr0HitY = t), !0
                      );
                    i++, n++;
                  }
                else
                  for (r = 0; r < 8; r++) {
                    if (
                      i >= 0 &&
                      i < 256 &&
                      n >= 0 &&
                      n < 61440 &&
                      0 !== this.pixrendered[n] &&
                      0 !== h.pix[s + r]
                    )
                      return (
                        (this.spr0HitX = n % 256), (this.spr0HitY = t), !0
                      );
                    i++, n++;
                  }
            } else if (e <= t && e + 16 > t && i >= -7 && i < 256)
              if (
                ((s = this.vertFlip[0] ? 15 - (t - e) : t - e),
                  s < 8
                    ? (h = this.ptTile[
                      this.sprTile[0] +
                      (this.vertFlip[0] ? 1 : 0) +
                      (0 != (1 & this.sprTile[0]) ? 255 : 0)
                    ])
                    : ((h = this.ptTile[
                      this.sprTile[0] +
                      (this.vertFlip[0] ? 0 : 1) +
                      (0 != (1 & this.sprTile[0]) ? 255 : 0)
                    ]),
                      this.vertFlip[0] ? (s = 15 - s) : (s -= 8)),
                  (s *= 8),
                  (n = 256 * t + i),
                  this.horiFlip[0])
              )
                for (r = 7; r >= 0; r--) {
                  if (
                    i >= 0 &&
                    i < 256 &&
                    n >= 0 &&
                    n < 61440 &&
                    0 !== this.pixrendered[n] &&
                    0 !== h.pix[s + r]
                  )
                    return (this.spr0HitX = n % 256), (this.spr0HitY = t), !0;
                  i++, n++;
                }
              else
                for (r = 0; r < 8; r++) {
                  if (
                    i >= 0 &&
                    i < 256 &&
                    n >= 0 &&
                    n < 61440 &&
                    0 !== this.pixrendered[n] &&
                    0 !== h.pix[s + r]
                  )
                    return (this.spr0HitX = n % 256), (this.spr0HitY = t), !0;
                  i++, n++;
                }
            return !1;
          },
          writeMem: function (t, s) {
            (this.vramMem[t] = s),
              t < 8192
                ? ((this.vramMem[t] = s), this.patternWrite(t, s))
                : t >= 8192 && t < 9152
                  ? this.nameTableWrite(this.ntable1[0], t - 8192, s)
                  : t >= 9152 && t < 9216
                    ? this.attribTableWrite(this.ntable1[0], t - 9152, s)
                    : t >= 9216 && t < 10176
                      ? this.nameTableWrite(this.ntable1[1], t - 9216, s)
                      : t >= 10176 && t < 10240
                        ? this.attribTableWrite(this.ntable1[1], t - 10176, s)
                        : t >= 10240 && t < 11200
                          ? this.nameTableWrite(this.ntable1[2], t - 10240, s)
                          : t >= 11200 && t < 11264
                            ? this.attribTableWrite(this.ntable1[2], t - 11200, s)
                            : t >= 11264 && t < 12224
                              ? this.nameTableWrite(this.ntable1[3], t - 11264, s)
                              : t >= 12224 && t < 12288
                                ? this.attribTableWrite(this.ntable1[3], t - 12224, s)
                                : t >= 16128 && t < 16160 && this.updatePalettes();
          },
          updatePalettes: function () {
            var t;
            for (t = 0; t < 16; t++)
              0 === this.f_dispType
                ? (this.imgPalette[t] = this.palTable.getEntry(
                  63 & this.vramMem[16128 + t]
                ))
                : (this.imgPalette[t] = this.palTable.getEntry(
                  32 & this.vramMem[16128 + t]
                ));
            for (t = 0; t < 16; t++)
              0 === this.f_dispType
                ? (this.sprPalette[t] = this.palTable.getEntry(
                  63 & this.vramMem[16144 + t]
                ))
                : (this.sprPalette[t] = this.palTable.getEntry(
                  32 & this.vramMem[16144 + t]
                ));
          },
          patternWrite: function (t, s) {
            var i = Math.floor(t / 16),
              e = t % 16;
            e < 8
              ? this.ptTile[i].setScanline(e, s, this.vramMem[t + 8])
              : this.ptTile[i].setScanline(e - 8, this.vramMem[t - 8], s);
          },
          nameTableWrite: function (t, s, i) {
            (this.nameTable[t].tile[s] = i),
              this.checkSprite0(this.scanline - 20);
          },
          attribTableWrite: function (t, s, i) {
            this.nameTable[t].writeAttrib(s, i);
          },
          spriteRamWriteUpdate: function (t, s) {
            var i = Math.floor(t / 4);
            0 === i && this.checkSprite0(this.scanline - 20),
              t % 4 == 0
                ? (this.sprY[i] = s)
                : t % 4 == 1
                  ? (this.sprTile[i] = s)
                  : t % 4 == 2
                    ? ((this.vertFlip[i] = 0 != (128 & s)),
                      (this.horiFlip[i] = 0 != (64 & s)),
                      (this.bgPriority[i] = 0 != (32 & s)),
                      (this.sprCol[i] = (3 & s) << 2))
                    : t % 4 == 3 && (this.sprX[i] = s);
          },
          doNMI: function () {
            this.setStatusFlag(this.STATUS_VBLANK, !0),
              this.nes.cpu.requestIrq(this.nes.cpu.IRQ_NMI);
          },
          isPixelWhite: function (t, s) {
            return (
              this.triggerRendering(),
              16777215 === this.nes.ppu.buffer[(s << 8) + t]
            );
          },
          JSON_PROPERTIES: [
            "vramMem",
            "spriteMem",
            "cntFV",
            "cntV",
            "cntH",
            "cntVT",
            "cntHT",
            "regFV",
            "regV",
            "regH",
            "regVT",
            "regHT",
            "regFH",
            "regS",
            "vramAddress",
            "vramTmpAddress",
            "f_nmiOnVblank",
            "f_spriteSize",
            "f_bgPatternTable",
            "f_spPatternTable",
            "f_addrInc",
            "f_nTblAddress",
            "f_color",
            "f_spVisibility",
            "f_bgVisibility",
            "f_spClipping",
            "f_bgClipping",
            "f_dispType",
            "vramBufferedReadValue",
            "firstWrite",
            "currentMirroring",
            "vramMirrorTable",
            "ntable1",
            "sramAddress",
            "hitSpr0",
            "sprPalette",
            "imgPalette",
            "curX",
            "scanline",
            "lastRenderedScanline",
            "curNt",
            "scantile",
            "attrib",
            "buffer",
            "bgbuffer",
            "pixrendered",
            "requestEndFrame",
            "nmiOk",
            "dummyCycleToggle",
            "nmiCounter",
            "validTileData",
            "scanlineAlreadyRendered",
          ],
          toJSON: function () {
            var t,
              s = h.toJSON(this);
            for (s.nameTable = [], t = 0; t < this.nameTable.length; t++)
              s.nameTable[t] = this.nameTable[t].toJSON();
            for (s.ptTile = [], t = 0; t < this.ptTile.length; t++)
              s.ptTile[t] = this.ptTile[t].toJSON();
            return s;
          },
          fromJSON: function (t) {
            var s;
            for (h.fromJSON(this, t), s = 0; s < this.nameTable.length; s++)
              this.nameTable[s].fromJSON(t.nameTable[s]);
            for (s = 0; s < this.ptTile.length; s++)
              this.ptTile[s].fromJSON(t.ptTile[s]);
            for (s = 0; s < this.spriteMem.length; s++)
              this.spriteRamWriteUpdate(s, this.spriteMem[s]);
          },
        };
        var n = function (t, s, i) {
          (this.width = t),
            (this.height = s),
            (this.name = i),
            (this.tile = new Array(t * s)),
            (this.attrib = new Array(t * s));
          for (var e = 0; e < t * s; e++)
            (this.tile[e] = 0), (this.attrib[e] = 0);
        };
        n.prototype = {
          getTileIndex: function (t, s) {
            return this.tile[s * this.width + t];
          },
          getAttrib: function (t, s) {
            return this.attrib[s * this.width + t];
          },
          writeAttrib: function (t, s) {
            for (
              var i,
              e,
              h,
              r,
              n = (t % 8) * 4,
              a = 4 * Math.floor(t / 8),
              o = 0;
              o < 2;
              o++
            )
              for (var l = 0; l < 2; l++) {
                i = (s >> (2 * (2 * o + l))) & 3;
                for (var p = 0; p < 2; p++)
                  for (var u = 0; u < 2; u++)
                    (e = n + 2 * l + u),
                      (h = a + 2 * o + p),
                      (r = h * this.width + e),
                      (this.attrib[r] = (i << 2) & 12);
              }
          },
          toJSON: function () {
            return { tile: this.tile, attrib: this.attrib };
          },
          fromJSON: function (t) {
            (this.tile = t.tile), (this.attrib = t.attrib);
          },
        };
        var a = function () {
          (this.curTable = new Array(64)),
            (this.emphTable = new Array(8)),
            (this.currentEmph = -1);
        };
        (a.prototype = {
          reset: function () {
            this.setEmphasis(0);
          },
          loadNTSCPalette: function () {
            (this.curTable = [
              5395026,
              11796480,
              10485760,
              11599933,
              7602281,
              91,
              95,
              6208,
              12048,
              543240,
              26368,
              1196544,
              7153664,
              0,
              0,
              0,
              12899815,
              16728064,
              14421538,
              16729963,
              14090399,
              6818519,
              6588,
              21681,
              27227,
              35843,
              43776,
              2918400,
              10777088,
              0,
              0,
              0,
              16316664,
              16755516,
              16742785,
              16735173,
              16730354,
              14633471,
              4681215,
              46327,
              57599,
              58229,
              259115,
              7911470,
              15065624,
              7895160,
              0,
              0,
              16777215,
              16773822,
              16300216,
              16300248,
              16758527,
              16761855,
              13095423,
              10148607,
              8973816,
              8650717,
              12122296,
              16119980,
              16777136,
              16308472,
              0,
              0,
            ]),
              this.makeTables(),
              this.setEmphasis(0);
          },
          loadPALPalette: function () {
            (this.curTable = [
              5395026,
              11796480,
              10485760,
              11599933,
              7602281,
              91,
              95,
              6208,
              12048,
              543240,
              26368,
              1196544,
              7153664,
              0,
              0,
              0,
              12899815,
              16728064,
              14421538,
              16729963,
              14090399,
              6818519,
              6588,
              21681,
              27227,
              35843,
              43776,
              2918400,
              10777088,
              0,
              0,
              0,
              16316664,
              16755516,
              16742785,
              16735173,
              16730354,
              14633471,
              4681215,
              46327,
              57599,
              58229,
              259115,
              7911470,
              15065624,
              7895160,
              0,
              0,
              16777215,
              16773822,
              16300216,
              16300248,
              16758527,
              16761855,
              13095423,
              10148607,
              8973816,
              8650717,
              12122296,
              16119980,
              16777136,
              16308472,
              0,
              0,
            ]),
              this.makeTables(),
              this.setEmphasis(0);
          },
          makeTables: function () {
            for (var t, s, i, e, h, r, n, a, o = 0; o < 8; o++)
              for (
                r = 1,
                n = 1,
                a = 1,
                0 != (1 & o) && ((r = 0.75), (a = 0.75)),
                0 != (2 & o) && ((r = 0.75), (n = 0.75)),
                0 != (4 & o) && ((n = 0.75), (a = 0.75)),
                this.emphTable[o] = new Array(64),
                h = 0;
                h < 64;
                h++
              )
                (e = this.curTable[h]),
                  (t = Math.floor(this.getRed(e) * r)),
                  (s = Math.floor(this.getGreen(e) * n)),
                  (i = Math.floor(this.getBlue(e) * a)),
                  (this.emphTable[o][h] = this.getRgb(t, s, i));
          },
          setEmphasis: function (t) {
            if (t !== this.currentEmph) {
              this.currentEmph = t;
              for (var s = 0; s < 64; s++)
                this.curTable[s] = this.emphTable[t][s];
            }
          },
          getEntry: function (t) {
            return this.curTable[t];
          },
          getRed: function (t) {
            return (t >> 16) & 255;
          },
          getGreen: function (t) {
            return (t >> 8) & 255;
          },
          getBlue: function (t) {
            return 255 & t;
          },
          getRgb: function (t, s, i) {
            return (t << 16) | (s << 8) | i;
          },
          loadDefaultPalette: function () {
            (this.curTable[0] = this.getRgb(117, 117, 117)),
              (this.curTable[1] = this.getRgb(39, 27, 143)),
              (this.curTable[2] = this.getRgb(0, 0, 171)),
              (this.curTable[3] = this.getRgb(71, 0, 159)),
              (this.curTable[4] = this.getRgb(143, 0, 119)),
              (this.curTable[5] = this.getRgb(171, 0, 19)),
              (this.curTable[6] = this.getRgb(167, 0, 0)),
              (this.curTable[7] = this.getRgb(127, 11, 0)),
              (this.curTable[8] = this.getRgb(67, 47, 0)),
              (this.curTable[9] = this.getRgb(0, 71, 0)),
              (this.curTable[10] = this.getRgb(0, 81, 0)),
              (this.curTable[11] = this.getRgb(0, 63, 23)),
              (this.curTable[12] = this.getRgb(27, 63, 95)),
              (this.curTable[13] = this.getRgb(0, 0, 0)),
              (this.curTable[14] = this.getRgb(0, 0, 0)),
              (this.curTable[15] = this.getRgb(0, 0, 0)),
              (this.curTable[16] = this.getRgb(188, 188, 188)),
              (this.curTable[17] = this.getRgb(0, 115, 239)),
              (this.curTable[18] = this.getRgb(35, 59, 239)),
              (this.curTable[19] = this.getRgb(131, 0, 243)),
              (this.curTable[20] = this.getRgb(191, 0, 191)),
              (this.curTable[21] = this.getRgb(231, 0, 91)),
              (this.curTable[22] = this.getRgb(219, 43, 0)),
              (this.curTable[23] = this.getRgb(203, 79, 15)),
              (this.curTable[24] = this.getRgb(139, 115, 0)),
              (this.curTable[25] = this.getRgb(0, 151, 0)),
              (this.curTable[26] = this.getRgb(0, 171, 0)),
              (this.curTable[27] = this.getRgb(0, 147, 59)),
              (this.curTable[28] = this.getRgb(0, 131, 139)),
              (this.curTable[29] = this.getRgb(0, 0, 0)),
              (this.curTable[30] = this.getRgb(0, 0, 0)),
              (this.curTable[31] = this.getRgb(0, 0, 0)),
              (this.curTable[32] = this.getRgb(255, 255, 255)),
              (this.curTable[33] = this.getRgb(63, 191, 255)),
              (this.curTable[34] = this.getRgb(95, 151, 255)),
              (this.curTable[35] = this.getRgb(167, 139, 253)),
              (this.curTable[36] = this.getRgb(247, 123, 255)),
              (this.curTable[37] = this.getRgb(255, 119, 183)),
              (this.curTable[38] = this.getRgb(255, 119, 99)),
              (this.curTable[39] = this.getRgb(255, 155, 59)),
              (this.curTable[40] = this.getRgb(243, 191, 63)),
              (this.curTable[41] = this.getRgb(131, 211, 19)),
              (this.curTable[42] = this.getRgb(79, 223, 75)),
              (this.curTable[43] = this.getRgb(88, 248, 152)),
              (this.curTable[44] = this.getRgb(0, 235, 219)),
              (this.curTable[45] = this.getRgb(0, 0, 0)),
              (this.curTable[46] = this.getRgb(0, 0, 0)),
              (this.curTable[47] = this.getRgb(0, 0, 0)),
              (this.curTable[48] = this.getRgb(255, 255, 255)),
              (this.curTable[49] = this.getRgb(171, 231, 255)),
              (this.curTable[50] = this.getRgb(199, 215, 255)),
              (this.curTable[51] = this.getRgb(215, 203, 255)),
              (this.curTable[52] = this.getRgb(255, 199, 255)),
              (this.curTable[53] = this.getRgb(255, 199, 219)),
              (this.curTable[54] = this.getRgb(255, 191, 179)),
              (this.curTable[55] = this.getRgb(255, 219, 171)),
              (this.curTable[56] = this.getRgb(255, 231, 163)),
              (this.curTable[57] = this.getRgb(227, 255, 163)),
              (this.curTable[58] = this.getRgb(171, 243, 191)),
              (this.curTable[59] = this.getRgb(179, 255, 207)),
              (this.curTable[60] = this.getRgb(159, 255, 243)),
              (this.curTable[61] = this.getRgb(0, 0, 0)),
              (this.curTable[62] = this.getRgb(0, 0, 0)),
              (this.curTable[63] = this.getRgb(0, 0, 0)),
              this.makeTables(),
              this.setEmphasis(0);
          },
        }),
          (t.exports = r);
      },
      function (t, s) {
        var i = function (t) {
          (this.nes = t),
            (this.square1 = new r(this, !0)),
            (this.square2 = new r(this, !1)),
            (this.triangle = new n(this)),
            (this.noise = new h(this)),
            (this.dmc = new e(this)),
            (this.frameIrqCounter = null),
            (this.frameIrqCounterMax = 4),
            (this.initCounter = 2048),
            (this.channelEnableValue = null),
            (this.sampleRate = 44100),
            (this.lengthLookup = null),
            (this.dmcFreqLookup = null),
            (this.noiseWavelengthLookup = null),
            (this.square_table = null),
            (this.tnd_table = null),
            (this.frameIrqEnabled = !1),
            (this.frameIrqActive = null),
            (this.frameClockNow = null),
            (this.startedPlaying = !1),
            (this.recordOutput = !1),
            (this.initingHardware = !1),
            (this.masterFrameCounter = null),
            (this.derivedFrameCounter = null),
            (this.countSequence = null),
            (this.sampleTimer = null),
            (this.frameTime = null),
            (this.sampleTimerMax = null),
            (this.sampleCount = null),
            (this.triValue = 0),
            (this.smpSquare1 = null),
            (this.smpSquare2 = null),
            (this.smpTriangle = null),
            (this.smpDmc = null),
            (this.accCount = null),
            (this.prevSampleL = 0),
            (this.prevSampleR = 0),
            (this.smpAccumL = 0),
            (this.smpAccumR = 0),
            (this.dacRange = 0),
            (this.dcValue = 0),
            (this.masterVolume = 256),
            (this.stereoPosLSquare1 = null),
            (this.stereoPosLSquare2 = null),
            (this.stereoPosLTriangle = null),
            (this.stereoPosLNoise = null),
            (this.stereoPosLDMC = null),
            (this.stereoPosRSquare1 = null),
            (this.stereoPosRSquare2 = null),
            (this.stereoPosRTriangle = null),
            (this.stereoPosRNoise = null),
            (this.stereoPosRDMC = null),
            (this.extraCycles = null),
            (this.maxSample = null),
            (this.minSample = null),
            (this.panning = [80, 170, 100, 150, 128]),
            this.setPanning(this.panning),
            this.initLengthLookup(),
            this.initDmcFrequencyLookup(),
            this.initNoiseWavelengthLookup(),
            this.initDACtables();
          for (var s = 0; s < 20; s++)
            16 === s ? this.writeReg(16400, 16) : this.writeReg(16384 + s, 0);
          this.reset();
        };
        i.prototype = {
          reset: function () {
            (this.sampleRate = this.nes.opts.sampleRate),
              (this.sampleTimerMax = Math.floor(
                (1832727040 * this.nes.opts.preferredFrameRate) /
                (60 * this.sampleRate)
              )),
              (this.frameTime = Math.floor(
                (14915 * this.nes.opts.preferredFrameRate) / 60
              )),
              (this.sampleTimer = 0),
              this.updateChannelEnable(0),
              (this.masterFrameCounter = 0),
              (this.derivedFrameCounter = 0),
              (this.countSequence = 0),
              (this.sampleCount = 0),
              (this.initCounter = 2048),
              (this.frameIrqEnabled = !1),
              (this.initingHardware = !1),
              this.resetCounter(),
              this.square1.reset(),
              this.square2.reset(),
              this.triangle.reset(),
              this.noise.reset(),
              this.dmc.reset(),
              (this.accCount = 0),
              (this.smpSquare1 = 0),
              (this.smpSquare2 = 0),
              (this.smpTriangle = 0),
              (this.smpDmc = 0),
              (this.frameIrqEnabled = !1),
              (this.frameIrqCounterMax = 4),
              (this.channelEnableValue = 255),
              (this.startedPlaying = !1),
              (this.prevSampleL = 0),
              (this.prevSampleR = 0),
              (this.smpAccumL = 0),
              (this.smpAccumR = 0),
              (this.maxSample = -5e5),
              (this.minSample = 5e5);
          },
          readReg: function (t) {
            var s = 0;
            return (
              (s |= this.square1.getLengthStatus()),
              (s |= this.square2.getLengthStatus() << 1),
              (s |= this.triangle.getLengthStatus() << 2),
              (s |= this.noise.getLengthStatus() << 3),
              (s |= this.dmc.getLengthStatus() << 4),
              (s |=
                (this.frameIrqActive && this.frameIrqEnabled ? 1 : 0) << 6),
              (s |= this.dmc.getIrqStatus() << 7),
              (this.frameIrqActive = !1),
              (this.dmc.irqGenerated = !1),
              65535 & s
            );
          },
          writeReg: function (t, s) {
            t >= 16384 && t < 16388
              ? this.square1.writeReg(t, s)
              : t >= 16388 && t < 16392
                ? this.square2.writeReg(t, s)
                : t >= 16392 && t < 16396
                  ? this.triangle.writeReg(t, s)
                  : t >= 16396 && t <= 16399
                    ? this.noise.writeReg(t, s)
                    : 16400 === t
                      ? this.dmc.writeReg(t, s)
                      : 16401 === t
                        ? this.dmc.writeReg(t, s)
                        : 16402 === t
                          ? this.dmc.writeReg(t, s)
                          : 16403 === t
                            ? this.dmc.writeReg(t, s)
                            : 16405 === t
                              ? (this.updateChannelEnable(s),
                                0 !== s &&
                                this.initCounter > 0 &&
                                (this.initingHardware = !0),
                                this.dmc.writeReg(t, s))
                              : 16407 === t &&
                              ((this.countSequence = (s >> 7) & 1),
                                (this.masterFrameCounter = 0),
                                (this.frameIrqActive = !1),
                                (this.frameIrqEnabled = 0 == ((s >> 6) & 1)),
                                0 === this.countSequence
                                  ? ((this.frameIrqCounterMax = 4),
                                    (this.derivedFrameCounter = 4))
                                  : ((this.frameIrqCounterMax = 5),
                                    (this.derivedFrameCounter = 0),
                                    this.frameCounterTick()));
          },
          resetCounter: function () {
            0 === this.countSequence
              ? (this.derivedFrameCounter = 4)
              : (this.derivedFrameCounter = 0);
          },
          updateChannelEnable: function (t) {
            (this.channelEnableValue = 65535 & t),
              this.square1.setEnabled(0 != (1 & t)),
              this.square2.setEnabled(0 != (2 & t)),
              this.triangle.setEnabled(0 != (4 & t)),
              this.noise.setEnabled(0 != (8 & t)),
              this.dmc.setEnabled(0 != (16 & t));
          },
          clockFrameCounter: function (t) {
            if (this.initCounter > 0 && this.initingHardware)
              return (
                (this.initCounter -= t),
                void (this.initCounter <= 0 && (this.initingHardware = !1))
              );
            t += this.extraCycles;
            var s = this.sampleTimerMax - this.sampleTimer;
            t << 10 > s
              ? ((this.extraCycles = ((t << 10) - s) >> 10),
                (t -= this.extraCycles))
              : (this.extraCycles = 0);
            var i = this.dmc,
              e = this.triangle,
              h = this.square1,
              r = this.square2,
              n = this.noise;
            if (i.isEnabled)
              for (
                i.shiftCounter -= t << 3;
                i.shiftCounter <= 0 && i.dmaFrequency > 0;

              )
                (i.shiftCounter += i.dmaFrequency), i.clockDmc();
            if (e.progTimerMax > 0)
              for (e.progTimerCount -= t; e.progTimerCount <= 0;)
                (e.progTimerCount += e.progTimerMax + 1),
                  e.linearCounter > 0 &&
                  e.lengthCounter > 0 &&
                  (e.triangleCounter++,
                    (e.triangleCounter &= 31),
                    e.isEnabled &&
                    (e.triangleCounter >= 16
                      ? (e.sampleValue = 15 & e.triangleCounter)
                      : (e.sampleValue = 15 - (15 & e.triangleCounter)),
                      (e.sampleValue <<= 4)));
            (h.progTimerCount -= t),
              h.progTimerCount <= 0 &&
              ((h.progTimerCount += (h.progTimerMax + 1) << 1),
                h.squareCounter++,
                (h.squareCounter &= 7),
                h.updateSampleValue()),
              (r.progTimerCount -= t),
              r.progTimerCount <= 0 &&
              ((r.progTimerCount += (r.progTimerMax + 1) << 1),
                r.squareCounter++,
                (r.squareCounter &= 7),
                r.updateSampleValue());
            var a = t;
            if (n.progTimerCount - a > 0)
              (n.progTimerCount -= a),
                (n.accCount += a),
                (n.accValue += a * n.sampleValue);
            else
              for (; a-- > 0;)
                --n.progTimerCount <= 0 &&
                  n.progTimerMax > 0 &&
                  ((n.shiftReg <<= 1),
                    (n.tmp =
                      32768 &
                      ((n.shiftReg << (0 === n.randomMode ? 1 : 6)) ^
                        n.shiftReg)),
                    0 !== n.tmp
                      ? ((n.shiftReg |= 1),
                        (n.randomBit = 0),
                        (n.sampleValue = 0))
                      : ((n.randomBit = 1),
                        n.isEnabled && n.lengthCounter > 0
                          ? (n.sampleValue = n.masterVolume)
                          : (n.sampleValue = 0)),
                    (n.progTimerCount += n.progTimerMax)),
                  (n.accValue += n.sampleValue),
                  n.accCount++;
            this.frameIrqEnabled &&
              this.frameIrqActive &&
              this.nes.cpu.requestIrq(this.nes.cpu.IRQ_NORMAL),
              (this.masterFrameCounter += t << 1),
              this.masterFrameCounter >= this.frameTime &&
              ((this.masterFrameCounter -= this.frameTime),
                this.frameCounterTick()),
              this.accSample(t),
              (this.sampleTimer += t << 10),
              this.sampleTimer >= this.sampleTimerMax &&
              (this.sample(), (this.sampleTimer -= this.sampleTimerMax));
          },
          accSample: function (t) {
            this.triangle.sampleCondition &&
              ((this.triValue = Math.floor(
                (this.triangle.progTimerCount << 4) /
                (this.triangle.progTimerMax + 1)
              )),
                this.triValue > 16 && (this.triValue = 16),
                this.triangle.triangleCounter >= 16 &&
                (this.triValue = 16 - this.triValue),
                (this.triValue += this.triangle.sampleValue)),
              2 === t
                ? ((this.smpTriangle += this.triValue << 1),
                  (this.smpDmc += this.dmc.sample << 1),
                  (this.smpSquare1 += this.square1.sampleValue << 1),
                  (this.smpSquare2 += this.square2.sampleValue << 1),
                  (this.accCount += 2))
                : 4 === t
                  ? ((this.smpTriangle += this.triValue << 2),
                    (this.smpDmc += this.dmc.sample << 2),
                    (this.smpSquare1 += this.square1.sampleValue << 2),
                    (this.smpSquare2 += this.square2.sampleValue << 2),
                    (this.accCount += 4))
                  : ((this.smpTriangle += t * this.triValue),
                    (this.smpDmc += t * this.dmc.sample),
                    (this.smpSquare1 += t * this.square1.sampleValue),
                    (this.smpSquare2 += t * this.square2.sampleValue),
                    (this.accCount += t));
          },
          frameCounterTick: function () {
            this.derivedFrameCounter++,
              this.derivedFrameCounter >= this.frameIrqCounterMax &&
              (this.derivedFrameCounter = 0),
              (1 !== this.derivedFrameCounter &&
                3 !== this.derivedFrameCounter) ||
              (this.triangle.clockLengthCounter(),
                this.square1.clockLengthCounter(),
                this.square2.clockLengthCounter(),
                this.noise.clockLengthCounter(),
                this.square1.clockSweep(),
                this.square2.clockSweep()),
              this.derivedFrameCounter >= 0 &&
              this.derivedFrameCounter < 4 &&
              (this.square1.clockEnvDecay(),
                this.square2.clockEnvDecay(),
                this.noise.clockEnvDecay(),
                this.triangle.clockLinearCounter()),
              3 === this.derivedFrameCounter &&
              0 === this.countSequence &&
              (this.frameIrqActive = !0);
          },
          sample: function () {
            var t, s;
            this.accCount > 0
              ? ((this.smpSquare1 <<= 4),
                (this.smpSquare1 = Math.floor(
                  this.smpSquare1 / this.accCount
                )),
                (this.smpSquare2 <<= 4),
                (this.smpSquare2 = Math.floor(
                  this.smpSquare2 / this.accCount
                )),
                (this.smpTriangle = Math.floor(
                  this.smpTriangle / this.accCount
                )),
                (this.smpDmc <<= 4),
                (this.smpDmc = Math.floor(this.smpDmc / this.accCount)),
                (this.accCount = 0))
              : ((this.smpSquare1 = this.square1.sampleValue << 4),
                (this.smpSquare2 = this.square2.sampleValue << 4),
                (this.smpTriangle = this.triangle.sampleValue),
                (this.smpDmc = this.dmc.sample << 4));
            var i = Math.floor(
              (this.noise.accValue << 4) / this.noise.accCount
            );
            (this.noise.accValue = i >> 4),
              (this.noise.accCount = 1),
              (t =
                (this.smpSquare1 * this.stereoPosLSquare1 +
                  this.smpSquare2 * this.stereoPosLSquare2) >>
                8),
              (s =
                (3 * this.smpTriangle * this.stereoPosLTriangle +
                  (i << 1) * this.stereoPosLNoise +
                  this.smpDmc * this.stereoPosLDMC) >>
                8),
              t >= this.square_table.length &&
              (t = this.square_table.length - 1),
              s >= this.tnd_table.length && (s = this.tnd_table.length - 1);
            var e = this.square_table[t] + this.tnd_table[s] - this.dcValue;
            (t =
              (this.smpSquare1 * this.stereoPosRSquare1 +
                this.smpSquare2 * this.stereoPosRSquare2) >>
              8),
              (s =
                (3 * this.smpTriangle * this.stereoPosRTriangle +
                  (i << 1) * this.stereoPosRNoise +
                  this.smpDmc * this.stereoPosRDMC) >>
                8),
              t >= this.square_table.length &&
              (t = this.square_table.length - 1),
              s >= this.tnd_table.length && (s = this.tnd_table.length - 1);
            var h = this.square_table[t] + this.tnd_table[s] - this.dcValue,
              r = e - this.prevSampleL;
            (this.prevSampleL += r),
              (this.smpAccumL += r - (this.smpAccumL >> 10)),
              (e = this.smpAccumL);
            var n = h - this.prevSampleR;
            (this.prevSampleR += n),
              (this.smpAccumR += n - (this.smpAccumR >> 10)),
              (h = this.smpAccumR),
              e > this.maxSample && (this.maxSample = e),
              e < this.minSample && (this.minSample = e),
              this.nes.opts.onAudioSample &&
              this.nes.opts.onAudioSample(e / 32768, h / 32768),
              (this.smpSquare1 = 0),
              (this.smpSquare2 = 0),
              (this.smpTriangle = 0),
              (this.smpDmc = 0);
          },
          getLengthMax: function (t) {
            return this.lengthLookup[t >> 3];
          },
          getDmcFrequency: function (t) {
            return t >= 0 && t < 16 ? this.dmcFreqLookup[t] : 0;
          },
          getNoiseWaveLength: function (t) {
            return t >= 0 && t < 16 ? this.noiseWavelengthLookup[t] : 0;
          },
          setPanning: function (t) {
            for (var s = 0; s < 5; s++) this.panning[s] = t[s];
            this.updateStereoPos();
          },
          setMasterVolume: function (t) {
            t < 0 && (t = 0),
              t > 256 && (t = 256),
              (this.masterVolume = t),
              this.updateStereoPos();
          },
          updateStereoPos: function () {
            (this.stereoPosLSquare1 =
              (this.panning[0] * this.masterVolume) >> 8),
              (this.stereoPosLSquare2 =
                (this.panning[1] * this.masterVolume) >> 8),
              (this.stereoPosLTriangle =
                (this.panning[2] * this.masterVolume) >> 8),
              (this.stereoPosLNoise =
                (this.panning[3] * this.masterVolume) >> 8),
              (this.stereoPosLDMC =
                (this.panning[4] * this.masterVolume) >> 8),
              (this.stereoPosRSquare1 =
                this.masterVolume - this.stereoPosLSquare1),
              (this.stereoPosRSquare2 =
                this.masterVolume - this.stereoPosLSquare2),
              (this.stereoPosRTriangle =
                this.masterVolume - this.stereoPosLTriangle),
              (this.stereoPosRNoise =
                this.masterVolume - this.stereoPosLNoise),
              (this.stereoPosRDMC = this.masterVolume - this.stereoPosLDMC);
          },
          initLengthLookup: function () {
            this.lengthLookup = [
              10,
              254,
              20,
              2,
              40,
              4,
              80,
              6,
              160,
              8,
              60,
              10,
              14,
              12,
              26,
              14,
              12,
              16,
              24,
              18,
              48,
              20,
              96,
              22,
              192,
              24,
              72,
              26,
              16,
              28,
              32,
              30,
            ];
          },
          initDmcFrequencyLookup: function () {
            (this.dmcFreqLookup = new Array(16)),
              (this.dmcFreqLookup[0] = 3424),
              (this.dmcFreqLookup[1] = 3040),
              (this.dmcFreqLookup[2] = 2720),
              (this.dmcFreqLookup[3] = 2560),
              (this.dmcFreqLookup[4] = 2288),
              (this.dmcFreqLookup[5] = 2032),
              (this.dmcFreqLookup[6] = 1808),
              (this.dmcFreqLookup[7] = 1712),
              (this.dmcFreqLookup[8] = 1520),
              (this.dmcFreqLookup[9] = 1280),
              (this.dmcFreqLookup[10] = 1136),
              (this.dmcFreqLookup[11] = 1024),
              (this.dmcFreqLookup[12] = 848),
              (this.dmcFreqLookup[13] = 672),
              (this.dmcFreqLookup[14] = 576),
              (this.dmcFreqLookup[15] = 432);
          },
          initNoiseWavelengthLookup: function () {
            (this.noiseWavelengthLookup = new Array(16)),
              (this.noiseWavelengthLookup[0] = 4),
              (this.noiseWavelengthLookup[1] = 8),
              (this.noiseWavelengthLookup[2] = 16),
              (this.noiseWavelengthLookup[3] = 32),
              (this.noiseWavelengthLookup[4] = 64),
              (this.noiseWavelengthLookup[5] = 96),
              (this.noiseWavelengthLookup[6] = 128),
              (this.noiseWavelengthLookup[7] = 160),
              (this.noiseWavelengthLookup[8] = 202),
              (this.noiseWavelengthLookup[9] = 254),
              (this.noiseWavelengthLookup[10] = 380),
              (this.noiseWavelengthLookup[11] = 508),
              (this.noiseWavelengthLookup[12] = 762),
              (this.noiseWavelengthLookup[13] = 1016),
              (this.noiseWavelengthLookup[14] = 2034),
              (this.noiseWavelengthLookup[15] = 4068);
          },
          initDACtables: function () {
            var t,
              s,
              i,
              e = 0,
              h = 0;
            for (
              this.square_table = new Array(512),
              this.tnd_table = new Array(3264),
              i = 0;
              i < 512;
              i++
            )
              (t = 95.52 / (8128 / (i / 16) + 100)),
                (t *= 0.98411),
                (t *= 5e4),
                (s = Math.floor(t)),
                (this.square_table[i] = s),
                s > e && (e = s);
            for (i = 0; i < 3264; i++)
              (t = 163.67 / (24329 / (i / 16) + 100)),
                (t *= 0.98411),
                (t *= 5e4),
                (s = Math.floor(t)),
                (this.tnd_table[i] = s),
                s > h && (h = s);
            (this.dacRange = e + h), (this.dcValue = this.dacRange / 2);
          },
        };
        var e = function (t) {
          (this.papu = t),
            (this.MODE_NORMAL = 0),
            (this.MODE_LOOP = 1),
            (this.MODE_IRQ = 2),
            (this.isEnabled = null),
            (this.hasSample = null),
            (this.irqGenerated = !1),
            (this.playMode = null),
            (this.dmaFrequency = null),
            (this.dmaCounter = null),
            (this.deltaCounter = null),
            (this.playStartAddress = null),
            (this.playAddress = null),
            (this.playLength = null),
            (this.playLengthCounter = null),
            (this.shiftCounter = null),
            (this.reg4012 = null),
            (this.reg4013 = null),
            (this.sample = null),
            (this.dacLsb = null),
            (this.data = null),
            this.reset();
        };
        e.prototype = {
          clockDmc: function () {
            this.hasSample &&
              (0 == (1 & this.data)
                ? this.deltaCounter > 0 && this.deltaCounter--
                : this.deltaCounter < 63 && this.deltaCounter++,
                (this.sample = this.isEnabled
                  ? (this.deltaCounter << 1) + this.dacLsb
                  : 0),
                (this.data >>= 1)),
              this.dmaCounter--,
              this.dmaCounter <= 0 &&
              ((this.hasSample = !1),
                this.endOfSample(),
                (this.dmaCounter = 8)),
              this.irqGenerated &&
              this.papu.nes.cpu.requestIrq(this.papu.nes.cpu.IRQ_NORMAL);
          },
          endOfSample: function () {
            0 === this.playLengthCounter &&
              this.playMode === this.MODE_LOOP &&
              ((this.playAddress = this.playStartAddress),
                (this.playLengthCounter = this.playLength)),
              this.playLengthCounter > 0 &&
              (this.nextSample(),
                0 === this.playLengthCounter &&
                this.playMode === this.MODE_IRQ &&
                (this.irqGenerated = !0));
          },
          nextSample: function () {
            (this.data = this.papu.nes.mmap.load(this.playAddress)),
              this.papu.nes.cpu.haltCycles(4),
              this.playLengthCounter--,
              this.playAddress++,
              this.playAddress > 65535 && (this.playAddress = 32768),
              (this.hasSample = !0);
          },
          writeReg: function (t, s) {
            16400 === t
              ? (s >> 6 == 0
                ? (this.playMode = this.MODE_NORMAL)
                : 1 == ((s >> 6) & 1)
                  ? (this.playMode = this.MODE_LOOP)
                  : s >> 6 == 2 && (this.playMode = this.MODE_IRQ),
                0 == (128 & s) && (this.irqGenerated = !1),
                (this.dmaFrequency = this.papu.getDmcFrequency(15 & s)))
              : 16401 === t
                ? ((this.deltaCounter = (s >> 1) & 63),
                  (this.dacLsb = 1 & s),
                  (this.sample = (this.deltaCounter << 1) + this.dacLsb))
                : 16402 === t
                  ? ((this.playStartAddress = (s << 6) | 49152),
                    (this.playAddress = this.playStartAddress),
                    (this.reg4012 = s))
                  : 16403 === t
                    ? ((this.playLength = 1 + (s << 4)),
                      (this.playLengthCounter = this.playLength),
                      (this.reg4013 = s))
                    : 16405 === t &&
                    (0 == ((s >> 4) & 1)
                      ? (this.playLengthCounter = 0)
                      : ((this.playAddress = this.playStartAddress),
                        (this.playLengthCounter = this.playLength)),
                      (this.irqGenerated = !1));
          },
          setEnabled: function (t) {
            !this.isEnabled &&
              t &&
              (this.playLengthCounter = this.playLength),
              (this.isEnabled = t);
          },
          getLengthStatus: function () {
            return 0 !== this.playLengthCounter && this.isEnabled ? 1 : 0;
          },
          getIrqStatus: function () {
            return this.irqGenerated ? 1 : 0;
          },
          reset: function () {
            (this.isEnabled = !1),
              (this.irqGenerated = !1),
              (this.playMode = this.MODE_NORMAL),
              (this.dmaFrequency = 0),
              (this.dmaCounter = 0),
              (this.deltaCounter = 0),
              (this.playStartAddress = 0),
              (this.playAddress = 0),
              (this.playLength = 0),
              (this.playLengthCounter = 0),
              (this.sample = 0),
              (this.dacLsb = 0),
              (this.shiftCounter = 0),
              (this.reg4012 = 0),
              (this.reg4013 = 0),
              (this.data = 0);
          },
        };
        var h = function (t) {
          (this.papu = t),
            (this.isEnabled = null),
            (this.envDecayDisable = null),
            (this.envDecayLoopEnable = null),
            (this.lengthCounterEnable = null),
            (this.envReset = null),
            (this.shiftNow = null),
            (this.lengthCounter = null),
            (this.progTimerCount = null),
            (this.progTimerMax = null),
            (this.envDecayRate = null),
            (this.envDecayCounter = null),
            (this.envVolume = null),
            (this.masterVolume = null),
            (this.shiftReg = 16384),
            (this.randomBit = null),
            (this.randomMode = null),
            (this.sampleValue = null),
            (this.accValue = 0),
            (this.accCount = 1),
            (this.tmp = null),
            this.reset();
        };
        h.prototype = {
          reset: function () {
            (this.progTimerCount = 0),
              (this.progTimerMax = 0),
              (this.isEnabled = !1),
              (this.lengthCounter = 0),
              (this.lengthCounterEnable = !1),
              (this.envDecayDisable = !1),
              (this.envDecayLoopEnable = !1),
              (this.shiftNow = !1),
              (this.envDecayRate = 0),
              (this.envDecayCounter = 0),
              (this.envVolume = 0),
              (this.masterVolume = 0),
              (this.shiftReg = 1),
              (this.randomBit = 0),
              (this.randomMode = 0),
              (this.sampleValue = 0),
              (this.tmp = 0);
          },
          clockLengthCounter: function () {
            this.lengthCounterEnable &&
              this.lengthCounter > 0 &&
              0 === --this.lengthCounter &&
              this.updateSampleValue();
          },
          clockEnvDecay: function () {
            this.envReset
              ? ((this.envReset = !1),
                (this.envDecayCounter = this.envDecayRate + 1),
                (this.envVolume = 15))
              : --this.envDecayCounter <= 0 &&
              ((this.envDecayCounter = this.envDecayRate + 1),
                this.envVolume > 0
                  ? this.envVolume--
                  : (this.envVolume = this.envDecayLoopEnable ? 15 : 0)),
              this.envDecayDisable
                ? (this.masterVolume = this.envDecayRate)
                : (this.masterVolume = this.envVolume),
              this.updateSampleValue();
          },
          updateSampleValue: function () {
            this.isEnabled &&
              this.lengthCounter > 0 &&
              (this.sampleValue = this.randomBit * this.masterVolume);
          },
          writeReg: function (t, s) {
            16396 === t
              ? ((this.envDecayDisable = 0 != (16 & s)),
                (this.envDecayRate = 15 & s),
                (this.envDecayLoopEnable = 0 != (32 & s)),
                (this.lengthCounterEnable = 0 == (32 & s)),
                this.envDecayDisable
                  ? (this.masterVolume = this.envDecayRate)
                  : (this.masterVolume = this.envVolume))
              : 16398 === t
                ? ((this.progTimerMax = this.papu.getNoiseWaveLength(15 & s)),
                  (this.randomMode = s >> 7))
                : 16399 === t &&
                ((this.lengthCounter = this.papu.getLengthMax(248 & s)),
                  (this.envReset = !0));
          },
          setEnabled: function (t) {
            (this.isEnabled = t),
              t || (this.lengthCounter = 0),
              this.updateSampleValue();
          },
          getLengthStatus: function () {
            return 0 !== this.lengthCounter && this.isEnabled ? 1 : 0;
          },
        };
        var r = function (t, s) {
          (this.papu = t),
            (this.dutyLookup = [
              0,
              1,
              0,
              0,
              0,
              0,
              0,
              0,
              0,
              1,
              1,
              0,
              0,
              0,
              0,
              0,
              0,
              1,
              1,
              1,
              1,
              0,
              0,
              0,
              1,
              0,
              0,
              1,
              1,
              1,
              1,
              1,
            ]),
            (this.impLookup = [
              1,
              -1,
              0,
              0,
              0,
              0,
              0,
              0,
              1,
              0,
              -1,
              0,
              0,
              0,
              0,
              0,
              1,
              0,
              0,
              0,
              -1,
              0,
              0,
              0,
              -1,
              0,
              1,
              0,
              0,
              0,
              0,
              0,
            ]),
            (this.sqr1 = s),
            (this.isEnabled = null),
            (this.lengthCounterEnable = null),
            (this.sweepActive = null),
            (this.envDecayDisable = null),
            (this.envDecayLoopEnable = null),
            (this.envReset = null),
            (this.sweepCarry = null),
            (this.updateSweepPeriod = null),
            (this.progTimerCount = null),
            (this.progTimerMax = null),
            (this.lengthCounter = null),
            (this.squareCounter = null),
            (this.sweepCounter = null),
            (this.sweepCounterMax = null),
            (this.sweepMode = null),
            (this.sweepShiftAmount = null),
            (this.envDecayRate = null),
            (this.envDecayCounter = null),
            (this.envVolume = null),
            (this.masterVolume = null),
            (this.dutyMode = null),
            (this.sweepResult = null),
            (this.sampleValue = null),
            (this.vol = null),
            this.reset();
        };
        r.prototype = {
          reset: function () {
            (this.progTimerCount = 0),
              (this.progTimerMax = 0),
              (this.lengthCounter = 0),
              (this.squareCounter = 0),
              (this.sweepCounter = 0),
              (this.sweepCounterMax = 0),
              (this.sweepMode = 0),
              (this.sweepShiftAmount = 0),
              (this.envDecayRate = 0),
              (this.envDecayCounter = 0),
              (this.envVolume = 0),
              (this.masterVolume = 0),
              (this.dutyMode = 0),
              (this.vol = 0),
              (this.isEnabled = !1),
              (this.lengthCounterEnable = !1),
              (this.sweepActive = !1),
              (this.sweepCarry = !1),
              (this.envDecayDisable = !1),
              (this.envDecayLoopEnable = !1);
          },
          clockLengthCounter: function () {
            this.lengthCounterEnable &&
              this.lengthCounter > 0 &&
              0 === --this.lengthCounter &&
              this.updateSampleValue();
          },
          clockEnvDecay: function () {
            this.envReset
              ? ((this.envReset = !1),
                (this.envDecayCounter = this.envDecayRate + 1),
                (this.envVolume = 15))
              : --this.envDecayCounter <= 0 &&
              ((this.envDecayCounter = this.envDecayRate + 1),
                this.envVolume > 0
                  ? this.envVolume--
                  : (this.envVolume = this.envDecayLoopEnable ? 15 : 0)),
              this.envDecayDisable
                ? (this.masterVolume = this.envDecayRate)
                : (this.masterVolume = this.envVolume),
              this.updateSampleValue();
          },
          clockSweep: function () {
            --this.sweepCounter <= 0 &&
              ((this.sweepCounter = this.sweepCounterMax + 1),
                this.sweepActive &&
                this.sweepShiftAmount > 0 &&
                this.progTimerMax > 7 &&
                ((this.sweepCarry = !1),
                  0 === this.sweepMode
                    ? ((this.progTimerMax +=
                      this.progTimerMax >> this.sweepShiftAmount),
                      this.progTimerMax > 4095 &&
                      ((this.progTimerMax = 4095), (this.sweepCarry = !0)))
                    : (this.progTimerMax =
                      this.progTimerMax -
                      ((this.progTimerMax >> this.sweepShiftAmount) -
                        (this.sqr1 ? 1 : 0))))),
              this.updateSweepPeriod &&
              ((this.updateSweepPeriod = !1),
                (this.sweepCounter = this.sweepCounterMax + 1));
          },
          updateSampleValue: function () {
            this.isEnabled && this.lengthCounter > 0 && this.progTimerMax > 7
              ? 0 === this.sweepMode &&
                this.progTimerMax +
                (this.progTimerMax >> this.sweepShiftAmount) >
                4095
                ? (this.sampleValue = 0)
                : (this.sampleValue =
                  this.masterVolume *
                  this.dutyLookup[
                  (this.dutyMode << 3) + this.squareCounter
                  ])
              : (this.sampleValue = 0);
          },
          writeReg: function (t, s) {
            var i = this.sqr1 ? 0 : 4;
            t === 16384 + i
              ? ((this.envDecayDisable = 0 != (16 & s)),
                (this.envDecayRate = 15 & s),
                (this.envDecayLoopEnable = 0 != (32 & s)),
                (this.dutyMode = (s >> 6) & 3),
                (this.lengthCounterEnable = 0 == (32 & s)),
                this.envDecayDisable
                  ? (this.masterVolume = this.envDecayRate)
                  : (this.masterVolume = this.envVolume),
                this.updateSampleValue())
              : t === 16385 + i
                ? ((this.sweepActive = 0 != (128 & s)),
                  (this.sweepCounterMax = (s >> 4) & 7),
                  (this.sweepMode = (s >> 3) & 1),
                  (this.sweepShiftAmount = 7 & s),
                  (this.updateSweepPeriod = !0))
                : t === 16386 + i
                  ? ((this.progTimerMax &= 1792), (this.progTimerMax |= s))
                  : t === 16387 + i &&
                  ((this.progTimerMax &= 255),
                    (this.progTimerMax |= (7 & s) << 8),
                    this.isEnabled &&
                    (this.lengthCounter = this.papu.getLengthMax(248 & s)),
                    (this.envReset = !0));
          },
          setEnabled: function (t) {
            (this.isEnabled = t),
              t || (this.lengthCounter = 0),
              this.updateSampleValue();
          },
          getLengthStatus: function () {
            return 0 !== this.lengthCounter && this.isEnabled ? 1 : 0;
          },
        };
        var n = function (t) {
          (this.papu = t),
            (this.isEnabled = null),
            (this.sampleCondition = null),
            (this.lengthCounterEnable = null),
            (this.lcHalt = null),
            (this.lcControl = null),
            (this.progTimerCount = null),
            (this.progTimerMax = null),
            (this.triangleCounter = null),
            (this.lengthCounter = null),
            (this.linearCounter = null),
            (this.lcLoadValue = null),
            (this.sampleValue = null),
            (this.tmp = null),
            this.reset();
        };
        (n.prototype = {
          reset: function () {
            (this.progTimerCount = 0),
              (this.progTimerMax = 0),
              (this.triangleCounter = 0),
              (this.isEnabled = !1),
              (this.sampleCondition = !1),
              (this.lengthCounter = 0),
              (this.lengthCounterEnable = !1),
              (this.linearCounter = 0),
              (this.lcLoadValue = 0),
              (this.lcHalt = !0),
              (this.lcControl = !1),
              (this.tmp = 0),
              (this.sampleValue = 15);
          },
          clockLengthCounter: function () {
            this.lengthCounterEnable &&
              this.lengthCounter > 0 &&
              0 === --this.lengthCounter &&
              this.updateSampleCondition();
          },
          clockLinearCounter: function () {
            this.lcHalt
              ? ((this.linearCounter = this.lcLoadValue),
                this.updateSampleCondition())
              : this.linearCounter > 0 &&
              (this.linearCounter--, this.updateSampleCondition()),
              this.lcControl || (this.lcHalt = !1);
          },
          getLengthStatus: function () {
            return 0 !== this.lengthCounter && this.isEnabled ? 1 : 0;
          },
          readReg: function (t) {
            return 0;
          },
          writeReg: function (t, s) {
            16392 === t
              ? ((this.lcControl = 0 != (128 & s)),
                (this.lcLoadValue = 127 & s),
                (this.lengthCounterEnable = !this.lcControl))
              : 16394 === t
                ? ((this.progTimerMax &= 1792), (this.progTimerMax |= s))
                : 16395 === t &&
                ((this.progTimerMax &= 255),
                  (this.progTimerMax |= (7 & s) << 8),
                  (this.lengthCounter = this.papu.getLengthMax(248 & s)),
                  (this.lcHalt = !0)),
              this.updateSampleCondition();
          },
          clockProgrammableTimer: function (t) {
            if (this.progTimerMax > 0)
              for (
                this.progTimerCount += t;
                this.progTimerMax > 0 &&
                this.progTimerCount >= this.progTimerMax;

              )
                (this.progTimerCount -= this.progTimerMax),
                  this.isEnabled &&
                  this.lengthCounter > 0 &&
                  this.linearCounter > 0 &&
                  this.clockTriangleGenerator();
          },
          clockTriangleGenerator: function () {
            this.triangleCounter++, (this.triangleCounter &= 31);
          },
          setEnabled: function (t) {
            (this.isEnabled = t),
              t || (this.lengthCounter = 0),
              this.updateSampleCondition();
          },
          updateSampleCondition: function () {
            this.sampleCondition =
              this.isEnabled &&
              this.progTimerMax > 7 &&
              this.linearCounter > 0 &&
              this.lengthCounter > 0;
          },
        }),
          (t.exports = i);
      },
      function (t, s, i) {
        var e = i(9),
          h = i(2),
          r = function (t) {
            (this.nes = t), (this.mapperName = new Array(92));
            for (var s = 0; s < 92; s++)
              this.mapperName[s] = "Unknown Mapper";
            (this.mapperName[0] = "Direct Access"),
              (this.mapperName[1] = "Nintendo MMC1"),
              (this.mapperName[2] = "UNROM"),
              (this.mapperName[3] = "CNROM"),
              (this.mapperName[4] = "Nintendo MMC3"),
              (this.mapperName[5] = "Nintendo MMC5"),
              (this.mapperName[6] = "FFE F4xxx"),
              (this.mapperName[7] = "AOROM"),
              (this.mapperName[8] = "FFE F3xxx"),
              (this.mapperName[9] = "Nintendo MMC2"),
              (this.mapperName[10] = "Nintendo MMC4"),
              (this.mapperName[11] = "Color Dreams Chip"),
              (this.mapperName[12] = "FFE F6xxx"),
              (this.mapperName[15] = "100-in-1 switch"),
              (this.mapperName[16] = "Bandai chip"),
              (this.mapperName[17] = "FFE F8xxx"),
              (this.mapperName[18] = "Jaleco SS8806 chip"),
              (this.mapperName[19] = "Namcot 106 chip"),
              (this.mapperName[20] = "Famicom Disk System"),
              (this.mapperName[21] = "Konami VRC4a"),
              (this.mapperName[22] = "Konami VRC2a"),
              (this.mapperName[23] = "Konami VRC2a"),
              (this.mapperName[24] = "Konami VRC6"),
              (this.mapperName[25] = "Konami VRC4b"),
              (this.mapperName[32] = "Irem G-101 chip"),
              (this.mapperName[33] = "Taito TC0190/TC0350"),
              (this.mapperName[34] = "32kB ROM switch"),
              (this.mapperName[64] = "Tengen RAMBO-1 chip"),
              (this.mapperName[65] = "Irem H-3001 chip"),
              (this.mapperName[66] = "GNROM switch"),
              (this.mapperName[67] = "SunSoft3 chip"),
              (this.mapperName[68] = "SunSoft4 chip"),
              (this.mapperName[69] = "SunSoft5 FME-7 chip"),
              (this.mapperName[71] = "Camerica chip"),
              (this.mapperName[78] = "Irem 74HC161/32-based"),
              (this.mapperName[91] = "Pirate HK-SF3 chip");
          };
        (r.prototype = {
          VERTICAL_MIRRORING: 0,
          HORIZONTAL_MIRRORING: 1,
          FOURSCREEN_MIRRORING: 2,
          SINGLESCREEN_MIRRORING: 3,
          SINGLESCREEN_MIRRORING2: 4,
          SINGLESCREEN_MIRRORING3: 5,
          SINGLESCREEN_MIRRORING4: 6,
          CHRROM_MIRRORING: 7,
          header: null,
          rom: null,
          vrom: null,
          vromTile: null,
          romCount: null,
          vromCount: null,
          mirroring: null,
          batteryRam: null,
          trainer: null,
          fourScreen: null,
          mapperType: null,
          valid: !1,
          load: function (t) {
            var s, i, e;
            if (-1 === t.indexOf("NES"))
              throw new Error("Not a valid NES ROM.");
            for (this.header = new Array(16), s = 0; s < 16; s++)
              this.header[s] = 255 & t.charCodeAt(s);
            (this.romCount = this.header[4]),
              (this.vromCount = 2 * this.header[5]),
              (this.mirroring = 0 != (1 & this.header[6]) ? 1 : 0),
              (this.batteryRam = 0 != (2 & this.header[6])),
              (this.trainer = 0 != (4 & this.header[6])),
              (this.fourScreen = 0 != (8 & this.header[6])),
              (this.mapperType =
                (this.header[6] >> 4) | (240 & this.header[7]));
            var r = !1;
            for (s = 8; s < 16; s++)
              if (0 !== this.header[s]) {
                r = !0;
                break;
              }
            r && (this.mapperType &= 15),
              (this.rom = new Array(this.romCount));
            var n = 16;
            for (s = 0; s < this.romCount; s++) {
              for (
                this.rom[s] = new Array(16384), i = 0;
                i < 16384 && !(n + i >= t.length);
                i++
              )
                this.rom[s][i] = 255 & t.charCodeAt(n + i);
              n += 16384;
            }
            for (
              this.vrom = new Array(this.vromCount), s = 0;
              s < this.vromCount;
              s++
            ) {
              for (
                this.vrom[s] = new Array(4096), i = 0;
                i < 4096 && !(n + i >= t.length);
                i++
              )
                this.vrom[s][i] = 255 & t.charCodeAt(n + i);
              n += 4096;
            }
            for (
              this.vromTile = new Array(this.vromCount), s = 0;
              s < this.vromCount;
              s++
            )
              for (this.vromTile[s] = new Array(256), i = 0; i < 256; i++)
                this.vromTile[s][i] = new h();
            var a, o;
            for (e = 0; e < this.vromCount; e++)
              for (s = 0; s < 4096; s++)
                (a = s >> 4),
                  (o = s % 16),
                  o < 8
                    ? this.vromTile[e][a].setScanline(
                      o,
                      this.vrom[e][s],
                      this.vrom[e][s + 8]
                    )
                    : this.vromTile[e][a].setScanline(
                      o - 8,
                      this.vrom[e][s - 8],
                      this.vrom[e][s]
                    );
            this.valid = !0;
          },
          getMirroringType: function () {
            return this.fourScreen
              ? this.FOURSCREEN_MIRRORING
              : 0 === this.mirroring
                ? this.HORIZONTAL_MIRRORING
                : this.VERTICAL_MIRRORING;
          },
          getMapperName: function () {
            return this.mapperType >= 0 &&
              this.mapperType < this.mapperName.length
              ? this.mapperName[this.mapperType]
              : "Unknown Mapper, " + this.mapperType;
          },
          mapperSupported: function () {
            return void 0 !== e[this.mapperType];
          },
          createMapper: function () {
            if (this.mapperSupported())
              return new e[this.mapperType](this.nes);
            throw new Error(
              "This ROM uses a mapper not supported by JSNES: " +
              this.getMapperName() +
              "(" +
              this.mapperType +
              ")"
            );
          },
        }),
          (t.exports = r);
      },
      function (t, s, i) {
        var e = i(0),
          h = {};
        (h[0] = function (t) {
          this.nes = t;
        }),
          (h[0].prototype = {
            reset: function () {
              (this.joy1StrobeState = 0),
                (this.joy2StrobeState = 0),
                (this.joypadLastWrite = 0),
                (this.zapperFired = !1),
                (this.zapperX = null),
                (this.zapperY = null);
            },
            write: function (t, s) {
              t < 8192
                ? (this.nes.cpu.mem[2047 & t] = s)
                : t > 16407
                  ? ((this.nes.cpu.mem[t] = s),
                    t >= 24576 &&
                    t < 32768 &&
                    this.nes.opts.onBatteryRamWrite(t, s))
                  : t > 8199 && t < 16384
                    ? this.regWrite(8192 + (7 & t), s)
                    : this.regWrite(t, s);
            },
            writelow: function (t, s) {
              t < 8192
                ? (this.nes.cpu.mem[2047 & t] = s)
                : t > 16407
                  ? (this.nes.cpu.mem[t] = s)
                  : t > 8199 && t < 16384
                    ? this.regWrite(8192 + (7 & t), s)
                    : this.regWrite(t, s);
            },
            load: function (t) {
              return (
                (t &= 65535),
                t > 16407
                  ? this.nes.cpu.mem[t]
                  : t >= 8192
                    ? this.regLoad(t)
                    : this.nes.cpu.mem[2047 & t]
              );
            },
            regLoad: function (t) {
              switch (t >> 12) {
                case 0:
                case 1:
                  break;
                case 2:
                case 3:
                  switch (7 & t) {
                    case 0:
                      return this.nes.cpu.mem[8192];
                    case 1:
                      return this.nes.cpu.mem[8193];
                    case 2:
                      return this.nes.ppu.readStatusRegister();
                    case 3:
                      return 0;
                    case 4:
                      return this.nes.ppu.sramLoad();
                    case 5:
                    case 6:
                      return 0;
                    case 7:
                      return this.nes.ppu.vramLoad();
                  }
                  break;
                case 4:
                  switch (t - 16405) {
                    case 0:
                      return this.nes.papu.readReg(t);
                    case 1:
                      return this.joy1Read();
                    case 2:
                      var s;
                      return (
                        (s =
                          null !== this.zapperX &&
                            null !== this.zapperY &&
                            this.nes.ppu.isPixelWhite(
                              this.zapperX,
                              this.zapperY
                            )
                            ? 0
                            : 8),
                        this.zapperFired && (s |= 16),
                        65535 & (this.joy2Read() | s)
                      );
                  }
              }
              return 0;
            },
            regWrite: function (t, s) {
              switch (t) {
                case 8192:
                  (this.nes.cpu.mem[t] = s),
                    this.nes.ppu.updateControlReg1(s);
                  break;
                case 8193:
                  (this.nes.cpu.mem[t] = s),
                    this.nes.ppu.updateControlReg2(s);
                  break;
                case 8195:
                  this.nes.ppu.writeSRAMAddress(s);
                  break;
                case 8196:
                  this.nes.ppu.sramWrite(s);
                  break;
                case 8197:
                  this.nes.ppu.scrollWrite(s);
                  break;
                case 8198:
                  this.nes.ppu.writeVRAMAddress(s);
                  break;
                case 8199:
                  this.nes.ppu.vramWrite(s);
                  break;
                case 16404:
                  this.nes.ppu.sramDMA(s);
                  break;
                case 16405:
                  this.nes.papu.writeReg(t, s);
                  break;
                case 16406:
                  0 == (1 & s) &&
                    1 == (1 & this.joypadLastWrite) &&
                    ((this.joy1StrobeState = 0), (this.joy2StrobeState = 0)),
                    (this.joypadLastWrite = s);
                  break;
                case 16407:
                  this.nes.papu.writeReg(t, s);
                  break;
                default:
                  t >= 16384 && t <= 16407 && this.nes.papu.writeReg(t, s);
              }
            },
            joy1Read: function () {
              var t;
              switch (this.joy1StrobeState) {
                case 0:
                case 1:
                case 2:
                case 3:
                case 4:
                case 5:
                case 6:
                case 7:
                  t = this.nes.controllers[1].state[this.joy1StrobeState];
                  break;
                case 8:
                case 9:
                case 10:
                case 11:
                case 12:
                case 13:
                case 14:
                case 15:
                case 16:
                case 17:
                case 18:
                  t = 0;
                  break;
                case 19:
                  t = 1;
                  break;
                default:
                  t = 0;
              }
              return (
                this.joy1StrobeState++,
                24 === this.joy1StrobeState && (this.joy1StrobeState = 0),
                t
              );
            },
            joy2Read: function () {
              var t;
              switch (this.joy2StrobeState) {
                case 0:
                case 1:
                case 2:
                case 3:
                case 4:
                case 5:
                case 6:
                case 7:
                  t = this.nes.controllers[2].state[this.joy2StrobeState];
                  break;
                case 8:
                case 9:
                case 10:
                case 11:
                case 12:
                case 13:
                case 14:
                case 15:
                case 16:
                case 17:
                case 18:
                  t = 0;
                  break;
                case 19:
                  t = 1;
                  break;
                default:
                  t = 0;
              }
              return (
                this.joy2StrobeState++,
                24 === this.joy2StrobeState && (this.joy2StrobeState = 0),
                t
              );
            },
            loadROM: function () {
              if (!this.nes.rom.valid || this.nes.rom.romCount < 1)
                throw new Error("NoMapper: Invalid ROM! Unable to load.");
              this.loadPRGROM(),
                this.loadCHRROM(),
                this.loadBatteryRam(),
                this.nes.cpu.requestIrq(this.nes.cpu.IRQ_RESET);
            },
            loadPRGROM: function () {
              this.nes.rom.romCount > 1
                ? (this.loadRomBank(0, 32768), this.loadRomBank(1, 49152))
                : (this.loadRomBank(0, 32768), this.loadRomBank(0, 49152));
            },
            loadCHRROM: function () {
              this.nes.rom.vromCount > 0 &&
                (1 === this.nes.rom.vromCount
                  ? (this.loadVromBank(0, 0), this.loadVromBank(0, 4096))
                  : (this.loadVromBank(0, 0), this.loadVromBank(1, 4096)));
            },
            loadBatteryRam: function () {
              if (this.nes.rom.batteryRam) {
                var t = this.nes.rom.batteryRam;
                null !== t &&
                  8192 === t.length &&
                  e.copyArrayElements(t, 0, this.nes.cpu.mem, 24576, 8192);
              }
            },
            loadRomBank: function (t, s) {
              (t %= this.nes.rom.romCount),
                e.copyArrayElements(
                  this.nes.rom.rom[t],
                  0,
                  this.nes.cpu.mem,
                  s,
                  16384
                );
            },
            loadVromBank: function (t, s) {
              if (0 !== this.nes.rom.vromCount) {
                this.nes.ppu.triggerRendering(),
                  e.copyArrayElements(
                    this.nes.rom.vrom[t % this.nes.rom.vromCount],
                    0,
                    this.nes.ppu.vramMem,
                    s,
                    4096
                  );
                var i = this.nes.rom.vromTile[t % this.nes.rom.vromCount];
                e.copyArrayElements(i, 0, this.nes.ppu.ptTile, s >> 4, 256);
              }
            },
            load32kRomBank: function (t, s) {
              this.loadRomBank((2 * t) % this.nes.rom.romCount, s),
                this.loadRomBank(
                  (2 * t + 1) % this.nes.rom.romCount,
                  s + 16384
                );
            },
            load8kVromBank: function (t, s) {
              0 !== this.nes.rom.vromCount &&
                (this.nes.ppu.triggerRendering(),
                  this.loadVromBank(t % this.nes.rom.vromCount, s),
                  this.loadVromBank(
                    (t + 1) % this.nes.rom.vromCount,
                    s + 4096
                  ));
            },
            load1kVromBank: function (t, s) {
              if (0 !== this.nes.rom.vromCount) {
                this.nes.ppu.triggerRendering();
                var i = Math.floor(t / 4) % this.nes.rom.vromCount,
                  h = (t % 4) * 1024;
                e.copyArrayElements(
                  this.nes.rom.vrom[i],
                  h,
                  this.nes.ppu.vramMem,
                  s,
                  1024
                );
                for (
                  var r = this.nes.rom.vromTile[i], n = s >> 4, a = 0;
                  a < 64;
                  a++
                )
                  this.nes.ppu.ptTile[n + a] = r[(t % 4 << 6) + a];
              }
            },
            load2kVromBank: function (t, s) {
              if (0 !== this.nes.rom.vromCount) {
                this.nes.ppu.triggerRendering();
                var i = Math.floor(t / 2) % this.nes.rom.vromCount,
                  h = (t % 2) * 2048;
                e.copyArrayElements(
                  this.nes.rom.vrom[i],
                  h,
                  this.nes.ppu.vramMem,
                  s,
                  2048
                );
                for (
                  var r = this.nes.rom.vromTile[i], n = s >> 4, a = 0;
                  a < 128;
                  a++
                )
                  this.nes.ppu.ptTile[n + a] = r[(t % 2 << 7) + a];
              }
            },
            load8kRomBank: function (t, s) {
              var i = Math.floor(t / 2) % this.nes.rom.romCount,
                h = (t % 2) * 8192;
              e.copyArrayElements(
                this.nes.rom.rom[i],
                h,
                this.nes.cpu.mem,
                s,
                8192
              );
            },
            clockIrqCounter: function () { },
            latchAccess: function (t) { },
            toJSON: function () {
              return {
                joy1StrobeState: this.joy1StrobeState,
                joy2StrobeState: this.joy2StrobeState,
                joypadLastWrite: this.joypadLastWrite,
              };
            },
            fromJSON: function (t) {
              (this.joy1StrobeState = t.joy1StrobeState),
                (this.joy2StrobeState = t.joy2StrobeState),
                (this.joypadLastWrite = t.joypadLastWrite);
            },
          }),
          (h[1] = function (t) {
            this.nes = t;
          }),
          (h[1].prototype = new h[0]()),
          (h[1].prototype.reset = function () {
            h[0].prototype.reset.apply(this),
              (this.regBuffer = 0),
              (this.regBufferCounter = 0),
              (this.mirroring = 0),
              (this.oneScreenMirroring = 0),
              (this.prgSwitchingArea = 1),
              (this.prgSwitchingSize = 1),
              (this.vromSwitchingSize = 0),
              (this.romSelectionReg0 = 0),
              (this.romSelectionReg1 = 0),
              (this.romBankSelect = 0);
          }),
          (h[1].prototype.write = function (t, s) {
            if (t < 32768)
              return void h[0].prototype.write.apply(this, arguments);
            0 != (128 & s)
              ? ((this.regBufferCounter = 0),
                (this.regBuffer = 0),
                0 === this.getRegNumber(t) &&
                ((this.prgSwitchingArea = 1), (this.prgSwitchingSize = 1)))
              : ((this.regBuffer =
                (this.regBuffer & (255 - (1 << this.regBufferCounter))) |
                ((1 & s) << this.regBufferCounter)),
                5 === ++this.regBufferCounter &&
                (this.setReg(this.getRegNumber(t), this.regBuffer),
                  (this.regBuffer = 0),
                  (this.regBufferCounter = 0)));
          }),
          (h[1].prototype.setReg = function (t, s) {
            var i;
            switch (t) {
              case 0:
                (i = 3 & s),
                  i !== this.mirroring &&
                  ((this.mirroring = i),
                    0 == (2 & this.mirroring)
                      ? this.nes.ppu.setMirroring(
                        this.nes.rom.SINGLESCREEN_MIRRORING
                      )
                      : 0 != (1 & this.mirroring)
                        ? this.nes.ppu.setMirroring(
                          this.nes.rom.HORIZONTAL_MIRRORING
                        )
                        : this.nes.ppu.setMirroring(
                          this.nes.rom.VERTICAL_MIRRORING
                        )),
                  (this.prgSwitchingArea = (s >> 2) & 1),
                  (this.prgSwitchingSize = (s >> 3) & 1),
                  (this.vromSwitchingSize = (s >> 4) & 1);
                break;
              case 1:
                (this.romSelectionReg0 = (s >> 4) & 1),
                  this.nes.rom.vromCount > 0 &&
                  (0 === this.vromSwitchingSize
                    ? 0 === this.romSelectionReg0
                      ? this.load8kVromBank(15 & s, 0)
                      : this.load8kVromBank(
                        Math.floor(this.nes.rom.vromCount / 2) + (15 & s),
                        0
                      )
                    : 0 === this.romSelectionReg0
                      ? this.loadVromBank(15 & s, 0)
                      : this.loadVromBank(
                        Math.floor(this.nes.rom.vromCount / 2) + (15 & s),
                        0
                      ));
                break;
              case 2:
                (this.romSelectionReg1 = (s >> 4) & 1),
                  this.nes.rom.vromCount > 0 &&
                  1 === this.vromSwitchingSize &&
                  (0 === this.romSelectionReg1
                    ? this.loadVromBank(15 & s, 4096)
                    : this.loadVromBank(
                      Math.floor(this.nes.rom.vromCount / 2) + (15 & s),
                      4096
                    ));
                break;
              default:
                i = 15 & s;
                var e,
                  h = 0;
                this.nes.rom.romCount >= 32
                  ? 0 === this.vromSwitchingSize
                    ? 1 === this.romSelectionReg0 && (h = 16)
                    : (h =
                      (this.romSelectionReg0 |
                        (this.romSelectionReg1 << 1)) <<
                      3)
                  : this.nes.rom.romCount >= 16 &&
                  1 === this.romSelectionReg0 &&
                  (h = 8),
                  0 === this.prgSwitchingSize
                    ? ((e = h + (15 & s)), this.load32kRomBank(e, 32768))
                    : ((e = 2 * h + (15 & s)),
                      0 === this.prgSwitchingArea
                        ? this.loadRomBank(e, 49152)
                        : this.loadRomBank(e, 32768));
            }
          }),
          (h[1].prototype.getRegNumber = function (t) {
            return t >= 32768 && t <= 40959
              ? 0
              : t >= 40960 && t <= 49151
                ? 1
                : t >= 49152 && t <= 57343
                  ? 2
                  : 3;
          }),
          (h[1].prototype.loadROM = function () {
            if (!this.nes.rom.valid)
              throw new Error("MMC1: Invalid ROM! Unable to load.");
            this.loadRomBank(0, 32768),
              this.loadRomBank(this.nes.rom.romCount - 1, 49152),
              this.loadCHRROM(),
              this.loadBatteryRam(),
              this.nes.cpu.requestIrq(this.nes.cpu.IRQ_RESET);
          }),
          (h[1].prototype.switchLowHighPrgRom = function (t) { }),
          (h[1].prototype.switch16to32 = function () { }),
          (h[1].prototype.switch32to16 = function () { }),
          (h[1].prototype.toJSON = function () {
            var t = h[0].prototype.toJSON.apply(this);
            return (
              (t.mirroring = this.mirroring),
              (t.oneScreenMirroring = this.oneScreenMirroring),
              (t.prgSwitchingArea = this.prgSwitchingArea),
              (t.prgSwitchingSize = this.prgSwitchingSize),
              (t.vromSwitchingSize = this.vromSwitchingSize),
              (t.romSelectionReg0 = this.romSelectionReg0),
              (t.romSelectionReg1 = this.romSelectionReg1),
              (t.romBankSelect = this.romBankSelect),
              (t.regBuffer = this.regBuffer),
              (t.regBufferCounter = this.regBufferCounter),
              t
            );
          }),
          (h[1].prototype.fromJSON = function (t) {
            h[0].prototype.fromJSON.apply(this, arguments),
              (this.mirroring = t.mirroring),
              (this.oneScreenMirroring = t.oneScreenMirroring),
              (this.prgSwitchingArea = t.prgSwitchingArea),
              (this.prgSwitchingSize = t.prgSwitchingSize),
              (this.vromSwitchingSize = t.vromSwitchingSize),
              (this.romSelectionReg0 = t.romSelectionReg0),
              (this.romSelectionReg1 = t.romSelectionReg1),
              (this.romBankSelect = t.romBankSelect),
              (this.regBuffer = t.regBuffer),
              (this.regBufferCounter = t.regBufferCounter);
          }),
          (h[2] = function (t) {
            this.nes = t;
          }),
          (h[2].prototype = new h[0]()),
          (h[2].prototype.write = function (t, s) {
            if (t < 32768)
              return void h[0].prototype.write.apply(this, arguments);
            this.loadRomBank(s, 32768);
          }),
          (h[2].prototype.loadROM = function () {
            if (!this.nes.rom.valid)
              throw new Error("UNROM: Invalid ROM! Unable to load.");
            this.loadRomBank(0, 32768),
              this.loadRomBank(this.nes.rom.romCount - 1, 49152),
              this.loadCHRROM(),
              this.nes.cpu.requestIrq(this.nes.cpu.IRQ_RESET);
          }),
          (h[3] = function (t) {
            this.nes = t;
          }),
          (h[3].prototype = new h[0]()),
          (h[3].prototype.write = function (t, s) {
            if (t < 32768)
              return void h[0].prototype.write.apply(this, arguments);
            var i = (s % (this.nes.rom.vromCount / 2)) * 2;
            this.loadVromBank(i, 0),
              this.loadVromBank(i + 1, 4096),
              this.load8kVromBank(2 * s, 0);
          }),
          (h[4] = function (t) {
            (this.nes = t),
              (this.CMD_SEL_2_1K_VROM_0000 = 0),
              (this.CMD_SEL_2_1K_VROM_0800 = 1),
              (this.CMD_SEL_1K_VROM_1000 = 2),
              (this.CMD_SEL_1K_VROM_1400 = 3),
              (this.CMD_SEL_1K_VROM_1800 = 4),
              (this.CMD_SEL_1K_VROM_1C00 = 5),
              (this.CMD_SEL_ROM_PAGE1 = 6),
              (this.CMD_SEL_ROM_PAGE2 = 7),
              (this.command = null),
              (this.prgAddressSelect = null),
              (this.chrAddressSelect = null),
              (this.pageNumber = null),
              (this.irqCounter = null),
              (this.irqLatchValue = null),
              (this.irqEnable = null),
              (this.prgAddressChanged = !1);
          }),
          (h[4].prototype = new h[0]()),
          (h[4].prototype.write = function (t, s) {
            if (t < 32768)
              return void h[0].prototype.write.apply(this, arguments);
            switch (t) {
              case 32768:
                this.command = 7 & s;
                var i = (s >> 6) & 1;
                i !== this.prgAddressSelect && (this.prgAddressChanged = !0),
                  (this.prgAddressSelect = i),
                  (this.chrAddressSelect = (s >> 7) & 1);
                break;
              case 32769:
                this.executeCommand(this.command, s);
                break;
              case 40960:
                0 != (1 & s)
                  ? this.nes.ppu.setMirroring(
                    this.nes.rom.HORIZONTAL_MIRRORING
                  )
                  : this.nes.ppu.setMirroring(
                    this.nes.rom.VERTICAL_MIRRORING
                  );
                break;
              case 40961:
                break;
              case 49152:
                this.irqCounter = s;
                break;
              case 49153:
                this.irqLatchValue = s;
                break;
              case 57344:
                this.irqEnable = 0;
                break;
              case 57345:
                this.irqEnable = 1;
            }
          }),
          (h[4].prototype.executeCommand = function (t, s) {
            switch (t) {
              case this.CMD_SEL_2_1K_VROM_0000:
                0 === this.chrAddressSelect
                  ? (this.load1kVromBank(s, 0),
                    this.load1kVromBank(s + 1, 1024))
                  : (this.load1kVromBank(s, 4096),
                    this.load1kVromBank(s + 1, 5120));
                break;
              case this.CMD_SEL_2_1K_VROM_0800:
                0 === this.chrAddressSelect
                  ? (this.load1kVromBank(s, 2048),
                    this.load1kVromBank(s + 1, 3072))
                  : (this.load1kVromBank(s, 6144),
                    this.load1kVromBank(s + 1, 7168));
                break;
              case this.CMD_SEL_1K_VROM_1000:
                0 === this.chrAddressSelect
                  ? this.load1kVromBank(s, 4096)
                  : this.load1kVromBank(s, 0);
                break;
              case this.CMD_SEL_1K_VROM_1400:
                0 === this.chrAddressSelect
                  ? this.load1kVromBank(s, 5120)
                  : this.load1kVromBank(s, 1024);
                break;
              case this.CMD_SEL_1K_VROM_1800:
                0 === this.chrAddressSelect
                  ? this.load1kVromBank(s, 6144)
                  : this.load1kVromBank(s, 2048);
                break;
              case this.CMD_SEL_1K_VROM_1C00:
                0 === this.chrAddressSelect
                  ? this.load1kVromBank(s, 7168)
                  : this.load1kVromBank(s, 3072);
                break;
              case this.CMD_SEL_ROM_PAGE1:
                this.prgAddressChanged &&
                  (0 === this.prgAddressSelect
                    ? this.load8kRomBank(
                      2 * (this.nes.rom.romCount - 1),
                      49152
                    )
                    : this.load8kRomBank(
                      2 * (this.nes.rom.romCount - 1),
                      32768
                    ),
                    (this.prgAddressChanged = !1)),
                  0 === this.prgAddressSelect
                    ? this.load8kRomBank(s, 32768)
                    : this.load8kRomBank(s, 49152);
                break;
              case this.CMD_SEL_ROM_PAGE2:
                this.load8kRomBank(s, 40960),
                  this.prgAddressChanged &&
                  (0 === this.prgAddressSelect
                    ? this.load8kRomBank(
                      2 * (this.nes.rom.romCount - 1),
                      49152
                    )
                    : this.load8kRomBank(
                      2 * (this.nes.rom.romCount - 1),
                      32768
                    ),
                    (this.prgAddressChanged = !1));
            }
          }),
          (h[4].prototype.loadROM = function () {
            if (!this.nes.rom.valid)
              throw new Error("MMC3: Invalid ROM! Unable to load.");
            this.load8kRomBank(2 * (this.nes.rom.romCount - 1), 49152),
              this.load8kRomBank(2 * (this.nes.rom.romCount - 1) + 1, 57344),
              this.load8kRomBank(0, 32768),
              this.load8kRomBank(1, 40960),
              this.loadCHRROM(),
              this.loadBatteryRam(),
              this.nes.cpu.requestIrq(this.nes.cpu.IRQ_RESET);
          }),
          (h[4].prototype.clockIrqCounter = function () {
            1 === this.irqEnable &&
              --this.irqCounter < 0 &&
              (this.nes.cpu.requestIrq(this.nes.cpu.IRQ_NORMAL),
                (this.irqCounter = this.irqLatchValue));
          }),
          (h[4].prototype.toJSON = function () {
            var t = h[0].prototype.toJSON.apply(this);
            return (
              (t.command = this.command),
              (t.prgAddressSelect = this.prgAddressSelect),
              (t.chrAddressSelect = this.chrAddressSelect),
              (t.pageNumber = this.pageNumber),
              (t.irqCounter = this.irqCounter),
              (t.irqLatchValue = this.irqLatchValue),
              (t.irqEnable = this.irqEnable),
              (t.prgAddressChanged = this.prgAddressChanged),
              t
            );
          }),
          (h[4].prototype.fromJSON = function (t) {
            h[0].prototype.fromJSON.apply(this, arguments),
              (this.command = t.command),
              (this.prgAddressSelect = t.prgAddressSelect),
              (this.chrAddressSelect = t.chrAddressSelect),
              (this.pageNumber = t.pageNumber),
              (this.irqCounter = t.irqCounter),
              (this.irqLatchValue = t.irqLatchValue),
              (this.irqEnable = t.irqEnable),
              (this.prgAddressChanged = t.prgAddressChanged);
          }),
          (h[5] = function (t) {
            this.nes = t;
          }),
          (h[5].prototype = new h[0]()),
          (h[5].prototype.write = function (t, s) {
            t < 32768
              ? h[0].prototype.write.apply(this, arguments)
              : this.load8kVromBank(s, 0);
          }),
          (h[5].prototype.write = function (t, s) {
            if (t < 20480)
              return void h[0].prototype.write.apply(this, arguments);
            switch (t) {
              case 20736:
                this.prg_size = 3 & s;
                break;
              case 20737:
                this.chr_size = 3 & s;
                break;
              case 20738:
                this.sram_we_a = 3 & s;
                break;
              case 20739:
                this.sram_we_b = 3 & s;
                break;
              case 20740:
                this.graphic_mode = 3 & s;
                break;
              case 20741:
                (this.nametable_mode = s),
                  (this.nametable_type[0] = 3 & s),
                  this.load1kVromBank(3 & s, 8192),
                  (s >>= 2),
                  (this.nametable_type[1] = 3 & s),
                  this.load1kVromBank(3 & s, 9216),
                  (s >>= 2),
                  (this.nametable_type[2] = 3 & s),
                  this.load1kVromBank(3 & s, 10240),
                  (s >>= 2),
                  (this.nametable_type[3] = 3 & s),
                  this.load1kVromBank(3 & s, 11264);
                break;
              case 20742:
                this.fill_chr = s;
                break;
              case 20743:
                this.fill_pal = 3 & s;
                break;
              case 20755:
                this.SetBank_SRAM(3, 3 & s);
                break;
              case 20756:
              case 20757:
              case 20758:
              case 20759:
                this.SetBank_CPU(t, s);
                break;
              case 20768:
              case 20769:
              case 20770:
              case 20771:
              case 20772:
              case 20773:
              case 20774:
              case 20775:
                (this.chr_mode = 0),
                  (this.chr_page[0][7 & t] = s),
                  this.SetBank_PPU();
                break;
              case 20776:
              case 20777:
              case 20778:
              case 20779:
                (this.chr_mode = 1),
                  (this.chr_page[1][0 + (3 & t)] = s),
                  (this.chr_page[1][4 + (3 & t)] = s),
                  this.SetBank_PPU();
                break;
              case 20992:
                this.split_control = s;
                break;
              case 20993:
                this.split_scroll = s;
                break;
              case 20994:
                this.split_page = 63 & s;
                break;
              case 20995:
                (this.irq_line = s), this.nes.cpu.ClearIRQ();
                break;
              case 20996:
                (this.irq_enable = s), this.nes.cpu.ClearIRQ();
                break;
              case 20997:
                this.mult_a = s;
                break;
              case 20998:
                this.mult_b = s;
                break;
              default:
                t >= 20480 && t <= 20501
                  ? this.nes.papu.exWrite(t, s)
                  : t >= 23552 && t <= 24575
                    ? 2 === this.graphic_mode ||
                    (3 !== this.graphic_mode && this.irq_status)
                    : t >= 24576 &&
                    t <= 32767 &&
                    2 === this.sram_we_a &&
                    this.sram_we_b;
            }
          }),
          (h[5].prototype.loadROM = function () {
            if (!this.nes.rom.valid)
              throw new Error("UNROM: Invalid ROM! Unable to load.");
            this.load8kRomBank(2 * this.nes.rom.romCount - 1, 32768),
              this.load8kRomBank(2 * this.nes.rom.romCount - 1, 40960),
              this.load8kRomBank(2 * this.nes.rom.romCount - 1, 49152),
              this.load8kRomBank(2 * this.nes.rom.romCount - 1, 57344),
              this.loadCHRROM(),
              this.nes.cpu.requestIrq(this.nes.cpu.IRQ_RESET);
          }),
          (h[7] = function (t) {
            this.nes = t;
          }),
          (h[7].prototype = new h[0]()),
          (h[7].prototype.write = function (t, s) {
            t < 32768
              ? h[0].prototype.write.apply(this, arguments)
              : (this.load32kRomBank(7 & s, 32768),
                16 & s
                  ? this.nes.ppu.setMirroring(
                    this.nes.rom.SINGLESCREEN_MIRRORING2
                  )
                  : this.nes.ppu.setMirroring(
                    this.nes.rom.SINGLESCREEN_MIRRORING
                  ));
          }),
          (h[7].prototype.loadROM = function () {
            if (!this.nes.rom.valid)
              throw new Error("AOROM: Invalid ROM! Unable to load.");
            this.loadPRGROM(),
              this.loadCHRROM(),
              this.nes.cpu.requestIrq(this.nes.cpu.IRQ_RESET);
          }),
          (h[11] = function (t) {
            this.nes = t;
          }),
          (h[11].prototype = new h[0]()),
          (h[11].prototype.write = function (t, s) {
            if (t < 32768)
              return void h[0].prototype.write.apply(this, arguments);
            var i = (2 * (15 & s)) % this.nes.rom.romCount,
              e = (2 * (15 & s) + 1) % this.nes.rom.romCount;
            if (
              (this.loadRomBank(i, 32768),
                this.loadRomBank(e, 49152),
                this.nes.rom.vromCount > 0)
            ) {
              var r = (2 * (s >> 4)) % this.nes.rom.vromCount;
              this.loadVromBank(r, 0), this.loadVromBank(r + 1, 4096);
            }
          }),
          (h[34] = function (t) {
            this.nes = t;
          }),
          (h[34].prototype = new h[0]()),
          (h[34].prototype.write = function (t, s) {
            if (t < 32768)
              return void h[0].prototype.write.apply(this, arguments);
            this.load32kRomBank(s, 32768);
          }),
          (h[38] = function (t) {
            this.nes = t;
          }),
          (h[38].prototype = new h[0]()),
          (h[38].prototype.write = function (t, s) {
            if (t < 28672 || t > 32767)
              return void h[0].prototype.write.apply(this, arguments);
            this.load32kRomBank(3 & s, 32768),
              this.load8kVromBank(2 * ((s >> 2) & 3), 0);
          }),
          (h[66] = function (t) {
            this.nes = t;
          }),
          (h[66].prototype = new h[0]()),
          (h[66].prototype.write = function (t, s) {
            if (t < 32768)
              return void h[0].prototype.write.apply(this, arguments);
            this.load32kRomBank((s >> 4) & 3, 32768),
              this.load8kVromBank(2 * (3 & s), 0);
          }),
          (h[94] = function (t) {
            this.nes = t;
          }),
          (h[94].prototype = new h[0]()),
          (h[94].prototype.write = function (t, s) {
            if (t < 32768)
              return void h[0].prototype.write.apply(this, arguments);
            this.loadRomBank(s >> 2, 32768);
          }),
          (h[94].prototype.loadROM = function () {
            if (!this.nes.rom.valid)
              throw new Error("UN1ROM: Invalid ROM! Unable to load.");
            this.loadRomBank(0, 32768),
              this.loadRomBank(this.nes.rom.romCount - 1, 49152),
              this.loadCHRROM(),
              this.nes.cpu.requestIrq(this.nes.cpu.IRQ_RESET);
          }),
          (h[140] = function (t) {
            this.nes = t;
          }),
          (h[140].prototype = new h[0]()),
          (h[140].prototype.write = function (t, s) {
            if (t < 24576 || t > 32767)
              return void h[0].prototype.write.apply(this, arguments);
            this.load32kRomBank((s >> 4) & 3, 32768),
              this.load8kVromBank(2 * (15 & s), 0);
          }),
          (h[180] = function (t) {
            this.nes = t;
          }),
          (h[180].prototype = new h[0]()),
          (h[180].prototype.write = function (t, s) {
            if (t < 32768)
              return void h[0].prototype.write.apply(this, arguments);
            this.loadRomBank(s, 49152);
          }),
          (h[180].prototype.loadROM = function () {
            if (!this.nes.rom.valid)
              throw new Error("Mapper 180: Invalid ROM! Unable to load.");
            this.loadRomBank(0, 32768),
              this.loadRomBank(this.nes.rom.romCount - 1, 49152),
              this.loadCHRROM(),
              this.nes.cpu.requestIrq(this.nes.cpu.IRQ_RESET);
          }),
          (t.exports = h);
      },
    ]);
  });
    //# sourceMappingURL=jsnes.min.js.map
</script>
<script>
  const RECENT_ITEMS_KEY = "nes_recent_items";
  const MAX_RECENTS_COUNT = 4;
  const ROMS_PAGE_SIZE = 8;

  const REMOTE_CONTROL_ROOM = "nes remote control";

  class RemoteNes {
    constructor(url, player) {
      this.socket = io(url);
      this.socket.emit("join room", REMOTE_CONTROL_ROOM);
      this.player = player;
    }
    buttonDown(_, key) {
      this.socket.emit("chat message", {
        down: true,
        player: this.player,
        key,
      });
    }

    buttonUp(_, key) {
      this.socket.emit("chat message", {
        down: false,
        player: this.player,
        key,
      });
    }

    close() {
      this.socket.disconnect();
    }
  }

  class RemoteController {
    constructor(url, down, up) {
      this.socket = io(url);
      this.socket.emit("join room", REMOTE_CONTROL_ROOM);
      this.socket.on("welcome", () => {
        this.socket.on("chat message", ({ down, player, key }) => {
          if (down) {
            this.down(player, key);
          } else {
            this.up(player, key);
          }
        });
      });
      this.down = down;
      this.up = up;
    }

    close() {
      this.socket.disconnect();
    }
  }

  const getChildren = async (/** @type string */ path) => {
    let items = [];
    try {
      const content = await (await fetch(path)).text();
      for (let i of content.matchAll(
        /<a href="(.*?)\/?">(.*?)(\/?)<\/a>(.*?\S)\s\s/g
      )) {
        let item = { path: i[1], name: decodeURIComponent(i[1]), type: "" };
        if (item.path == "..") {
          continue;
        }
        if (!i[3]) {
          item.type = item.name.replace(/^.*\./, "").toLowerCase();
          item.name = item.name.replace(/\.[^.]*$/, "");
          item.date = new Date(i[4].trim());
          item.resourcePath = path + item.path;
        } else {
          item.resourcePath = path + item.path + "/";
        }

        items.push(item);
      }
    } catch (e) {
      items = [];
    }
    return items;
  };

  class App {
    constructor() {
      /** @type { Object.<string,HTMLElement> } */
      this.components;
      registerProperties(
        this,
        "title",
        "playing",
        "paused",
        "fps",
        "functions",
        "directions",
        "pressed_left",
        "pressed_up",
        "pressed_right",
        "pressed_down",
        "pressed_select",
        "pressed_start",
        "pressed_a",
        "pressed_b",
        "roms",
        "currentRom",
        "selectedRom",
        "selectedPage",
        "selectedRoms",
        "recents",
        "currentButtons",
        "isHost",
        "isClient",
        "remoteNes",
        "remoteController",
        "remotePlayer",
        "gamepad",
        "handlingGamepad"
      );
    }

    toogleIsHost() {
      this.isHost = !this.isHost;
      if (this.isHost) {
        this.remoteController = new RemoteController(
          this.data.serverUrl || undefined,
          (p, k) => this.handleKeyDown(p, k),
          (p, k) => this.handleKeyUp(p, k)
        );
      } else if (this.remoteController) {
        this.remoteController.close();
        this.remoteController = undefined;
      }
    }

    toogleIsClient(player) {
      this.isClient = !this.isClient;
      this.updatePaused(this.isClient);
      if (this.isClient) {
        this.remotePlayer = player;
        this.remoteNes = new RemoteNes(
          this.data.serverUrl || undefined,
          this.remotePlayer
        );
      } else {
        this, (this.remotePlayer = undefined);
        if (this.remoteNes) {
          this.remoteNes.close();
          this.remoteNes = undefined;
        }
      }
    }

    async initAudioBuffers() {
      this.AUDIO_BUFFERING = 512;
      this.SAMPLE_COUNT = 4 * 1024;
      this.SAMPLE_MASK = this.SAMPLE_COUNT - 1;
      this.lAudioBuffer = new Float32Array(this.SAMPLE_COUNT);
      this.rAudioBuffer = new Float32Array(this.SAMPLE_COUNT);
      this.wAudioCursor = 0;
      this.rAudioCursor = 0;
    }

    async initNes() {
      await this.initAudioBuffers();
      this.updateFrame = this.updateFrame.bind(this);
      this.canvasWidth = 256;
      this.canvasHeight = 240;
      this.canvasSize = this.canvasWidth * this.canvasHeight;
      const canvas = this.components.canvas;
      canvas.width = this.canvasWidth;
      canvas.height = this.canvasHeight;
      this.canvasCtx = canvas.getContext("2d");
      this.image = this.canvasCtx.getImageData(
        0,
        0,
        this.canvasWidth,
        this.canvasHeight
      );
      this.canvasCtx.fillStyle = "black";
      this.canvasCtx.fillRect(0, 0, this.canvasWidth, this.canvasHeight);
      const buffer = new ArrayBuffer(this.image.data.length);
      this.framebuffer_u8 = new Uint8ClampedArray(buffer);
      this.framebuffer_u32 = new Uint32Array(buffer);
      this.nes = new jsnes.NES({
        onFrame: (framebuffer_24) => {
          for (var i = 0; i < this.canvasSize; i++)
            this.framebuffer_u32[i] = 0xff000000 | framebuffer_24[i];
        },
        onAudioSample: (l, r) => {
          this.lAudioBuffer[this.wAudioCursor] = l;
          this.rAudioBuffer[this.wAudioCursor] = r;
          this.wAudioCursor = (this.wAudioCursor + 1) & this.SAMPLE_MASK;
        },
        onStatusUpdate: (...args) => {
          console.log(args);
        },
        // sampleRate: 48000
      });
      window.nes = this.nes;
      document.addEventListener("keydown", (event) => {
        this.onKeyBoard(this.buttonDownWraper.bind(this), event);
      });
      document.addEventListener("keyup", (event) => {
        this.onKeyBoard(this.buttonUpWraper.bind(this), event);
      });
      window.addEventListener("gamepadconnected", (e) => {
        this.gamepad = true;
        console.log(
          "控制器已连接于 %d 位: %s. %d 个按钮, %d 个坐标方向。",
          e.gamepad.index,
          e.gamepad.id,
          e.gamepad.buttons.length,
          e.gamepad.axes.length
        );
        this.handleGamePad();
      });
      window.addEventListener("gamepaddisconnected", (e) => {
        this.gamepad = false;
      });
    }

    async handleGamePad() {
      if (this.handlingGamepad) {
        return;
      }
      this.handlingGamepad = true;
      const checkPeriod = (1000 / (this.fps || 60)) * 10;
      let last = Date.now();
      while (this.gamepad) {
        let now = Date.now();
        const remain = last + checkPeriod - now;
        if (remain > 0) {
          await sleep(remain);
        }
        this.updateCurrentButtons(this.getCurrentGamepadButtons());
        last = now;
      }
      this.handlingGamepad = false;
    }

    getCurrentGamepadButtons() {
      const gamepad = navigator.getGamepads()[0];
      if (!gamepad) {
        return new Set();
      }
      const map = new Map([
        [0, "a"],
        [2, "a"],
        [4, "m-select"],
        [6, "a"],
        [1, "b"],
        [3, "b"],
        [5, "m-start"],
        [7, "b"],
        [12, "up"],
        [13, "down"],
        [14, "left"],
        [15, "right"],
        [8, "select"],
        [9, "start"],
      ]);
      const ids = gamepad.buttons
        .map((v, idx) => [v, idx])
        .filter(([{ pressed }]) => pressed)
        .map(([_, idx]) => idx);
      // if (ids.length) {
      //   console.log(ids)
      // }
      const thread = 0.15;
      const buttons = ids.map((i) => map.get(i));
      if (gamepad.axes?.[0] < -thread) {
        buttons.push("left");
      }
      if (gamepad.axes?.[0] > thread) {
        buttons.push("right");
      }

      if (gamepad.axes?.[1] < -thread) {
        buttons.push("up");
      }
      if (gamepad.axes?.[1] > thread) {
        buttons.push("down");
      }
      if (gamepad.axes?.[2] < -thread) {
        buttons.push("m-left");
      }
      if (gamepad.axes?.[2] > thread) {
        buttons.push("m-right");
      }

      if (gamepad.axes?.[3] < -thread) {
        buttons.push("m-up");
      }
      if (gamepad.axes?.[3] > thread) {
        buttons.push("m-down");
      }
      return new Set(buttons);
    }

    getNesKey(key) {
      const keys = [
        "a",
        "b",
        "select",
        "start",
        "up",
        "down",
        "left",
        "right",
      ];
      return keys.indexOf(key);
    }

    handleKeyDown(player, key) {
      const combinedKeys = key.split("_");
      if (combinedKeys.length > 1) {
        combinedKeys.forEach((k) => this.handleKeyDown(player, k));
        return;
      }
      if (key.startsWith("m-")) {
      } else {
        this.nes.buttonDown(player, this.getNesKey(key));
      }
    }

    handleKeyUp(player, key) {
      const combinedKeys = key.split("_");
      if (combinedKeys.length > 1) {
        combinedKeys.forEach((k) => this.handleKeyUp(player, k));
        return;
      }
      if (key.startsWith("m-")) {
        switch (key) {
          case "m-select":
            this.updateSelectedInRecents(1);
            break;
          case "m-down":
            this.updateSelectedInAll(1);
            break;
          case "m-up":
            this.updateSelectedInAll(-1);
            break;
          case "m-left":
            this.updateSelectedPage(this.selectedPage - 1);
            break;
          case "m-right":
            this.updateSelectedPage(this.selectedPage + 1);
            break;
          case "m-start":
            this.loadRom(this.selectedRom);
            break;
          default:
            break;
        }
      } else {
        this.nes.buttonUp(player, this.getNesKey(key));
      }
    }

    buttonDownWraper(player, key) {
      // this.remoteNes
      if (this.remoteNes) {
        this.remoteNes.buttonDown(player, key);
      } else {
        this.handleKeyDown(player, key);
      }
    }

    updateSelectedIn(offset, roms) {
      let idx = roms.findIndex((i) => i == this.selectedRom);
      if (idx < 0) {
        idx > 0;
      }
      idx += offset;
      this.selectedRom = roms[idx % roms.length];
    }

    updateSelectedInAll(offset) {
      this.updateSelectedIn(offset, this.selectedRoms);
    }

    updateSelectedInRecents(offset) {
      this.updateSelectedIn(offset, this.recents);
    }

    buttonUpWraper(player, key) {
      // this.remoteNes
      if (this.remoteNes) {
        this.remoteNes.buttonUp(player, key);
      } else {
        this.handleKeyUp(player, key);
      }
    }

    async updateAudioBuffers(event) {
      const dst = event.outputBuffer;
      const len = dst.length;

      const l = dst.getChannelData(0);
      const r = dst.getChannelData(1);
      for (var i = 0; i < len; i++) {
        const idx = (this.rAudioCursor + i) & this.SAMPLE_MASK;
        l[i] = this.lAudioBuffer[idx];
        r[i] = this.rAudioBuffer[idx];
      }

      this.rAudioCursor = (this.rAudioCursor + len) & this.SAMPLE_MASK;
    }

    onKeyBoard(callback, event) {
      let player = 1;
      // const controls = ['BUTTON_A', 'BUTTON_B', 'BUTTON_SELECT', 'BUTTON_START', 'BUTTON_UP', 'BUTTON_DOWN', 'BUTTON_LEFT', 'BUTTON_RIGHT']
      switch (event.code) {
        case "KeyW":
          callback(player, "up");
          break;
        case "KeyS":
          callback(player, "down");
          break;
        case "KeyA":
          callback(player, "left");
          break;
        case "KeyD":
          callback(player, "right");
          break;
        case "KeyJ":
          callback(player, "a");
          break;
        case "KeyK":
          callback(player, "b");
          break;
        case "KeyI":
          callback(player, "select");
          break;
        case "KeyO":
          callback(player, "start");
          break;
        case "ArrowLeft":
          callback(player, "m-left");
          break;
        case "ArrowRight":
          callback(player, "m-right");
          break;
        case "ArrowUp":
          callback(player, "m-up");
          break;
        case "ArrowDown":
          callback(player, "m-down");
          break;
        case "Space":
          callback(player, "m-select");
          break;
        case "Enter":
          callback(player, "m-start");
          break;
        default:
          break;
      }
    }

    directionsDown(event) {
      this.updateCurrentButtons(this.getCurrentButtons(event));
    }

    directionsUp() {
      this.updateCurrentButtons(new Set());
    }

    getCurrentButtons(/** @type PointerEvent */ event, largethread = false) {
      const directions = new Set();
      /** @type HTMLElement */
      const container = event.currentTarget;
      const thread = largethread ? 1 / 2 : 2 / 5;
      const kx = event.clientX;
      const ky = event.clientY;
      const cleft = container.offsetLeft;
      const cwidth = container.clientWidth;
      const xthread = cwidth * thread;
      const xxthread = largethread ? 2 * xthread : 0;
      const cright = cleft + cwidth;
      const ctop = container.offsetTop;
      const cheight = container.clientHeight;
      const cbottom = ctop + cheight;
      const ythread = cwidth * thread;
      const yythread = largethread ? 2 * ythread : 0;

      if (
        kx < cleft - xxthread ||
        kx > cright + xxthread ||
        ky < ctop - yythread ||
        ky > cbottom + yythread
      ) {
        return directions;
      }
      if (kx - cleft < xthread) {
        directions.add("left");
      } else if (cright - kx < xthread) {
        directions.add("right");
      }
      if (ky - ctop < ythread) {
        directions.add("up");
      } else if (cbottom - ky < ythread) {
        directions.add("down");
      }
      return directions;
    }

    updateCurrentButtons(newDirections) {
      for (let key of this.currentButtons) {
        if (!newDirections.has(key)) {
          this.onkey(key);
        }
      }
      for (let key of newDirections) {
        if (!this.currentButtons.has(key)) {
          this.onkey(key, true);
        }
      }
      this.currentButtons = newDirections;
      this.directions = [...this.directions];
    }

    directionsMove(event) {
      const checkPeriod = 1000 / this.fps;
      this.last = this.last || Date.now();
      let now = Date.now();
      if (now - this.last < checkPeriod) {
        return;
      }
      this.updateCurrentButtons(this.getCurrentButtons(event));
      this.last = now;
    }

    onkey(/**@type string */ key, down) {
      if (!key) {
        return;
      }
      const pressedKey = "pressed_" + key;
      if (this[pressedKey] === down) {
        return;
      }
      this[pressedKey] = down;
      if (down) {
        this.buttonDownWraper(1, key);
      } else {
        this.buttonUpWraper(1, key);
      }
    }

    async saveRecents() {
      window.localStorage?.setItem(
        RECENT_ITEMS_KEY,
        JSON.stringify(this.recents)
      );
    }

    async loadRecents() {
      const str = window.localStorage?.getItem(RECENT_ITEMS_KEY);
      if (!str) {
        return [];
      }
      try {
        return Array.from(JSON.parse(str));
      } catch {
        return [];
      }
    }

    async tryLoad(url) {
      this.playing = false;
      this.paused = false;
      const romData = await new Promise(async (resolve) => {
        let fr = new FileReader();
        fr.onload = () => {
          resolve(fr.result);
        };
        fr.readAsBinaryString(await (await fetch(url)).blob());
      });

      try {
        this.nes.loadROM(romData);
      } catch {
        return false;
      }
      this.fps = this.nes.opts.preferredFrameRate || 60;
      return true;
    }

    updateFrame() {
      if (!this.playing || this.paused) {
        return;
      }
      window.requestAnimationFrame(this.updateFrame);
      this.image.data.set(this.framebuffer_u8);
      this.canvasCtx.putImageData(this.image, 0, 0);
    }

    async play() {
      this.playing = true;
      window.requestAnimationFrame(this.updateFrame);
      let last = Date.now();
      let mspf = Math.floor(1000 / this.fps);
      this.nes.frame();
      while (true) {
        if (!this.playing) {
          break;
        }
        let now = Date.now();
        let remain = last + mspf - now;
        if (remain > 0) {
          await sleep(mspf);
          continue;
        }
        if (this.paused) {
          await sleep(mspf);
          continue;
        }
        this.nes.frame();
        last = now;
      }
    }

    async updatePaused(paused) {
      this.paused = !this.paused;
      if (!this.paused) {
        window.requestAnimationFrame(this.updateFrame);
      } else {
      }
    }

    async initAudio() {
      const audio_ctx = new window.AudioContext();
      const script_processor = audio_ctx.createScriptProcessor(
        this.AUDIO_BUFFERING,
        0,
        2
      );
      script_processor.addEventListener(
        "audioprocess",
        this.updateAudioBuffers.bind(this)
      );
      script_processor.connect(audio_ctx.destination);
    }

    async loadRom(item) {
      if (this.currentRom?.resourcePath === item.resourcePath) {
        return;
      }
      if (!item) {
        return;
      }
      await this.initAudio();
      if (!(await this.tryLoad(item.resourcePath))) {
        await this.modal_.toast("无法打开！");
        return;
      }
      this.currentRom = item;
      this.selectedRom = item;
      this.recents = this.recents.filter(
        (r) => r.resourcePath !== item.resourcePath
      );
      this.recents.unshift(item);
      if (this.recents.length > MAX_RECENTS_COUNT) {
        this.recents.pop();
      }
      this.recents = [...this.recents];
      await this.saveRecents();
      await this.play();
    }

    updateSelectedPage(page) {
      const totalPage = Math.ceil(this.roms.length / ROMS_PAGE_SIZE);
      page = Math.min(totalPage - 1, page);
      page = Math.max(0, page);
      this.selectedRoms = this.roms.slice(
        page * ROMS_PAGE_SIZE,
        (page + 1) * ROMS_PAGE_SIZE
      );
      this.selectedRom = this.selectedRoms[0];
      this.selectedPage = page;
    }

    async start() {
      /** @type { { toast:(msg:string, timeout:number = 1000)=>Promise<any> } } */
      this.modal_ = this.components.modal.model;
      if (this.data.ROMS_ROOT) {
        this.roms = await getChildren(this.data.ROMS_ROOT);
      }
      if (!this.roms || !this.roms.length) {
        this.roms = this.data.roms || [];
      }
      this.selectedPage = 0;
      this.updateSelectedPage(0);
      const recents = await this.loadRecents();
      this.recents = recents
        .map((r) => this.roms.find((s) => s.resourcePath === r.resourcePath))
        .filter((r) => r);
      this.directions = ["left", "up", "right", "down"];
      this.functions = ["select", "start", "a", "b", "a_b"];
      this.isHost = false;
      this.isClient = false;
      /** @type Set<string> */
      this.currentButtons = new Set();
      await this.initNes();
    }
  }
</script>
<template id="app-main" view-model="App">
  <div>
    <div id="app" class-ishost.="isHost || gamepad" class-isclient.="isClient">
      <div class="image-bg">
        <img if.="imageBg" src$.="imageBg" />
      </div>
      <div id="head" class="space">
        <div class="roms">
          <div if.="recents && recents.length" class="title">最近</div>
          <div for.="rom of recents">
            <div class-current.="rom === currentRom" class-selected.="rom === selectedRom" onclick.="loadRom(rom)"
              inner-text$.="' - ' + rom.name"></div>
          </div>
          <div class="title">全部</div>
          <div for.="rom of selectedRoms">
            <div class-current.="rom === currentRom" class-selected.="rom === selectedRom" onclick.="loadRom(rom)"
              inner-text$.="' - ' + rom.name"></div>
          </div>
        </div>
        <div class="space"></div>
        <div class="space"></div>
        <div class="controls">
          <div class="directions" onpointermove.="directionsMove($event)" onpointerdown.="directionsDown($event)"
            onpointerup.="directionsUp($event)" onpointerleave.="directionsUp($event)"
            onpointercancel.="directionsUp($event)">
            <div for.="dir of directions">
              <div class.="'btn btn_' + dir" class-pressed.="currentButtons.has(dir)">
                <div></div>
              </div>
            </div>
          </div>
          <div class="functions">
            <div for.="dir of functions">
              <div class.="'btn btn_' + dir" onpointerdown.="onkey(dir, true)" onpointerup.="onkey(dir)"
                onpointerleave.="onkey(dir)" onpointercancel.="onkey(dir)">
                <div></div>
              </div>
            </div>
          </div>
        </div>
        <div class="space"></div>
      </div>
      <div id="body">
        <div id="left" class="space"></div>
        <div id="app-content">
          <canvas id="canvas" style="width: 100%" />
        </div>
        <div id="right" class="space"></div>
      </div>
      <div id="foot" class="space">
        <div class="remotes">
          <div id="isHost" class-hidden.="isClient" onclick.="toogleIsHost()">
            <span inner-text$.="isHost ? '关闭':'主机'"></span>
          </div>
          <div id="isClient" class-hidden.="isHost || (isClient && remotePlayer !== 1)" onclick.="toogleIsClient(1)">
            <span inner-text$.="isClient ? '关闭':'手柄1'"></span>
          </div>
          <div id="isClient" class-hidden.="isHost || (isClient && remotePlayer !== 2)" onclick.="toogleIsClient(2)">
            <span inner-text$.="isClient ? '关闭':'手柄2'"></span>
          </div>
        </div>
        <div class="space"></div>
        <div class="controls">
          <div class="directions" onpointermove.="directionsMove($event)" onpointerdown.="directionsDown($event)"
            onpointerup.="directionsUp($event)" onpointerleave.="directionsUp($event)"
            onpointercancel.="directionsUp($event)">
            <div for.="dir of directions">
              <div class.="'btn btn_' + dir" class-pressed.="currentButtons.has(dir)">
                <div></div>
              </div>
            </div>
          </div>
          <div class="functions">
            <div for.="dir of functions">
              <div class.="'btn btn_' + dir" onpointerdown.="onkey(dir, true)" onpointerup.="onkey(dir)"
                onpointerleave.="onkey(dir)" onpointercancel.="onkey(dir)">
                <div></div>
              </div>
            </div>
          </div>
        </div>
        <div class="space"></div>
        <div class="space"></div>
      </div>
    </div>
    <modal-panel id="modal"></modal-panel>
  </div>
  <style>
    :host {
      display: block;
      --app-menu-bg: cadetblue;
      --app-menu-fg: white;
      --app-bg: black;
    }

    #app {
      flex-direction: column;
      height: 100%;
    }

    #app,
    #body {
      display: flex;
    }

    #head,
    #foot,
    #left,
    #right,
    .space {
      flex: 1;
    }

    #head,
    #foot {
      display: flex;
      align-items: center;
      flex-direction: column;
    }

    .hidden {
      display: none !important;
    }

    .image-bg {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      z-index: -1;
      background: var(--app-bg);
    }

    .image-bg>img {
      filter: blur(20px);
      width: 100%;
      height: 100%;
    }

    #app-content {
      display: flex;
      flex-direction: column;
      justify-content: space-around;
      width: 100vw;
      height: 100vw;
      max-height: 100vh;
    }

    .controls,
    .directions,
    .functions,
    .btn,
    canvas,
    .space,
    * {
      user-select: none !important;
      -webkit-user-select: none !important;
    }

    .controls {
      display: flex;
      width: 100%;
      justify-content: space-around;
      padding-right: 15px;
    }

    .directions,
    .functions {
      --width: 34%;
      --height: 26%;
      --rx: 50%;
      --ry: 5px;
      position: relative;
      width: 160px;
      height: 160px;
    }

    .functions {}

    .btn {
      position: absolute;
      background: var(--app-menu-bg);
      filter: drop-shadow(1px 1px 1px white);
    }

    .directions .btn {
      display: flex;
      justify-content: center;
      align-items: center;
    }

    .directions .btn div {
      width: 40%;
      height: 40%;
      border-radius: 25%;
      background: #fff9;
    }

    .directions .btn.pressed div {
      background: #fff;
    }

    .btn.pressed,
    .btn:hover {
      filter: drop-shadow(0px 0px 1px gray);
    }

    .btn_left {
      width: var(--width);
      height: var(--height);
      left: 0;
      top: calc(50% - var(--height) / 2);
      border-radius: var(--rx) var(--ry) var(--ry) var(--rx);
    }

    .btn_up {
      height: var(--width);
      width: var(--height);
      top: 0;
      left: calc(50% - var(--height) / 2);
      border-radius: var(--rx) var(--rx) var(--ry) var(--ry);
    }

    .btn_right {
      width: var(--width);
      height: var(--height);
      right: 0;
      top: calc(50% - var(--height) / 2);
      border-radius: var(--ry) var(--rx) var(--rx) var(--ry);
    }

    .btn_down {
      height: var(--width);
      width: var(--height);
      bottom: 0;
      left: calc(50% - var(--height) / 2);
      border-radius: var(--ry) var(--ry) var(--rx) var(--rx);
    }

    .functions .btn {
      width: var(--height);
      height: var(--height);
      border-radius: 100% !important;
    }

    .btn_select,
    .btn_start {
      background: gray;
    }

    .btn_select {
      left: calc(var(--height) / 2);
      bottom: calc(50% + var(--height) / 2);
    }

    .btn_start {
      left: calc(var(--height) / 2);
      top: calc(50% + var(--height) / 2);
    }

    .btn_a,
    .btn_b {
      width: var(--width) !important;
    }

    .btn_a {
      right: 0;
      bottom: calc(50% + var(--height) * 2 / 3);
      background: chocolate;
    }

    .btn_a_b {
      top: 50%;
      left: 50%;
      transform: translate(-25%, -50%);
      background: steelblue;
    }

    .btn_b {
      right: 0;
      top: calc(50% + var(--height) * 2 / 3);
      background: blueviolet;
    }

    #head .directions,
    #head .functions {
      display: none;
    }

    .roms {
      max-height: 12em;
      overflow-x: auto;
      /* border: 1px solid #2d2d2d; */
      /* background: #3d3d3d; */
      color: #ccc;
      width: 100%;
    }

    .roms>* {
      margin: 0 20px;
      /* font-size: larger; */
      padding: 2px 5px;
      display: block;
    }

    .roms>.title {
      font-size: large;
      text-align: center;
      font-weight: bold;
    }

    .selected {
      background: #888;
      color: #3d3d3d;
    }

    .current {
      background: #ccc;
      color: #3d3d3d;
    }

    .remotes {
      display: none;
      position: fixed;
      top: 0;
      right: 0;
    }

    .remotes>div {
      border-radius: 10px;
      padding: 5px;
      margin: 10px;
      background: gray;
      filter: drop-shadow(1px 1px 3px white);
    }

    @media (orientation: landscape) {
      #app {
        flex-direction: row;
      }

      #body {
        flex-direction: column;
      }

      #app-content {
        width: 100vh;
        height: 100vh;
        max-width: 100vw;
      }

      #head,
      #foot {
        flex-direction: row;
      }

      .roms {
        display: none;
      }

      #foot .directions {
        display: none;
      }

      #head .directions {
        display: block;
      }

      .controls {
        padding-top: 100%;
        padding-right: unset;
      }

      .remotes {
        display: block;
      }
    }

    .isclient #app-content {
      display: none;
    }

    .ishost .controls {
      display: none;
    }

    .ishost .roms {
      display: block;
      max-height: 100vh;
    }

    .isclient .directions,
    .isclient .functions {
      width: 200px;
      height: 200px;
    }

    .isclient .controls {
      padding-top: 40%;
    }

    .isclient #head .controls {
      justify-content: flex-start;
      padding-left: 10px;
    }

    .isclient #foot .controls {
      justify-content: flex-end;
      padding-right: 10px;
    }
  </style>
</template>
<style>
  body {
    background: black;
    touch-action: none;
    color: #ccc;
  }
</style>
<script>
  window.appData = window.appData || {
    ROMS_ROOT: "http://192.168.3.100/A.%E5%BA%94%E7%94%A8/.nes/",
    serverUrl: "ws://192.168.3.100:9999",
  };
</script>

<meta name="viewport" content="width=device-width, maximum-scale=1.0,user-scalable=no, initial-scale=1" />
<meta name="apple-mobile-web-app-capable" content="yes" />
<meta name="apple-mobile-web-app-status-bar-style" content="transparent" />
<script>
  const {
    registerElement,
    registerProperties,
    evalInContext,
    delayDispatcher,
  } = (() => {
    const evalInContext = (exp, context) => {
      return function () {
        with (this) {
          try {
            return eval(`(${exp})`);
          } catch (e) {
            console.log(exp);
            console.log(e);
            return;
          }
        }
      }.call(context);
    };

    const removeItem = (item) => {
      const clearItem = (/**@type {HTMLElement}*/ item) => {
        for (let c of item.childNodes) {
          clearItem(c);
        }
        let onRemoves = item.onRemoves;
        item.onRemoves = undefined;
        if (onRemoves?.length) {
          onRemoves.forEach((onRemove) => onRemove());
        }
      };
      clearItem(item);
      item.remove();
    };

    const onprop = (parent, /**@type {String} */ exp, context, listener) => {
      const tokens = exp.split(/\.|\?\.|\[|\]/);
      if (!tokens[1]) {
        if (context.tmpCtxName === tokens[0]) {
        } else {
          context.on && context.on(tokens[0], listener, true, parent);
          parent.onRemoves = [
            ...(parent.onRemoves || []),
            () => {
              context.off(tokens[0], listener, true);
            },
          ];
        }
        return;
      }
      if (context.tmpCtxName === tokens[0]) {
        context = context[context.tmpCtxName];
        tokens.shift();
      }
      const clearBind = (current) => {
        while (current) {
          if (current.off) {
            current.off();
          }
          const next = current.next;
          current.next = undefined;
          current = next;
        }
      };
      const register = (tokens, handler, context, offChain) => {
        const prop = tokens[0];
        if (!prop || !context) {
          return;
        }
        offChain.next = {};
        const registerNext = () => {
          register(tokens.slice(1), handler, context[prop], offChain.next);
        };
        if (context.on && context.on instanceof Function) {
          const listener = (...args) => {
            clearBind(offChain.next);
            offChain.next = {};
            registerNext();
            handler(...args);
          };
          context.on(prop, listener, true, parent);
          offChain.off = () => {
            context.off(prop, listener, true);
          };
        }
        registerNext();
      };
      const offChain = {};
      register(tokens, listener, context, offChain);
      parent.onRemoves = [
        ...(parent.onRemoves || []),
        () => {
          clearBind(offChain);
        },
      ];
    };

    const bindingForInstruction = (/**@type HTMLElement */ element) => {
      let forExp = element.getAttribute("for.");
      const match = forExp.match(
        /^\s*(((let|const|of)\s+)?(\w+)\s+(of|in)\s+)?\s*(.+)\s*$/
      );
      if (!match || !match[6]) {
        throw new Error("Invalid for Expression");
      }
      const collectionName = match[6];
      const of_in = match[5] || "of";
      let varName = match[4];
      let forHead;
      if (varName) {
        forHead = `for(const ${varName} ${of_in} ${collectionName})`;
      } else {
        varName = "$$i";
        forHead = `for(const ${varName} of ${collectionName})`;
      }
      const comment = document.createComment(element.outerHTML);
      const parent = element.parentElement;
      parent.insertBefore(comment, element);
      element.remove();
      /**@type Map<any, HTMLElement> */
      let items = new Map();
      /**@type Map<any, HTMLElement> */
      let newItems = new Map();
      let idx = 0;
      let allRemoved = false;
      const update = () => {
        (function ($$forEach) {
          newItems = new Map();
          idx = 0;
          allRemoved = false;
          with (this) {
            eval(`
          let collection
          try{
            collection = this.${collectionName}
          }
          catch{
            //ignore
          }
          if (collection) {
            ${forHead}{
              $$forEach(${varName})
              }
          }`);
          }
          for (const [_, { item }] of items) {
            removeItem(item);
          }
          items = newItems;
        }.call(element.context, ($$i) => {
          /**@type HTMLElement */
          let item;
          if (items.has($$i)) {
            const pair = items.get($$i);
            item = pair.item;
            if (!allRemoved && idx !== pair.idx) {
              console.log("removed");
              for (const [_, { item }] of items) {
                removeItem(item);
              }
              allRemoved = true;
            }
            items.delete($$i);
          } else {
            item = element.cloneNode(true);
            item.removeAttribute("id");
            item.removeAttribute("for.");
            if (item.updateModel) {
              item.model = $$i;
            } else {
              item.modelBeforeInit = $$i;
            }
            const context = Object.create(element.context);
            context[varName] = $$i;
            context.tmpCtxName = varName;
            item.context = context;
          }
          parent.insertBefore(item, comment);
          newItems.set($$i, { idx, item });
          binding(item);
          idx++;
        }));
      };
      update();
      let lastContext = element.context;
      comment.updateWhenModelChange = () => {
        if (lastContext === element.context) {
          return;
        }
        lastContext = element.context;
        update();
      };
      onprop(parent, collectionName, element.context, update);
      return {};
    };

    const bindingIfInstruction = (
        /**@type HTMLElement */ element,
      keyChangeRemove
    ) => {
      let ifExp = element.getAttribute("if.");
      const comment = document.createComment(element.outerHTML);
      const parent = element.parentElement;
      parent.insertBefore(comment, element);
      element.remove();
      let item;
      let lastValue;
      const update = () => {
        const value = evalInContext(ifExp, element.context);
        if (keyChangeRemove && value !== lastValue && item) {
          removeItem(item);
          item = undefined;
        }
        if (value) {
          if (item) {
            return;
          }
          item = element.cloneNode(true);
          item.removeAttribute("if.");
          item.removeAttribute("keyif.");
          parent.insertBefore(item, comment);
          item.context = element.context;
          binding(item);
        } else if (item) {
          removeItem(item);
          item = null;
        }
      };
      update();
      let lastContext = element.context;
      comment.updateWhenModelChange = () => {
        if (lastContext === element.context) {
          return;
        }
        lastContext = element.context;
        update();
      };
      for (const exp of getPropsFromExp(ifExp)) {
        onprop(parent, exp, element.context, update);
      }
      return {};
    };

    const getPropNameFromBindingAttr = (attr) => {
      return attr.replace(/-(\w)/g, (_, c) => c.toUpperCase());
    };

    const getPropsFromExp = (exp) => {
      return exp.match(/([a-zA-Z0-9_$.\[\]]|\?\.)+/g) || [];
      // return exp.match(/[a-zA-Z0-9_$.]+/g) || []
    };

    const bindingAttrs = (/**@type HTMLElement */ element) => {
      if (element.hasAttribute("for.")) {
        return bindingForInstruction(element);
      }
      if (element.hasAttribute("if.")) {
        return bindingIfInstruction(element, element.hasAttribute("keyif."));
      }
      if (element.updateWhenModelChange) {
        element.updateWhenModelChange();
        return element;
      }
      const bindingAttrs = element
        .getAttributeNames()
        .filter((p) => p.endsWith("."));
      for (const prop of bindingAttrs) {
        const $$exp = element.getAttribute(prop);
        const effectedAttr = prop
          .slice(0, -".".length)
          .split(",")
          .map((a) => a.trim())
          .filter((a) => a);

        if (effectedAttr.some((a) => a.startsWith("on"))) {
          const value = `(function($event){with(this){${$$exp}}}).call(event.target.context, event)`;
          for (const ea of effectedAttr) {
            if (ea.endsWith("$")) {
              element.setAttribute(
                ea.slice(0, -1),
                "event.stopPropagation();" + value
              );
            } else {
              element.setAttribute(ea, value);
            }
          }
          continue;
        }
        const update = () => {
          const value = evalInContext($$exp, element.context);
          for (const ea of effectedAttr) {
            if (ea === "model") {
              if (element.updateModel) {
                element.updateModel(value);
              } else {
                element.modelBeforeInit = value;
              }
              continue;
            }
            if (ea === "focus") {
              if (value) {
                if (element.scrollIntoViewIfNeeded) {
                  element.scrollIntoViewIfNeeded();
                } else {
                  element.scrollIntoView();
                }
                element.focus();
              }
              continue;
            }
            if (ea === "scrollintoview") {
              if (value) {
                if (element.scrollIntoViewIfNeeded) {
                  element.scrollIntoViewIfNeeded();
                } else {
                  element.scrollIntoView();
                }
              }
              continue;
            }
            if (ea.startsWith("class-")) {
              const className = ea.slice("class-".length);
              if (value) {
                element.classList.add(className);
              } else {
                element.classList.remove(className);
              }
              continue;
            } else if (ea.startsWith("style-")) {
              const prop = ea.slice("style-".length, -1);
              element.style.setProperty(prop, value);
              continue;
            }
            if (ea.endsWith("$")) {
              let prop = getPropNameFromBindingAttr(ea.slice(0, -1));
              switch (prop) {
                case "innerHtml":
                  prop = "innerHTML";
                  break;
              }
              element[prop] = value;
              continue;
            }
            if (value === undefined || value === null) {
              element.removeAttribute(ea);
            } else if (element[ea] !== value) {
              element.setAttribute(ea, value);
            }
          }
        };
        update();
        for (const exp of getPropsFromExp($$exp)) {
          onprop(element.parentElement, exp, element.context, update);
        }
      }
      return element;
    };

    const binding = (/**@type HTMLElement */ element) => {
      /**@type { Object.<string,HTMLElement> } */
      const components = element.context.components;
      if (element.hasAttribute) {
        const handler = bindingAttrs(element);
        //collect ids
        if (element.hasAttribute("id")) {
          components[element.getAttribute("id")] = handler;
        }
        if (handler !== element) {
          return;
        }
      }
      for (const child of [...element.children]) {
        if (
          child.context == element.context ||
          (child.context &&
            Object.getPrototypeOf(child.context) === element.context)
        ) {
        } else {
          child.context = element.context;
        }
        binding(child);
      }
    };

    const getNameFromTagName = (tagName) => {
      return tagName.replace(/(?:^|-)(\w)/g, (_, c) => c.toUpperCase());
    };

    class DelayDispatcher {
      constructor(delay = 50) {
        this.delay = delay;
        this.currentTask;
        this.running = false;
        this.lastDispatchTime = 0;
        this.groups = new Map();
        this.count = 0;
        // this.delayListeners = new Map()
      }

      set(obj, key, method) {
        let group = this.groups.get(obj);
        if (!group) {
          group = {};
          this.groups.set(obj, group);
        }
        group[key] = method;
      }

      async start() {
        if (this.running) {
          return;
        }
        this.running = true;
        this.currentTask = new Promise(async (resolve) => {
          while (this.running) {
            let now = Date.now();
            let remain = this.delay - (now - this.lastDispatchTime);
            if (remain > 0) {
              await new Promise((r) => setTimeout(r, remain));
            }
            let groups = this.groups;
            await new Promise((resolve) =>
              window.requestAnimationFrame(async () => {
                this.groups = new Map();
                for (let [obj, group] of groups) {
                  if (!obj || !group) {
                    continue;
                  }
                  for (let p in group) {
                    try {
                      group[p]?.();
                    } catch (e) {
                      console.log(e);
                    }
                  }
                }
                resolve();
              })
            );
          }
          this.lastDispatchTime = Date.now();
          this.currentTask = undefined;
          this.running = false;
          resolve();
        });
        await this.currentTask;
      }

      async stop() {
        this.running = false;
        await this.currentTask;
      }

      setDelay(delay) {
        this.delay = delay;
      }
    }

    const delayDispatcher = new DelayDispatcher();

    const registerProperties = (obj, ...props) => {
      const backup = {};
      if (!obj.define) {
        addPropChange(obj);
      }
      props.forEach((prop) => {
        const desc = Object.getOwnPropertyDescriptor(obj, prop);
        if (desc && !desc.configurable) {
          delete backup[prop];
          return;
        }
        let propValue;
        let [propName, handler] =
          prop instanceof Array ? prop : [prop, undefined];
        if (obj[propName] !== undefined) {
          backup[propName] = obj[propName];
        }
        Object.defineProperty(obj, propName, {
          get() {
            return propValue;
          },
          set(newValue) {
            if (propValue === newValue) {
              return;
            }
            const oldValue = propValue;
            propValue = newValue;
            obj.raise(propName, newValue, oldValue);
            handler?.(newValue, oldValue);
            delayDispatcher.set(obj, propName, () => {
              obj.raise(propName, newValue, oldValue, true);
            });
          },
        });
      });
      Object.assign(obj, backup);
      return obj;
    };

    const registerAllProperties = (obj) => {
      return registerProperties(obj, ...Object.keys(obj));
    };

    Object.defineProperty(Object.prototype, "registerProperties", {
      value: function (...props) {
        return registerProperties(this, ...props);
      },
    });

    Object.defineProperty(Object.prototype, "registerAllProperties", {
      value: function () {
        return registerAllProperties(this);
      },
    });

    delayDispatcher;

    const addPropChange = (/**@type { Object } */ obj) => {
      /**@type Map<string, Set<{(newValue, oldValue):any}>> */
      const atonceListeners = new Map();
      const delayListeners = new Map();
      const thisProp = "this";
      Object.defineProperty(obj, thisProp, {
        get() {
          return obj;
        },
      });
      Object.defineProperty(obj, "define", {
        value: (...props) => registerProperties(obj, ...props),
      });
      Object.defineProperty(obj, "on", {
        value: (
            /**@type string */ prop,
          listener,
          delay = false,
          additional
        ) => {
          let l = delay ? delayListeners : atonceListeners;
          if (!l.has(prop)) {
            l.set(prop, new Map());
          }
          l.get(prop).set(listener, additional);
          if (delay && delayDispatcher?.delayListeners) {
            delayDispatcher.delayListeners.set(listener, additional);
          }
          delayDispatcher.count++;
        },
      });

      Object.defineProperty(obj, "off", {
        value: (prop, listener, delay = false) => {
          let l = delay ? delayListeners : atonceListeners;
          if (!l.has(prop)) {
            return;
          }
          l.get(prop).delete(listener);
          if (delay && delayDispatcher?.delayListeners) {
            delayDispatcher.delayListeners.delete(listener);
          }
          delayDispatcher.count--;
        },
      });

      Object.defineProperty(obj, "clearOn", {
        value: (delay) => {
          let l = delay ? delayListeners : atonceListeners;
          delayDispatcher.count -= l.size;
          if (delay && delayDispatcher?.delayListeners) {
            l.forEach((_, listener) => {
              delayDispatcher.delayListeners.delete(listener);
            });
          }
          l.clear();
          // for (let p in obj) {
          //   obj[p].clearOn?.(delay)
          // }
        },
      });
      Object.defineProperty(obj, "dispose", {
        value: () => {
          obj.clearOn(false);
          obj.clearOn(true);
        },
      });
      Object.defineProperty(obj, "hasOn", {
        value: (prop, delay = false) => {
          let l = delay ? delayListeners : atonceListeners;
          return l.has(prop);
        },
      });

      Object.defineProperty(obj, "raise", {
        value: (prop, newValue, oldValue, delay = false) => {
          if (prop !== thisProp) {
            obj.raise(thisProp, obj, obj, delay);
          }
          let l = delay ? delayListeners : atonceListeners;
          if (!l.has(prop)) {
            return;
          }
          for (const [listener, _] of l.get(prop)) {
            listener(newValue, oldValue);
          }
        },
      });
    };

    const registerElement = (tagName, /**@type { string } */ constructor) => {
      const elementClassName = `HTML${constructor || getNameFromTagName(tagName)
        }Element`;
      constructor = constructor || "Object";
      eval(`
    class ${elementClassName} extends HTMLElement{
      constructor(){
        super()
        const shadow = this.attachShadow({mode:'open'})
        const template = document.getElementById('${tagName}')
        if(!template || template.tagName !== 'TEMPLATE' ){
          throw new Error('Define Template')
        }
        this.template_ = template
        this.shadow_ = shadow
        this.model_ = new ${constructor}()
        this.model_.components = { host: this.shadow_ }
        if(this.context && this.hasAttribute('model.')){
          const modeExp = this.getAttribute('model.')
          this.model = evalInContext(modeExp, this.context)
        }else if(this.modelBeforeInit){
          this.model = this.modelBeforeInit
        }else{
          this.model =  {}
        }
      }

      rebuildView(){
        this.shadow_.innerHTML = ''
        const instance = document.importNode(this.template_.content, true)
        this.shadow_.appendChild(instance)
      }
  
      get model(){
        return this.model_
      }
  
      set model(value){
        if(value?.on){
          this.model_ = value || {}
          this.model_.components = { host: this.shadow_ , ...this.model_.components||{}}
        }else{
          //combine code behind with model
          Object.assign(this.model_, value)
        }
        this.shadow_.context = this.model_ 
        this.rebuildView()
      }
  
      updateModel(value){
        this.model = value
        this.connectedCallback()
      }
      
      connectedCallback(){
        binding(this.shadow_)
        if(this.model_.launch){
          this.model_.launch()
        } 
      }
    }
    customElements.define('${tagName}', ${elementClassName})
    `);
    };
    return {
      registerElement,
      registerProperties,
      evalInContext,
      delayDispatcher,
    };
  })();

  const sleep = (timeout) =>
    new Promise((resolve) => setTimeout(resolve, timeout));

  class AppBase {
    async launch() {
      if (this.launched) {
        return;
      }
      this.launched = true;
      this.storage = this.initStorage_();
      this.data = await this.initData(window.appData);
      window.app = this;
      await this.start();
    }

    async registerStorageProperties(...props) {
      if (!this.storage) {
        return;
      }
      let asyncTimeout = 50;
      const bgTimeout = 200;
      for (const [prop, defaultValue, onchange] of props) {
        let propValue;
        let valueModified = false;
        let successLoadFromStorage = false;
        let loadFunc;
        let bgLoad = false;
        const mergeValue = (savedValue) => {
          if (successLoadFromStorage) {
            return;
          }
          successLoadFromStorage = true;
          if (!valueModified) {
            valueModified = true;
            propValue = savedValue;
          } else {
            // merge strategy
            propValue = savedValue;
          }
          if (bgLoad && onchange) {
            onchange();
          }
        };
        loadFunc = async () => {
          const jsonStr = await this.storage.getItem(prop);
          let savedValue;
          if (!jsonStr) {
            savedValue = defaultValue;
          } else {
            try {
              savedValue = JSON.parse(jsonStr);
            } catch {
              savedValue = defaultValue;
            }
          }
          mergeValue(savedValue);
        };
        const tryLoad = async () => {
          bgLoad = true;
          const func = loadFunc;
          loadFunc = null;
          await Promise.race([
            func(),
            sleep(bgTimeout).then(() => {
              if (!successLoadFromStorage) {
                loadFunc = func;
              }
            }),
          ]);
        };
        await Promise.race([
          loadFunc(),
          sleep(asyncTimeout).then(() => {
            if (!valueModified) {
              propValue = defaultValue;
              valueModified = true;
              asyncTimeout = 0;
            }
          }),
        ]);
        Object.defineProperty(this, prop, {
          get() {
            if (loadFunc) {
              tryLoad();
            }
            return propValue;
          },
          set(newValue) {
            propValue = newValue;
            if (successLoadFromStorage) {
              this.storage.setItem(prop, JSON.stringify(propValue));
            }
          },
        });
      }
    }

    initStorage_() {
      if (window.$localStorage) {
        return window.$localStorage;
      }
      try {
        const s = window.localStorage;
        return s;
      } catch {
        return {
          getItem: () => "",
          setItem: () => true,
        };
      }
    }

    async initData(data) {
      return data;
    }

    async start() {
      console.log("start");
    }

    async pause() {
      console.log("pause");
    }

    async resume() {
      console.log("pause");
    }

    async stop() {
      console.log("stop");
    }
  }

  window.onload = async () => {
    let currentClass = App;
    while (true) {
      let baseClass = Object.getPrototypeOf(currentClass);
      if (
        !baseClass ||
        Object.getPrototypeOf(Object) === Object.getPrototypeOf(currentClass)
      ) {
        break;
      }
      currentClass = baseClass;
    }
    Object.setPrototypeOf(currentClass.prototype, AppBase.prototype);
    for (const template of document.querySelectorAll(
      "template[id][view-model]"
    )) {
      const tagName = template.getAttribute("id");
      if (!tagName) {
        continue;
      }
      const codeBehind = template.getAttribute("view-model");
      registerElement(tagName, codeBehind);
    }
    delayDispatcher.start();
  };
</script>

<style>
  html,
  body {
    height: 100%;
    margin: 0;
  }
</style>

<body>
  <app-main></app-main>

  <template id="h-stack" view-model>
    <slot></slot>
    <style>
      :host {
        display: flex;
        flex-direction: row;
      }
    </style>
  </template>
  <template id="v-stack" view-model>
    <slot></slot>
    <style>
      :host {
        display: flex;
        flex-direction: column;
      }
    </style>
  </template>
  <template id="hv-stack" view-model>
    <slot></slot>
    <style>
      :host {
        display: flex;
        flex-direction: column;
      }

      @media (orientation: landscape) {
        :host {
          flex-direction: row;
        }
      }
    </style>
  </template>

  <template id="vh-stack" view-model>
    <slot></slot>
    <style>
      :host {
        display: flex;
        flex-direction: row;
      }

      @media (orientation: landscape) {
        :host {
          flex-direction: column;
        }
      }
    </style>
  </template>

  <template id="h-square" view-model>
    <slot></slot>
    <style>
      :host {
        width: 100vw;
        height: 100vw;
      }

      @media (orientation: landscape) {
        :host {
          width: 100vh;
          height: 100vh;
        }
      }
    </style>
  </template>

  <template id="h-spacer" view-model>
    <slot></slot>
    <style>
      :host {
        flex: 1;
        display: flex;
      }
    </style>
  </template>

  <template id="h-text" view-model>
    <span inner-text$.="content"></span>
    <style>
      :host {
        flex: 1;
        display: flex;
        align-items: center;
        place-content: center;
      }
    </style>
  </template>

  <template id="play-button" view-model>
    <span id="btnPlay" class="play-button" class-pause.="isPlaying"></span>
    <style>
      :host {
        display: block;
        border-radius: 5px;
        padding: 3px 10px;
        background-color: #fff4;
      }

      .play-button {
        display: block;
        width: 100%;
        height: 100%;
        background-color: var(--color);
        clip-path: polygon(25% 10%, 25% 90%, 95% 50%, 25% 10%);
        transition: 200ms all ease-in-out;
      }

      .play-button.pause {
        clip-path: polygon(60% 50%,
            20% 20%,
            20% 80%,
            60% 50%,
            60% 80%,
            80% 80%,
            80% 20%,
            60% 20%);
      }
    </style>
  </template>

  <template id="menu-bar" view-model>
    <h-stack>
      <div class-hidden.="!item.show" class="menu-item" for.="item of menus">
        <span inner-text$.="item.name" onclick.="item.onclick()"></span>
      </div>
    </h-stack>
    <style>
      :host {
        display: block;
      }

      h-stack {
        overflow: hidden;
      }

      .menu-item {
        margin: 5px;
        background-color: var(--menu-background-color);
        border-radius: 4px;
        padding: 2px 5px;
        color: var(--menu-color);
        display: flex;
        justify-content: center;
        flex: 1;
      }

      .menu-item>span {
        display: block;
        text-overflow: ellipsis;
        white-space: pre;
        overflow: hidden;
        max-width: 6em;
      }

      .hidden {
        display: none;
      }
    </style>
  </template>

  <script>
    class MenuItem {
      constructor(name = "", onclick = null, show = true) {
        registerProperties(this, "name", "show");
        this.name = name;
        this.show = show;
        this.onclick = onclick;
      }
    }
  </script>

  <template id="modal-panel" view-model="Modal">
    <div>
      <span class="toastMessage" if.="toastMessage" inner-text$.="toastMessage"></span>
      <div if.="open" class="modal-wraper" onclick.="close()">
        <div class="modal" onclick="event.stopPropagation()">
          <div class="title">
            <span inner-text$.="title"></span>
          </div>
          <div class="body">
            <div if.="items?.length">
              <div class="item" for.="item of items" class-highlight.="item === selectedItem" onclick.="close(item)">
                <span inner-text$.="options.itemName?item[options.itemName]:item"></span>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
    <style>
      .hidden {
        /* left: -100%; */
        /* transition: ease-in-out 0.05s left; */
        display: none;
      }

      .toastMessage {
        color: var(--toast-color, #eee);
        background-color: var(--toast-background-color, #0008);
        position: fixed;
        bottom: 0;
        margin: 20px auto;
        left: 50%;
        transform: translate(-50%, 0);
        padding: 5px 20px;
        border-radius: 4px;
        text-align: center;
        backdrop-filter: blur(5px);
      }

      .modal-wraper {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        display: flex;
        align-items: center;
        justify-content: center;
      }

      .modal {
        background: #fff;
        border-radius: 10px;
        padding: 10px;
        width: 90%;
        max-height: 90%;
        box-shadow: 3px 3px 5px;
      }

      .modal .title {
        font-size: large;
        margin: 5px 0;
        font-weight: bold;
      }

      .modal .body {
        margin: 5px 0;
      }

      .modal .foot {
        margin: 5px 0;
      }

      .item {
        margin: 8px 0;
        background: #0002;
        padding: 5px;
        border-radius: 8px;
      }

      .item.highlight {
        background: #0008;
        color: white;
      }
    </style>
  </template>
  <script>
    class Modal {
      constructor() {
        /**@type { Object.<string,HTMLElement> } */
        this.components;
        /**@type { Storage | {  } } */
        this.storage;
        registerProperties(
          this,
          "toastMessage",
          "title",
          "items",
          "selectedItem",
          "open",
          "options"
        );
      }
      toast(/**@string */ msg, /**@type number */ timeout = 1000, task) {
        return new Promise(async (resolve) => {
          this.toastMessage = msg;
          await task;
          setTimeout(() => {
            this.toastMessage = null;
            resolve();
          }, timeout);
        });
      }

      close(result) {
        if (!this.resolveTask) {
          return;
        }
        if (this.options.requilred && !result) {
          return;
        }
        this.open = undefined;
        this.resolveTask.resolve(result);
      }

      select(
          /** @type string */ msg,
          /** @type [any] */ values = [],
        defaultIdx = 0,
        opt = undefined
      ) {
        if (this.resolveTask) {
          const { resolve, reject } = this.resolveTask;
          this.resolveTask = undefined;
          reject();
        }
        this.title = msg;
        this.items = values;
        this.selectedItem = values[defaultIdx];
        this.options = opt || {};
        this.open = true;
        return new Promise(
          (resolve, reject) => (this.resolveTask = { resolve, reject })
        );
      }
    }
  </script>
  <template id="pop-up" view-model="Popup">
    <div class="popup">
      <slot></slot>
    </div>
    <style>
      :host {
        display: block;
        position: relative;
        left: 0;
        top: 0;
        bottom: 0;
        right: 0;
        position: fixed;
        background: #0008;
        backdrop-filter: blur(5px);
      }

      .popup {
        max-width: 99%;
        max-height: 99%;
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
      }
    </style>
  </template>
  <script>
    class Popup { }
  </script>
</body>

</html>